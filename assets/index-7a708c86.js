import{j as c,a as g,F as tt}from"./index-e8b020c1.js";import{ae as at,M as et,D as K,P as st,F as nt,j as L,I as rt,e as ot,Z as ct,r as M,O as it,x as O,y as N,a5 as dt,a8 as mt}from"./elements-7fcf5525.js";import{m as l,k as S,g as w,h as C,p as T,r as h,q as b,s as p,o as lt,u as ut}from"./app-fc3be005.js";import{b as pt,u as ht,c as yt,a as ft,S as At}from"./scroll-to-bottom-fab-efb6dcd3.js";import{a as F,R as $}from"./routes-4ccd8c9c.js";import{A as I,U as P}from"./axios-7a17aed4.js";import{A as E}from"./index-f4612fa3.js";import{Q as R}from"./queries-keys-1e9a6485.js";import{u as gt,a as St}from"./get-single-applicant-1b0a3dea.js";import{P as wt}from"./page-layout-787fd5b1.js";import{e as v,g as f,A as G}from"./summary-page.helpers-1c1a9467.js";import"./department-mapping-99823d46.js";import"./index-c5c95794.js";import"./with-plugins-2b39eb23.js";import"./isBetween-bb99a4b7.js";import"./isSameOrAfter-571fd34c.js";import"./options-21b6589e.js";import"./object-manipulation-71eb9c9f.js";import"./rooms-naming-0ec8ee01.js";const Ct=async(s,e)=>{var o;try{const t={officeIds:[e.loginIdentity.officeId],negotiatorIds:[e.loginIdentity.userCode]},r=l.merge(s,t),{headers:n}=await I.post(P.APPLICANTS,r,{headers:{Authorization:`Bearer ${e.accessToken}`}}),a=(o=n==null?void 0:n.location)==null?void 0:o.split("/");return{registeredApplicantId:a==null?void 0:a[(a==null?void 0:a.length)-1]}}catch(t){throw t instanceof E?S(t):new Error(t)}},Tt=async(s,e)=>{var o;try{const t={officeIds:[e.loginIdentity.officeId],negotiatorIds:[e.loginIdentity.userCode]},r=l.merge(s,t),{headers:n}=await I.post(P.CONTACTS,r,{headers:{Authorization:`Bearer ${e.accessToken}`}}),a=(o=n==null?void 0:n.location)==null?void 0:o.split("/");return{registeredContactId:a==null?void 0:a[(a==null?void 0:a.length)-1]}}catch(t){throw t instanceof E?S(t):new Error(t)}},It=()=>{const s=w(),{connectSession:e}=C(s);return T({mutationKey:["create-applicant-with-contact-record"],mutationFn:async o=>{try{if(!e)return;const t=l.cloneDeep(o),{registeredContactId:r}=await Tt(l.omit(t.contact,["id"]),e)??{};t.applicant=l.merge(t.applicant,{related:[{associatedId:r,associatedType:"contact"}]});const{registeredApplicantId:n}=await Ct(l.omit(t.applicant,["id"]),e)??{};return{registeredContactId:r,registeredApplicantId:n}}catch(t){throw h(t)?t:new Error(t)}}})},Pt=s=>{const e=b(),o=w(),{connectSession:t}=C(o),{mutateAsync:r}=gt(s);return T({mutationFn:async n=>{try{return await Et(s,n,e,t)}catch(a){throw h(a)?(a instanceof p&&await r(),a):new Error(a)}},retry:(n,a)=>n<3&&a instanceof p,onSuccess:()=>{e.removeQueries({queryKey:R.CONTACT_KEYS.single(s)})}})},Et=async(s,e,o,t)=>{try{const r=o.getQueryData(R.CONTACT_KEYS.single(s)),n={"If-Match":r==null?void 0:r._eTag,Authorization:`Bearer ${t.accessToken}`},a=l.omit(e,["id"]);await I.patch(`${P.CONTACTS}/${s}`,a,{headers:n})}catch(r){throw r instanceof E?S(r):new Error(r)}},Rt=s=>{const e=b(),o=w(),{connectSession:t}=C(o),{mutateAsync:r}=St(s);return T({mutationFn:async n=>{try{return await Dt(s,n,e,t)}catch(a){throw h(a)?(a instanceof p&&await r(),a):new Error(a)}},retry:(n,a)=>n<3&&a instanceof p,onSuccess:()=>{e.removeQueries({queryKey:R.APPLICANT_KEYS.single(s)})}})},Dt=async(s,e,o,t)=>{try{const r=o.getQueryData(R.APPLICANT_KEYS.single(s)),n={"If-Match":r==null?void 0:r._eTag,Authorization:`Bearer ${t.accessToken}`},a=l.omit(e,["id"]);await I.patch(`${P.APPLICANTS}/${s}`,a,{headers:n})}catch(r){throw r instanceof E?S(r):new Error(r)}},xt=(s,e)=>{const{mutateAsync:o}=Pt(s.contactId),{mutateAsync:t}=Rt(s.applicantId);return T({mutationFn:async r=>{try{const n=!!(e!=null&&e.isContactFormSchemaDirty),a=!!(e!=null&&e.isApplicantFormSchemaDirty),m=l.cloneDeep(r);return n&&a?await Promise.all([o(m.contact),t(m.applicant)]):n&&!a?await o(m.contact):!n&&a&&await t(m.applicant),{updatedContactId:s.contactId,updatedApplicantId:s.applicantId}}catch(n){throw h(n)?n:new Error(n)}},retry:!1,onSuccess(){}})};const q={"grid-wrapper":"g7hx4b9","break-word":"bsu13sr"},A=({values:s,...e})=>c(at,{...e,"data-testid":e["data-testid"]??"summary-card-box-wrapper",children:c(et,{className:q["grid-wrapper"],children:s.map(({value:o,label:t,className:r,...n},a)=>{const m=K(r&&r,"test");return c(st,{...n,className:m,"data-testid":n["data-testid"]??`summary-card-col-${a}`,children:g(nt,{isFlexColumn:!0,children:[c(L,{hasCapitalisedText:!0,children:t}),c(L,{hasGreyText:!0,hasNoMargin:!0,className:q["break-word"],children:o})]})},t.split(" ").join("-"))})})}),Nt=({isNewRegistration:s,isNoRecordUpdated:e=!1})=>{const{isMobile:o,isTablet:t}=rt();return c("div",{"data-testid":"thank-you-ms-screen",children:c(ot,{isExpanded:!0,isInline:!0,intent:!s&&e?"default":"success",isFullWidth:o||t,className:"el-mt12",children:s?"Great news! The registration has been successful.":e?"No record has been updated.":"Great news! The user record has been successfully updated."})})},Ft=()=>{var _,k;const s=b(),{prevLocation:e}=pt(),{formData:o,setFormData:t}=ht(),{isApplicantFormSchemaDirty:r,isContactFormSchemaDirty:n}=yt(),{resetStoresValues:a}=ft(),m=w(),{connectIsDesktop:Y}=C(m),{addPopStateListener:j}=lt(),{error:U}=ct(),[i]=M.useState({formData:o,prevLocation:e,isApplicantFormSchemaDirty:r,isContactFormSchemaDirty:n}),D=ut(),x=i.prevLocation==="new-registration";M.useEffect(()=>{j("summary",()=>{t(i.formData)}),a()},[]);const{isSuccess:z,isLoading:Q,mutateAsync:V}=It(),{isSuccess:W,isLoading:Z,mutateAsync:J}=xt({contactId:(_=i.formData)==null?void 0:_.contact.id,applicantId:(k=i.formData)==null?void 0:k.applicant.id},{isApplicantFormSchemaDirty:i.isApplicantFormSchemaDirty,isContactFormSchemaDirty:i.isContactFormSchemaDirty}),B=z||W,y=Q||Z,X=()=>{var d;t(i.formData),x?D(F.REGISTRATION,{state:$.SUMMARY_TO_REGISTRATION}):D(`${F.REGISTRATION}/${(d=i.formData)==null?void 0:d.applicant.id}`,{state:$.SUMMARY_TO_REGISTRATION})},H=async()=>{try{let d;if(x){const u=await V(G(i.formData));d=u==null?void 0:u.registeredApplicantId}else{const u=await J(G(i.formData));d=u==null?void 0:u.updatedApplicantId}Y&&d&&(window.location.href=`agencycloud://applicants/${d}`)}catch(d){h(d)&&!(d instanceof p)&&U(d.readableMessage)}};return g(wt,{prefixTestId:"sp",secondaryContent:c(()=>c(tt,{children:B&&c(O,{className:v.fullWidthButton,children:c(N,{"data-testid":"sp-go-to-search-page",intent:"default",onClick:()=>D(F.SEARCH),children:"Go To Search Page"})})}),{}),children:[c(it,{className:v.title,children:"Registration Overview"}),B?c(Nt,{isNoRecordUpdated:!i.isApplicantFormSchemaDirty&&!i.isContactFormSchemaDirty,isNewRegistration:x}):g("div",{"data-testid":"summary-screen",children:[c(A,{values:f("contact",i.formData,s),className:"el-mt6","data-testid":"summary-contact-box"}),c(A,{values:f("status",i.formData,s),className:"el-mt6","data-testid":"summary-status-box"}),c(A,{values:f("requirements",i.formData,s),className:"el-mt6","data-testid":"summary-requirements-box"}),c(A,{values:f("notes",i.formData,s),className:"el-mt6","data-testid":"summary-notes-box"}),g(O,{className:K(dt,mt),children:[c(N,{intent:"default",onClick:X,disabled:y,loading:y,"data-testid":"sp-edit-button",children:"Edit"}),c(N,{intent:"primary",onClick:H,disabled:y,loading:y,"data-testid":"sp-confirm-button",children:"Confirm"})]}),c(At,{})]})]})},Jt=Ft;export{Jt as default};
