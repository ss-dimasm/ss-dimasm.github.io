import{j as o,a as I,F as B}from"./index-b3f50da9.js";import{r as b,aU as Ie,aV as Ee,aW as q,h as ne,D as oe,a6 as U,aa as se,e as ae,U as Ae,aX as Ce,aY as Z,k as we,l as J,n as ee,z as Te,F as he,o as ie,p as ce,aD as _e,I as ve,C as xe,M as Me,P as de,aN as ue,aO as Pe,T as Fe,O as Le,u as Re,a2 as Oe,f as Ve}from"./elements-7fcf5525.js";import{j as ke,u as L,g as V,a5 as Q,a6 as j,a7 as x,a8 as H,a9 as M,A as P,m as te,t as fe,l as qe,a1 as W,d as F,a3 as Ue,a2 as Ge}from"./app-1088c2df.js";import{c as We,a as Ke,o as De}from"./index.esm-c689e26d.js";import{u as Be}from"./index.esm-70abc844.js";import{u as ye}from"./index-03f71f46.js";import{D as Qe,a as je}from"./date-format-295ec623.js";import{S as re}from"./options-f2badf58.js";import{e as be,p as Se,n as K,a as Ne}from"./regex-d912c3f8.js";import{r as He}from"./index-073cf7c6.js";import{Q as $,U as z}from"./url-ce1d32f5.js";import{u as Y}from"./useInfiniteQuery-a457b465.js";import{c as $e}from"./index-fa19f396.js";import{w as D}from"./index-c5c95794.js";import{g as ze}from"./helper-ac9457cc.js";import{E as Ye}from"./error-messages-a063dfd8.js";import{a as Xe}from"./index-706e92ed.js";import{a as Ze}from"./index-230a9ce9.js";import{A as Je}from"./appointment-card-82b17dcf.js";import{g as et,u as tt}from"./use-property-marketing-mode-store-09297abf.js";import"./index-8f0c1425.js";import"./property-owner-1850ad04.js";const le=(e,r)=>{if(!ke(e))return null;if(r==="contact"){if(be.isValidSync(e))return{email:[e]};if(Se.isValidSync(e))return{contactDetail:[e]};if(K.test(e))return{name:e}}return r==="property"&&(K.test(e)||Ne.test(e))?{address:e}:null},me=(e,r)=>{switch(r){case"searchType":return["contact","property"].includes(e)?e:"property";case"marketingMode":return["selling","letting"].includes(e)?e:"selling"}},rt=({searchParams:e,pageSize:r=25,options:a})=>{const n=L(),d=V(),u={...e,pageSize:r},s=z.CONTACTS,t=$.CONTACT.infinite(u),c=b.useMemo(()=>t??Q(s,u),[s,u]);return Y({queryKey:c,getNextPageParam:i=>{if(!(!(i.pageNumber&&i.totalPageCount)||i.pageNumber>=i.totalPageCount))return i.pageNumber+1},getPreviousPageParam:i=>{if(!(!(i.pageNumber&&i.totalPageCount)||i.pageNumber<=1))return i.pageNumber-1},queryFn:async({pageParam:i=1})=>{try{const l=await j(d);if(!l)throw new x({description:H});u.pageNumber=i;const g=M(s,u,!0)(),{data:h}=await P.get(g,{headers:l});return h}catch(l){l instanceof x&&n("/login")}},retry:!1,refetchOnWindowFocus:!1,...a})},nt=({searchParams:e,options:r})=>{const a=L(),n=V(),d=z.LANDLORDS,u=$.LANDLORD.infinite(e),s=b.useMemo(()=>u??Q(d,e),[d,e]);return Y({queryKey:s,getNextPageParam:t=>{if(!(!(t.pageNumber&&t.totalPageCount)||t.pageNumber>=t.totalPageCount))return t.pageNumber+1},getPreviousPageParam:t=>{if(!(!(t.pageNumber&&t.totalPageCount)||t.pageNumber<=1))return t.pageNumber-1},queryFn:async({pageParam:t=1})=>{try{const c=await j(n);if(!c)throw new x({description:H});e.pageNumber=t;const i=M(d,e,!0)(),{data:l}=await P.get(i,{headers:c});return l}catch(c){c instanceof x&&a("/login")}},retry:!1,refetchOnWindowFocus:!1,...r})},at=({searchParams:e,options:r})=>{const a=V(),n=L(),d=z.VENDORS,u=$.VENDOR.infinite(e),s=b.useMemo(()=>u??Q(d,e),[d,e]);return Y({queryKey:s,getNextPageParam:t=>{if(!(!(t.pageNumber&&t.totalPageCount)||t.pageNumber>=t.totalPageCount))return t.pageNumber+1},getPreviousPageParam:t=>{if(!(!(t!=null&&t.pageNumber&&(t!=null&&t.totalPageCount))||t.pageNumber<=1))return t.pageNumber-1},queryFn:async({pageParam:t=1})=>{try{const c=await j(a);if(!c)throw new x({description:H});e.pageNumber=t;const i=M(d,e,!0)(),{data:l}=await P.get(i,{headers:c});return l}catch(c){c instanceof x&&n("/login")}},retry:!1,refetchOnWindowFocus:!1,...r})},ot=(e,r,a)=>{const n=Object.values(e)[0].marketingMode;return r.forEach(d=>{d.associatedIds.forEach(u=>{if(n==="selling")e[u]._embedded={[a]:d};else{const s=Object.values(e).find(t=>{var c;return((c=t.letting)==null?void 0:c.landlordId)===u});s!=null&&s.id&&(e[s==null?void 0:s.id]._embedded={[a]:d})}})}),e},st=async({marketingMode:e,usedInfiniteQueryInstance:r,pageNumber:a,pageSize:n=25,isViaContact:d=!1})=>{var c,i,l,g;const u=[];let s,t=a!==1;if(d){const h=[];for(;h.length<n;){const y=await r.fetchNextPage(t?void 0:{pageParam:1});if(t||(t=!0),s=(c=y.data)==null?void 0:c.pages[y.data.pages.length-1],(i=s==null?void 0:s._embedded)==null||i.forEach(S=>{var A,N;const m={...S,associatedIds:[]};(N=(A=S._embedded)==null?void 0:A.relationships)==null||N.forEach(p=>{(e==="selling"?"vendor":"landlord")===p.associatedType&&p.associatedId&&(m.associatedIds.push(p.associatedId),h.push(p.associatedId))}),u.push(m)}),s==null||((s==null?void 0:s.pageNumber)??0)>=((s==null?void 0:s.totalPageCount)??0))break}}else{const h=await r.fetchNextPage(t?void 0:{pageParam:1});s=(l=h.data)==null?void 0:l.pages[h.data.pages.length-1],(g=s==null?void 0:s._embedded)==null||g.forEach(y=>{u.push({...y,associatedIds:[y.id]})})}return{associatedIds:u.map(h=>h.associatedIds).flat(1),lastFetchedResult:s,result:u}},G=15,it=({marketingMode:e,inputType:r,searchParams:a,options:n})=>{const d=V(),u=L(),s=rt({searchParams:te.cloneDeep({...a,embed:["relationships"]}),pageSize:G,options:{enabled:!1}}),t=at({searchParams:te.cloneDeep({...a,pageSize:G}),options:{enabled:!1}}),c=nt({searchParams:te.cloneDeep({...a,pageSize:G}),options:{enabled:!1}}),i={pageSize:G},l={...a,inputType:r,marketingMode:e},g=z.PROPERTIES,h=$.PROPERTY.infinite(l),y=b.useMemo(()=>h??Q(g,l),[g,l]),S=Object.keys(a??{}).includes("address");return Y({...n,queryKey:y,enabled:!!a&&!!Object.keys(a).length&&(r==="property"?S:!S),getNextPageParam:m=>{if(!(!(m!=null&&m.pageNumber&&(m!=null&&m.totalPageCount))||m.pageNumber>=m.totalPageCount))return m.pageNumber+1},queryFn:async({pageParam:m=1})=>{var A;try{const N=await j(d);if(!N)throw new x({description:H});let p=i;if(r==="contact"){const f=!!((A=a==null?void 0:a.contactDetail)!=null&&A.length),{associatedIds:C,lastFetchedResult:E,result:R}=await st({marketingMode:e,isViaContact:f,pageSize:i.pageSize,usedInfiniteQueryInstance:f?s:e==="selling"?t:c,pageNumber:m});let _={};if(C.length){p[e==="selling"?"id":"landlordId"]=C,p.pageSize=100;const k=M(g,p,!1)();let{data:v}=await P.get(k,{headers:N});if(e==="letting")for(;v.pageNumber<v.totalPageCount;){const X=M(g,{...p,pageNumber:v.pageNumber+1},!1)(),{data:O}=await P.get(X,{headers:N});v={...O,_embedded:v._embedded.concat(O._embedded??[])}}_=He(v._embedded??[]),_=ot(_,R,f?"contact":e=="selling"?"vendor":"landlord")}return{_embedded:Object.values(_),pageNumber:E==null?void 0:E.pageNumber,pageSize:i.pageSize,totalPageCount:E==null?void 0:E.totalPageCount,pageCount:E==null?void 0:E.pageCount}}else p={...p,pageNumber:m,address:a.address,marketingMode:[e],embed:e==="selling"?["vendor"]:["landlord"]};const w=M(g,p,!1)(),{data:T}=await P.get(w,{headers:N});return T}catch(N){N instanceof x&&u("/login")}},retry:!1,refetchOnWindowFocus:!1})},ct=({rowData:e,onCardClick:r,preferredMarketingMode:a})=>{var c;const n=(c=e._embedded)==null?void 0:c.contact,{address:d,ownerName:u,marketingStatus:s}=ze(e,a);let t;if(n){const i=e._embedded.contact;t=$e(i.title,i.forename,i.surname)}return o(Ie,{onClick:()=>{r(e.id)},"data-testid":"property-item",className:"el-mb2",children:I(Ee,{children:[o(q,{icon:"houseInfographic",narrowLabel:"Address",children:D(d)}),o(q,{}),o(q,{icon:e.marketingMode==="selling"?"vendorInfographic":"landInfographic",narrowLabel:(e.marketingMode!=="sellingAndLetting"?e.marketingMode:a==="selling")?"Vendor":"Landlord",children:D(t??u)}),o(q,{icon:"listInfographic",narrowLabel:"Property Status",children:s})]})},e==null?void 0:e.id)},dt=({debouncedParams:e,searchType:r,marketingMode:a})=>{var l,g,h,y,S;const n=it({marketingMode:a,searchParams:e,inputType:r}),d=L(),{ref:u,inView:s}=ye();b.useEffect(()=>{s&&n.fetchNextPage()},[s]);const t=!((g=(l=n.data)==null?void 0:l.pages)!=null&&g.length)||!((y=(h=n.data)==null?void 0:h.pages[0]._embedded)!=null&&y.length)||n.error instanceof fe,c=(S=n.data)==null?void 0:S.pages.flatMap(m=>[...m._embedded??[]]),i=m=>{d({pathname:m})};return o("div",{children:n.fetchStatus=="idle"&&!n.isFetched?o(B,{}):n.isLoading?o(ne,{className:oe(U,se)}):t?o(ae,{"data-testid":"not-found-notification",className:U,isExpanded:!0,intent:"default",isInline:!0,isFullWidth:!0,children:"No result!"}):I("div",{className:U,children:[I(Ae,{"data-testid":"property-table-search-results","data-force-narrow-table":"true",children:[I(Ce,{children:[o(Z,{"data-testid":"address-header",children:"Address"}),o(Z,{"data-testid":"property-owner-role-header",children:a==="selling"?"Vendor":"Landlord"}),o(Z,{"data-testid":"property-status-header",children:"Property Status"})]}),c==null?void 0:c.map(m=>o(ct,{preferredMarketingMode:a,onCardClick:i,rowData:m},m.id))]}),n.hasNextPage&&o("div",{ref:u,className:oe(U,se),"data-testid":"bottom-loader",children:o(ne,{})})]})})},ut=new RegExp(K.source),lt=new RegExp(`${K.source}|${Ne.source}`),mt=We().shape({searchInput:Ke().test({name:"search-input-validation",message:Ye.INVALID_INPUT_PATTERN,test:(e,r)=>{if(e==="")return!0;if(r.parent.searchType==="contact")return be.isValidSync(e)||Se.isValidSync(e)||ut.test(e);if(r.parent.searchType==="property")return lt.test(e)}})}),pt=({setShowUpcoming:e})=>{var T;const{params:r,encodeParamsAndAssignToURL:a}=qe(),{register:n,watch:d,formState:{errors:u},trigger:s,setValue:t}=Be({defaultValues:{marketingMode:me(r.marketingMode,"marketingMode"),searchType:me(r.searchType,"searchType")},resolver:De(mt),mode:"all"}),{searchInput:c,searchType:i,marketingMode:l}=d(),g=le(r==null?void 0:r.q,r==null?void 0:r.searchType),[h,y]=b.useState(g?{...g}:null),S=async f=>{const C=d("marketingMode"),E=d("searchType"),{value:R,name:_}=f.target,k=_==="searchType"?R:E,v=_==="searchInput"?R:c,X=_==="marketingMode"?R:C;_==="searchType"&&await s("searchInput");const O=le(v,k);y(O?{...O}:null),a({q:v,searchType:k,marketingMode:X})};b.useEffect(()=>{e(!c)},[c]),b.useEffect(()=>{const f={q:r.q??"",marketingMode:l,searchType:i};a(f)},[]),b.useEffect(()=>{const f={searchInput:r.q,marketingMode:l,searchType:i};Object.entries(W.omit(f,["page","q"])).map(([C,E])=>t(C,E,{shouldValidate:!0})),y(g?{...g}:null),t("marketingMode",l),t("searchType",i)},[r]);const{ref:m,inView:A}=ye(),[N,p]=b.useState(!1);b.useEffect(()=>{p(!A)},[A]);const w=()=>{const f=document.getElementById("landing-page-container");f==null||f.scroll({top:0,behavior:"smooth"})};return I(B,{children:[o("div",{ref:m,children:I(we,{children:[I(J,{children:[o(ee,{...n("searchInput",{onChange:b.useMemo(()=>W.debounce(f=>{S(f)},Qe),[])}),"data-testid":"ma-search-input",type:"search",icon:"searchSystem",placeholder:`${i==="contact"?"Name, Email or Phone Number":"House Name/Flat, Address, or Postcode"}`,label:`${i==="contact"?`Search ${re(l).TYPE.contact}`:"Search Property"}`}),o(Te,{message:(T=u.searchInput)==null?void 0:T.message})]}),I(he,{className:"el-col-gap8",children:[o(J,{children:I(ee,{children:[o(ie,{children:"Marketing Mode"}),o(ce,{...n("marketingMode",{onChange:S}),hasGreyBg:!0,options:Object.entries(re().MARKETING_MODE).map(([f,C])=>({id:`option-${f}`,value:f,text:C,isChecked:f===l})),"data-testid":"ma-marketing-mode-options"})]})}),o(J,{children:I(ee,{children:[o(ie,{children:"Search Type"}),o(ce,{...n("searchType",{onChange:S}),hasGreyBg:!0,options:Object.entries(re(l).TYPE).map(([f,C])=>({id:`option-${f}`,value:f,text:C,isChecked:f===i})),"data-testid":"ma-search-type-options"})]})})]})]})}),o(dt,{marketingMode:l,debouncedParams:h??{},searchType:i}),N&&o(_e,{isVisible:!0,"data-testid":"scroll-to-top-fab",buttonIcon:"upSystem",onClick:w})]})},gt=()=>{var N;const e=V(),[r,a]=b.useState(null),[n,d]=b.useState(null);b.useEffect(()=>{e.connectSession().then(p=>{const w=p==null?void 0:p.loginIdentity.userCode;p&&w&&a(w)})},[e]);const u=F().hour(),s={start:F().set("hours",u).set("minutes",0).set("milliseconds",0).set("seconds",0).toISOString(),end:F().add(3,"days").set("hours",0).set("minutes",0).set("milliseconds",0).set("seconds",0).toISOString(),typeId:["VL"],negotiatorId:[r],sortBy:"start",includeCancelled:!1},[t,c,{isError:i,isLoading:l,isFetched:g}]=Xe({queryParams:s,fetchWhenTrue:[!!r],staleTime:1e3*60*5}),[h,y,{isError:S,isLoading:m,isFetched:A}]=Ze({queryParams:{id:n,embed:["landlord","vendor"]},staleTime:1e3*60*5,fetchWhenTrue:[n==null?void 0:n.length]});return b.useEffect(()=>{var p;if((p=t==null?void 0:t._embedded)!=null&&p.length){const w=t._embedded.map(T=>{if(T!=null&&T.propertyId)return T.propertyId});d(w)}},[t==null?void 0:t._embedded]),{appointmentData:{...t,_embedded:(N=t==null?void 0:t._embedded)==null?void 0:N.filter(p=>!!(p!=null&&p.propertyId))},groupedAppointmentsByDate:ht(t),propertyData:h,error:c||y,isError:i||S,isLoading:l||m,isFetched:g&&(!n||A)}},ht=e=>{const r=[];for(const a of(e==null?void 0:e._embedded)??[]){const n=F(a.start).format("DD/MM/YYYY"),d=r.findIndex(([u])=>[n].includes(u));d!==-1?r[d][1].push(a):r.push([n,[a]])}return r},pe=e=>{const r=F(e);if(r.isValid())return r.format(je);throw new Error("Invalid Date")},ft=e=>{let r={buildingName:e==null?void 0:e.buildingName,line1:e==null?void 0:e.line1,line2:e==null?void 0:e.line2,postcode:e==null?void 0:e.postcode};return r=W.omitBy(r,W.isEmpty),Ue(Object.values(r))},ge=({appointmentData:e,listPropertiesData:r})=>{var t,c;const a=L(),n=r?r.find(i=>i.id===(e==null?void 0:e.propertyId)):{},{data:d,role:u}=et(n,n==null?void 0:n.marketingMode)??{},s=[{title:D((c=(t=d==null?void 0:d.related)==null?void 0:t[0])==null?void 0:c.name,"No Vendor or Landlord found"),data:D(u),iconName:"houseInfographic","data-testid":"appointment-property-info-item"}];return n!=null&&n.address?o(Je,{onClick:()=>a(`/${n.id}`),heading:`${F(e==null?void 0:e.start).format("DD MMM")}, ${pe(e.start)} - ${pe(e.end)}`,subHeading:ft(n.address),listItems:s},e.id):o(B,{})},yt=()=>{var l,g;const{appointmentData:e,groupedAppointmentsByDate:r,propertyData:a,error:n,isError:d,isLoading:u,isFetched:s}=gt(),{isMobile:t,isTablet:c}=ve(),i=s&&(!((l=e==null?void 0:e._embedded)!=null&&l.length)||n instanceof fe);return I("div",{className:"el-mt12",children:[o(xe,{"data-testid":"upcoming-ma-appointment-title",children:"Upcoming market appraisal appointments"}),o("div",{"data-testid":"upcoming-ma-appointment-list",children:u?o(ne,{"data-testid":"loading-upcoming-ma"}):d?o(ae,{"data-testid":"upcoming-ma-appointment-error-notification",isExpanded:!0,isFullWidth:t||c,intent:"danger",children:(n==null?void 0:n.readableMessage)||Ge.DEFAULT}):(g=e==null?void 0:e._embedded)!=null&&g.length&&a?t||c?o(Me,{"data-testid":"upcoming-ma-appointment-list=small-screen-container",children:e==null?void 0:e._embedded.map(h=>o(de,{children:o(ge,{appointmentData:h,listPropertiesData:a==null?void 0:a._embedded})},h.id))}):o(ue,{"data-testid":"upcoming-ma-appointment-list-wider-screen-container",rowGapDesktop:8,rowGapWideScreen:8,rowGapSuperWideScreen:8,rowGap4KScreen:8,children:r.map(([h,y])=>o(Pe,{spanWideScreen:12,spanDesktop:12,spanSuperWideScreen:18,span4KScreen:20,children:o(ue,{rowGapDesktop:2,rowGapWideScreen:2,rowGapSuperWideScreen:2,rowGap4KScreen:2,colGapDesktop:4,colGapWideScreen:4,colGapSuperWideScreen:4,colGap4KScreen:4,children:y==null?void 0:y.map(S=>o(de,{children:o(ge,{appointmentData:S,listPropertiesData:a==null?void 0:a._embedded})},S.id))})},h))}):i?o(ae,{"data-testid":"upcoming-ma-appointment-error-notification",isExpanded:!0,isInline:!0,intent:"default",className:"el-mt7",isFullWidth:t||c,children:"No upcoming appointments found!"}):o(B,{})})]})},bt=()=>{const[e,r]=b.useState(!0),{resetData:a}=tt();return b.useEffect(()=>{a()},[]),I(he,{isFlexGrow1:!0,children:[I(Fe,{children:[o(Le,{children:"Market Appraisals"}),o(Re,{"data-testid":"controls-icon",className:"el-mb5",icon:"propertyManagementInfographic",iconSize:"large"}),o(Oe,{"data-testid":"controls-description",hasGreyText:!0,children:"This app provides the tools required to document the outcome of a market appraisal appointment and make changes to an existing property record."})]}),I(Ve,{id:"landing-page-container",children:[o(pt,{setShowUpcoming:r}),e&&o(yt,{})]})]})},Kt=bt;export{Kt as default};
