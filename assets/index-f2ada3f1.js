import{j as r,a as S,F as Y}from"./index-e8b020c1.js";import{i as Me,r as L,I as At,e as be,U as rn,aX as an,aY as we,aU as cn,aV as bt,aW as ie,O as He,k as rt,H as at,l as _e,n as Oe,z as Je,o as qe,p as It,h as te,u as Te,a2 as Se,J as Qe,C as dn,b9 as it,aP as Ft,aL as re,ba as wt,t as ln,ae as un,D as _t,bb as et,aT as mn,bc as fn,bd as hn,be as gn,bf as yn,bg as Tn,bh as bn,$ as In,y as We,x as Rt,j as pn,Z as Cn,V as tt,v as pt,al as Pn,S as Nn,F as Sn,T as Ln,X as vn,_ as En,a0 as nt,a1 as Ct,f as On,aD as An,a3 as Fn,a4 as wn}from"./elements-7fcf5525.js";import{b as ct,j as p,q as Ye,a1 as k,x as _n,u as Ge,a3 as xe,l as Rn,a2 as Mn,d as le,c as Ze,g as xn,e as dt,B as kn,E as Mt,R as xt,f as Ue,m as ve,N as $n}from"./app-fc3be005.js";import{n as Pt}from"./index-6d471c01.js";import{u as lt}from"./index.esm-70abc844.js";import{a as Re,c as kt,o as $t}from"./index.esm-c689e26d.js";import{u as qn}from"./index-03f71f46.js";import{U as ut,Q as q}from"./url-4ca753ad.js";import{c as Un,d as mt,u as qt}from"./index-212ea2b6.js";import{c as Dn,d as ft,b as Ut}from"./index-6acf4864.js";import{u as Wn,c as Dt,d as Wt,e as Qt}from"./index-6c5b59a3.js";import{a as Yt,b as Gt}from"./index-e3d4c553.js";import{d as Ke,a as Nt}from"./index-9c9b5ed0.js";import{u as Qn}from"./useInfiniteQuery-a05e96a4.js";import{c as ce}from"./index-9e5feb1c.js";import{c as Ae}from"./index-fa19f396.js";import{w as Z}from"./index-c5c95794.js";import{u as ht,D as gt}from"./use-phone-contact-b6fb9426.js";import{M as yt}from"./modal-dialog-98b0c374.js";import{p as Yn}from"./middleware-a8d06d07.js";import{u as Gn}from"./index-6f29ff01.js";import{u as Vn,a as Bn}from"./index-6eaee720.js";import{g as jn}from"./generate-1a9ed554.js";import{b as Vt,a as Jn,u as $e}from"./index-d53a076b.js";import{i as Kn,a as zn}from"./isSameOrAfter-571fd34c.js";import"./index-0d5dc733.js";const Hn=e=>ct({...e,method:"GET",path:ut.OFFERS}),Zn=e=>ct({...e,method:"GET",path:ut.TENANCIES}),Xn=e=>ct({...e,method:"GET",path:ut.AREAS}),eo={ENTITIES:"/:sourceType/*",ENTITIES_DETAIL:"/:sourceType/:id/*",ENTITIES_DETAIL_OVERVIEW:"/:sourceType/:id/view",CONTACTS_LIST:"/contact/list"},to=1e3,Bt=["companyTypes","supplierTypes","journalEntryTypes"],ot={TYPE:{property:"Address",vendorOrLandlord:"Name/Contact"},SOURCE:{contact:"Contact",company:"Company"}},no={pending:"Pending",withdrawn:"Withdrawn",rejected:"Rejected",accepted:"Accepted",noteOfInterest:"Note Of Interest",noteOfInterestWithdrawn:"NOI Withdrawn"},jt={preAppraisal:"Pre Appraisal",valuation:"Market Appraisal",paidValuation:"Paid Valuation",forSale:"For Sale - Available",forSaleUnavailable:"For Sale - Unavailable",underOffer:"Sold STC - Available",underOfferUnavailable:"Sold STC - Unavailable",reserved:"Reserved",exchanged:"Exchanged",completed:"Completed",soldExternally:"Sold Externally",withdrawn:"Withdrawn"},Jt={valuation:"Market Appraisal",toLet:"To Let - Available",toLetUnavailable:"To Let - Unavailable",underOffer:"Under Offer - Available",underOfferUnavailable:"Under Offer - Unavailable",arrangingTenancyUnavailable:"Arranging Tenancy - Unavailable",arrangingTenancy:"Arranging Tenancy - Available",tenancyCurrentUnavailable:"Tenancy Current - Unavailable",tenancyCurrent:"Tenancy Current - Available",tenancyFinished:"Tenancy Finished",tenancyCancelled:"Tenancy Cancelled",sold:"Sold",letByOtherAgent:"Let by other agent",letPrivately:"Let privately",provisional:"Provisional",withdrawn:"Withdrawn"},oo={offerPending:"Offer Pending",offerWithdrawn:"Offer Withdrawn",offerRejected:"Offer Rejected",arranging:"Arranging",current:"Current",finished:"Finished",cancelled:"Cancelled"},Tt={weekly:"week",monthly:"month",annually:"annum"},so={PH:"Telephone/Contact",MI:"Miscellaneous",DC:"Detail Change",LM:"Left Message"},io=new RegExp(/^[0-9\s()+]+$/),Kt=Re().trim().required().matches(io),zt=Re().trim().required().email(),Ht=new RegExp(/^[a-zA-Z'\s]+$/),Zt=new RegExp(/^[a-zA-Z0-9\s'._@&+-]+$/),Xt=new RegExp(/^[a-zA-Z0-9\s]+$/),ro=new RegExp(/^[0-9-: ]+(?=\s-\s)/),St=(e,o)=>{if(!p(e))return null;if(o==="vendorOrLandlord"){if(zt.isValidSync(e))return{email:[e]};if(Kt.isValidSync(e))return{contactDetail:[e]};if(Zt.test(e))return{name:e}}return o==="property"&&(Ht.test(e)||Xt.test(e))?{address:e}:null},Be=(e,o)=>{switch(o){case"searchType":return["property","vendorOrLandlord"].includes(e)?e:"property";case"searchSource":return["contact","company"].includes(e)?e:"contact"}},ao=e=>{const o={pageSize:25,pageNumber:1},t=Ye(),[i]=Dn({onSuccess:m=>{var y;const f=m;for(const N of(f==null?void 0:f._embedded)??[])t.setQueryData(q.CONTACT.single(N==null?void 0:N.id),N),t.setQueryData(q.CONTACT.relationships(N==null?void 0:N.id),{_embedded:(y=N==null?void 0:N._embedded)==null?void 0:y.relationships})}}),[n]=Un({onSuccess:m=>{const f=m;for(const y of(f==null?void 0:f._embedded)??[])t.setQueryData(q.COMPANY.single(y==null?void 0:y.id),y)}}),[a]=Ke({}),[c]=Wn({onSuccess:m=>{const f=m;for(const y of(f==null?void 0:f._embedded)??[])t.setQueryData(q.OFFICE.single(y==null?void 0:y.id),y)}}),[g]=Yt({onSuccess:m=>{const f=m;for(const y of(f==null?void 0:f._embedded)??[])t.setQueryData(q.NEGOTIATOR.single(y==null?void 0:y.id),y)}}),[d]=Dt({onSuccess:m=>{const f=m;for(const y of(f==null?void 0:f._embedded)??[])t.setQueryData(q.LANDLORD.single(y==null?void 0:y.id),y)}}),[I]=Wt({onSuccess:m=>{const f=m;for(const y of(f==null?void 0:f._embedded)??[])t.setQueryData(q.VENDOR.single(y==null?void 0:y.id),y)}}),T=Object.keys((e==null?void 0:e.queryParams)??{}).includes("address");return Qn({queryKey:["contact-look-up-search","infinite",JSON.stringify(e)],enabled:p(e==null?void 0:e.type)&&!!Object.keys((e==null?void 0:e.queryParams)??{}).length&&(e.type==="property"?T:!T),staleTime:0,cacheTime:0,queryFn:async({pageParam:m=1})=>{const f={...o,...e==null?void 0:e.queryParams,pageNumber:m},N=await{contact:async()=>i({...f,embed:["relationships"]}),company:async()=>n(f),property:async()=>{const l=await a({...f,pageSize:100}),{landlordIds:s,vendorIds:u}=mo(l??{},t);await Promise.all([p(s)?d({id:s,pageSize:100}):void 0,p(u)?I({id:u,pageSize:100}):void 0]);const C=(e==null?void 0:e.sourceData)==="contact",{needToFetch:v,cachedData:F}=lo(l,e==null?void 0:e.sourceData,t),[U,A]=await Promise.all([C&&p(v)?i({id:v.map(([D])=>D),embed:["relationships"],pageSize:100}):void 0,!C&&p(v)?n({id:v.map(([D])=>D),pageSize:100}):void 0]);uo(C?(U==null?void 0:U._embedded)??[]:(A==null?void 0:A._embedded)??[],v,t);const _=[...F,...(C?U==null?void 0:U._embedded:A==null?void 0:A._embedded)??[]];return{...l,_embedded:_.sort((D,J)=>new Date(J.created).getTime()-new Date(D.created).getTime())}}}[e==null?void 0:e.type](),{officeIds:b,negotiatorIds:h}=co((N==null?void 0:N._embedded)??[],t);return await Promise.all([p(b)&&c({id:b,pageSize:100}),p(h)&&g({id:h,pageSize:100})]),N},retry:!1,refetchOnWindowFocus:!1,getNextPageParam:m=>{if(!(!(m.pageNumber&&m.totalPageCount)||m.pageNumber>=m.totalPageCount))return m.pageNumber+1},getPreviousPageParam:m=>{if(!(!(m.pageNumber&&m.totalPageCount)||m.pageNumber<=1))return m.pageNumber-1}})},co=(e,o)=>{const t=[],i=[];for(const c of e??[]){if(p(c==null?void 0:c.officeIds)&&p(c==null?void 0:c.officeIds[0])){t.push(c==null?void 0:c.officeIds[0]);continue}if(p(c==null?void 0:c.negotiatorIds)&&p(c==null?void 0:c.negotiatorIds[0])){i.push(c==null?void 0:c.negotiatorIds[0]);continue}}let n=k.uniq(t),a=k.uniq(i);for(const c of[...n]){const g=o.getQueryData(q.OFFICE.single(c));g&&(n=n.filter(d=>d!==g.id))}for(const c of[...a]){const g=o.getQueryData(q.NEGOTIATOR.single(c));g&&(a=a.filter(d=>d!==g.id))}return{officeIds:n,negotiatorIds:a}},lo=(e,o,t)=>{var d,I,T;const i=[],n=m=>{var f;return!!((f=m==null?void 0:m.related)!=null&&f[0])},a=(m,f)=>{var y,N;return((N=(y=m==null?void 0:m.related)==null?void 0:y[0])==null?void 0:N.type)===f};for(const m of(e==null?void 0:e._embedded)??[]){const f=["letting","sellingAndLetting"].includes((m==null?void 0:m.marketingMode)??""),y=["selling","sellingAndLetting"].includes((m==null?void 0:m.marketingMode)??""),N=t.getQueryData(q.LANDLORD.single((d=m==null?void 0:m.letting)==null?void 0:d.landlordId)),b=t.getQueryData(q.VENDOR.single(m==null?void 0:m.id));if(f&&n(N)||y&&n(b)){const h=f?N:b,l=(I=h==null?void 0:h.related)==null?void 0:I[0].id;a(h,o)&&i.push([l,m.address])}}const c=k.uniqWith(i,([m],[f])=>m===f),g=[];for(const[m]of[...c]){const f=o==="contact"?q.CONTACT.single(m):q.COMPANY.single(m),y=t.getQueryData(f);if(y&&p((T=y==null?void 0:y.metadata)==null?void 0:T.propertyAddress)){const N=c.findIndex(([b])=>b===y.id);N!==-1&&c.splice(N,1),g.push(y)}}return{needToFetch:c,cachedData:g}},uo=(e,o,t)=>{for(const i of e??[]){const n="branch"in i,a=o.findIndex(([g])=>g===i.id);a!==-1&&(i.metadata={propertyAddress:o[a][1]});const c=n?q.COMPANY.single(i.id):q.CONTACT.single(i.id);t.setQueryData(c,i)}},mo=(e,o)=>{var a;const t=[],i=[],n=(c,g)=>{const d=g==="landlord"?q.LANDLORD.single(c):q.VENDOR.single(c);return!!o.getQueryData(d)};for(const c of(e==null?void 0:e._embedded)??[]){const g=["letting","sellingAndLetting"].includes((c==null?void 0:c.marketingMode)??""),d=["selling","sellingAndLetting"].includes((c==null?void 0:c.marketingMode)??""),I=(a=c==null?void 0:c.letting)==null?void 0:a.landlordId,T=c==null?void 0:c.id;g&&p(I)&&!n(I,"landlord")&&t.push(I),d&&p(T)&&!n(T,"vendor")&&i.push(T)}return{landlordIds:k.uniq(t),vendorIds:k.uniq(i)}},De={INVALID_INPUT_PATTERN:"Invalid pattern",FIELD_REQUIRED:"Required",CANNOT_CONTAIN:e=>`Cannot contain ${e}`},fo=new RegExp(Zt.source),ho=new RegExp(`${Ht.source}|${Xt.source}`),go=kt().shape({searchInput:Re().test({name:"search-input-validation",test:(e,o)=>{if(e==="")return!0;if(o.parent.searchType==="vendorOrLandlord"){if(zt.isValidSync(e)||Kt.isValidSync(e)||fo.test(e))return!0;const t=e.replace(/[a-zA-Z0-9\s'._@&+-]/g,"");return o.createError({message:De.CANNOT_CONTAIN(`some special characters such as ${k.uniq(t)}`),path:o.path})}if(o.parent.searchType==="property")return ho.test(e)?!0:o.createError({message:De.CANNOT_CONTAIN("any special characters"),path:o.path})}})}),yo=(e,o)=>{if(!(!o||!p(e))){if(p(e.officeIds)&&p(e.officeIds[0])){const t=o.getQueryData(q.OFFICE.single(e.officeIds[0]));return{type:"office",data:t==null?void 0:t.name}}if(p(e.negotiatorIds)&&p(e.negotiatorIds[0])){const t=o.getQueryData(q.NEGOTIATOR.single(e.negotiatorIds[0]));return{type:"negotiator",data:t==null?void 0:t.name}}}},To=(e,o)=>{var a,c;if(!o||!p(e))return[];const{supplierTypes:t,companyTypes:i}=o.getQueryData(q.CONFIGURATION.types(Bt))??{},n=(g,d)=>(g??[]).reduce((I,T)=>{const m=d==null?void 0:d.find(f=>(f==null?void 0:f.id)===T);return m&&(m!=null&&m.value)&&I.push(m.value),I},[]);if(((e==null?void 0:e.typeIds)??[]).includes("SP")){const g=p(e==null?void 0:e.supplierTypeId),d=n((g?(a=e==null?void 0:e.typeIds)==null?void 0:a.filter(T=>T!=="SP"):e==null?void 0:e.typeIds)??[],i??[]),I=n(((c=e==null?void 0:e.supplierTypeId)==null?void 0:c.split(","))??[],t??[]);return[...d,...I]}return n((e==null?void 0:e.typeIds)??[],i??[])},bo=(e,o)=>{if(!o||!p(e))return;const t=[],i=o.getQueryData(q.CONTACT.relationships(e.id));for(const n of(i==null?void 0:i._embedded)??[])p(n==null?void 0:n.associatedType)&&t.push(k.capitalize(n.associatedType));return k.uniq(t)},Ve=_n()(Yn(e=>({draftedMessage:null,storeDraftedMessage:o=>e(()=>({draftedMessage:o}))}),{name:"journal-entry-storage"})),Io=({data:e,searchSource:o,type:t,isAddressSearchFetching:i})=>{const n=Ge(),a=Ve(s=>s.storeDraftedMessage),c=Ye(),g=Me("root"),d=Me("root"),[I,T]=L.useState(""),{PhoneContactModal:m,openPhoneContactModal:f}=ht({onActionClick:(s,u)=>{d.openModal(),a(u.message)},isUsingDraftModal:!0}),{isMobile:y,isTablet:N}=At(),b=s=>Object.hasOwn(s,"branch"),h=k.unionBy(e.flatMap(s=>(s==null?void 0:s._embedded)??[]),"id");if(i&&t==="property")return null;if(!p(h)&&t==="property")return r(be,{"data-testid":"not-found-notification",className:"el-mt8",isExpanded:!0,intent:"default",isInline:!0,isFullWidth:!0,children:"No result!"});const l=s=>{var C;a(s);const u=(C=h.find(v=>v.id===I))==null?void 0:C.email;window.open(`mailto:${u}?body=${s}`),g.closeModal(),d.openModal()};return S(Y,{children:[S(rn,{"data-testid":"search-result-table",children:[S(an,{"data-testid":"search-result-table-header-row",children:[r(we,{children:"Name"}),S(we,{children:[t==="property"?"Property ":o==="contact"?"Contact ":"Company ","Address"]}),o==="company"&&r(we,{children:"Company Type"}),r(we,{children:"Contact Details"}),r(we,{children:"Office/Key Contact"}),o==="contact"&&r(we,{children:"Active Roles"})]}),h.map(s=>{var U,A,_,D,J,W;const{type:u,data:C}=yo(s,c)??{},v=b(s)?(A=(U=s.additionalContactDetails)==null?void 0:U.find(B=>B.type==="Business"))==null?void 0:A.value:void 0,F=B=>{T(s.id??""),B()};return r(cn,{"data-testid":"search-result-table-children-row-container",onClick:B=>{B.stopPropagation(),n(`/${o}/${s==null?void 0:s.id}/view`)},children:b(s)?S(bt,{children:[y||N?S(Y,{children:[r(ie,{"data-testid":"row-company-address",icon:"houseInfographic",narrowLabel:`${t==="property"?"Property ":"Company "}Address`,darkText:!0,narrowIsFullWidth:!0,children:ce(t==="property"?(_=s==null?void 0:s.metadata)==null?void 0:_.propertyAddress:s==null?void 0:s.address)}),r(ie,{"data-testid":"row-company-name",icon:"applicantInfographic",narrowLabel:"Name",darkText:!0,children:Z(s==null?void 0:s.name)})]}):S(Y,{children:[r(ie,{"data-testid":"row-company-name",icon:"applicantInfographic",narrowLabel:"Name",darkText:!0,children:Z(s==null?void 0:s.name)}),r(ie,{"data-testid":"row-company-address",icon:"houseInfographic",narrowLabel:`${t==="property"?"Property ":"Company "}Address`,darkText:!0,narrowIsFullWidth:!0,children:ce(t==="property"?(D=s==null?void 0:s.metadata)==null?void 0:D.propertyAddress:s==null?void 0:s.address)})]}),r(ie,{"data-testid":"row-company-types",icon:"flatInfographic",narrowLabel:"Company Type",darkText:!0,children:Z(xe(To(s,c)))}),r(ie,{"data-testid":"row-company-contact-details",icon:"phoneInfographic",onClick:B=>{p(v)?(B.stopPropagation(),F(()=>f(v,"mobile"))):p(s==null?void 0:s.email)&&(B.stopPropagation(),F(()=>g.openModal()))},narrowLabel:p(v)?"Business Phone":p(s==null?void 0:s.email)?"Email":"Contact Details",darkText:!0,children:Z(v??(s==null?void 0:s.email))}),r(ie,{"data-testid":"row-company-office-key-contact",icon:"shieldInfographic",narrowLabel:p(C)?u==="office"?"Office":"Key Contact":"Office/Key Contact",darkText:!0,children:Z(C)})]}):S(bt,{children:[y||N?S(Y,{children:[r(ie,{"data-testid":"row-contact-address",icon:"houseInfographic",narrowLabel:`${t==="property"?"Property ":"Contact "}Address`,narrowIsFullWidth:!0,children:ce(t==="property"?(J=s==null?void 0:s.metadata)==null?void 0:J.propertyAddress:s==null?void 0:s.primaryAddress)}),r(ie,{"data-testid":"row-contact-name",icon:"applicantInfographic",narrowLabel:"Name",darkText:!0,children:Ae(s==null?void 0:s.title,s==null?void 0:s.forename,s==null?void 0:s.surname)})]}):S(Y,{children:[r(ie,{"data-testid":"row-contact-name",icon:"applicantInfographic",narrowLabel:"Name",darkText:!0,children:Ae(s==null?void 0:s.title,s==null?void 0:s.forename,s==null?void 0:s.surname)}),r(ie,{"data-testid":"row-contact-address",icon:"houseInfographic",narrowLabel:`${t==="property"?"Property ":"Contact "}Address`,narrowIsFullWidth:!0,children:ce(t==="property"?(W=s==null?void 0:s.metadata)==null?void 0:W.propertyAddress:s==null?void 0:s.primaryAddress)})]}),r(ie,{"data-testid":"row-contact-contact-details",icon:"phoneInfographic",onClick:B=>{p(s==null?void 0:s.mobilePhone)?(B.stopPropagation(),F(()=>f(s==null?void 0:s.mobilePhone,"mobile"))):p(s==null?void 0:s.email)&&(B.stopPropagation(),F(()=>g.openModal()))},narrowLabel:p(s==null?void 0:s.mobilePhone)?"Mobile Phone":p(s==null?void 0:s.email)?"Email":"Contact Details",darkText:!0,children:Z((s==null?void 0:s.mobilePhone)??(s==null?void 0:s.email))}),r(ie,{"data-testid":"row-contact-office-key-contact",icon:"shieldInfographic",narrowLabel:p(C)?u==="office"?"Office":"Key Contact":"Office/Key Contact",darkText:!0,children:Z(C)}),r(ie,{"data-testid":"row-contact-active-roles",icon:"listInfographic",narrowLabel:"Active Roles",darkText:!0,children:Z(xe(bo(s,c)??[]))})]})},s.id)})]}),r(m,{}),r(gt,{modalInstance:g,onConfirmCallback:l}),r(yt,{ModalInstance:d,message:"Do you want to record this action to the Journal ?",ctaMessage:"Yes",title:"",ctaIntent:"primary",ctaConfirmFn:()=>n(`/${o}/${I}/view?createJournal=true`)})]})},po=()=>{var J,W,B,R,H,ae,K,oe,X,fe,Fe,he,ue,ee;const{params:e,encodeParamsAndAssignToURL:o}=Rn({replace:!1}),{register:t,watch:i,formState:{errors:n},trigger:a,setValue:c}=lt({defaultValues:{searchType:Be(e.searchType,"searchType"),searchSource:Be(e.searchSource,"searchSource")},resolver:$t(go),mode:"all"}),g=St(e==null?void 0:e.q,e==null?void 0:e.searchType),[d,I]=L.useState(null),{searchInput:T,searchType:m,searchSource:f}=i(),y=async G=>{const de=i("searchType"),Ie=i("searchSource"),{value:pe,name:ge}=G.target,Ce=ge==="searchInput"?pe:T,P=ge==="searchType"?pe:de,O=ge==="searchSource"?pe:Ie;ge==="searchType"&&await a("searchInput");const M=St(Ce,P);I(M?{...M}:null),o({q:Ce,searchType:P,searchSource:O})};L.useEffect(()=>{const G={q:e.q??"",searchType:m,searchSource:f};o(G)},[]),L.useEffect(()=>{const G={searchInput:e.q,searchType:Be(e.searchType,"searchType"),searchSource:Be(e.searchSource,"searchSource")};Object.entries(G).map(([de,Ie])=>c(de,Ie,{shouldValidate:!0})),I(g?{...g}:null)},[e]);const{isLoading:N,isFetching:b,data:h,isFetched:l,fetchStatus:s,fetchNextPage:u,isFetchingNextPage:C,hasNextPage:v}=ao({type:m==="property"?"property":f==="contact"?"contact":"company",queryParams:(Object.hasOwn(d??{},"email")?{contactDetail:[T]}:d)??{},sourceData:f}),F=((h==null?void 0:h.pages.length)??0)>=5,U=!p(h==null?void 0:h.pages.flatMap(G=>G==null?void 0:G._embedded)),A=m==="property"?(((W=(J=h==null?void 0:h.pages)==null?void 0:J[0])==null?void 0:W.pageCount)??0)>=5&&((h==null?void 0:h.pages.length)??0)>=5||(((R=(B=h==null?void 0:h.pages)==null?void 0:B[0])==null?void 0:R.pageCount)??0)===((h==null?void 0:h.pages.length)??0)?U:!1:U,{ref:_,inView:D}=qn();return L.useEffect(()=>{D&&!C&&!F&&u()},[D,C,b,F]),S(Y,{children:[r(He,{children:"Contacts List"}),r("form",{children:S(rt,{className:at,children:[S(_e,{children:[r(Oe,{...t("searchInput",{onChange:L.useMemo(()=>k.debounce(G=>{y(G)},to),[])}),label:`Search ${ot.TYPE[m]}`,type:"search",icon:"searchSystem",placeholder:m==="property"?"Search address":"Search name, email, or phone number","data-testid":"contact-look-up-search-input"}),r(Je,{message:(H=n.searchInput)==null?void 0:H.message})]}),S(_e,{children:[r(qe,{children:"Search Type"}),r(It,{...t("searchType",{onChange:y}),hasGreyBg:!0,options:Object.entries(ot.TYPE).map(([G,de])=>({id:`option-${G}`,value:G,text:de,isChecked:G===m})),"data-testid":"contact-look-up-search-type-options"})]}),S(_e,{children:[r(qe,{children:"Record Type"}),r(It,{...t("searchSource",{onChange:y}),hasGreyBg:!0,options:Object.entries(ot.SOURCE).map(([G,de])=>({id:`option-${G}`,value:G,text:de,isChecked:G===f})),"data-testid":"contact-look-up-search-source-options"})]})]})}),s==="idle"&&!l?r(Y,{}):b&&!C||N?r(te,{"data-testid":"initiation-loader",className:"el-mt8 el-mb10"}):A?r(be,{"data-testid":"not-found-notification",className:"el-mt8",isExpanded:!0,intent:"default",isInline:!0,isFullWidth:!0,children:"No result!"}):p(h==null?void 0:h.pages)&&S(Y,{children:[r(Io,{searchSource:f,type:m==="property"?"property":f==="contact"?"contact":"company",data:(h==null?void 0:h.pages)??[],isAddressSearchFetching:m==="property"?((K=(ae=h==null?void 0:h.pages)==null?void 0:ae[0])==null?void 0:K.totalPageCount)!==((oe=h==null?void 0:h.pages)==null?void 0:oe.length)?(((fe=(X=h==null?void 0:h.pages)==null?void 0:X[0])==null?void 0:fe.totalPageCount)??0)>=5?(((Fe=h==null?void 0:h.pages)==null?void 0:Fe.length)??0)<5:(((ue=(he=h==null?void 0:h.pages)==null?void 0:he[0])==null?void 0:ue.totalPageCount)??0)>=(((ee=h==null?void 0:h.pages)==null?void 0:ee.length)??0):b:!1}),F&&r(be,{"data-testid":"search-refining-notification",className:"el-mt8",isExpanded:!0,intent:"default",isInline:!0,isFullWidth:!0,children:"Consider refining your search for more accurate results"}),!F&&v&&r("div",{ref:_,className:"el-mt8 el-mb10",children:r(te,{"data-testid":"fetch-next-page-loader"})})]})]})},Xe=e=>Gn({staleTime:1e3*60*60,...e,queryParams:{type:Bt}}),Co=()=>{const[,,{isLoading:e}]=Xe();return e?r(te,{fullPage:!0,"data-testid":"dependencies-data-loader"}):r(po,{})},en=({id:e,type:o})=>{const t=Ye(),[i,n]=L.useState(null),[a,c]=L.useState({id:[],landlordId:[]}),[g,d,{isLoading:I,isError:T,isFetching:m},f]=Po({id:e,type:o}),y=k.find(f,{type:"applicant"}),[N,,b,{isLoading:h,isError:l}]=Vn({onSuccess:E=>{t.setQueryData(q.APPLICANT.paginated({pageNumber:E==null?void 0:E.pageNumber,id:y==null?void 0:y.id}),E)}});L.useEffect(()=>{Pe({fetchFn:N,latestData:b,isLoading:h,isError:l,params:{id:y==null?void 0:y.id,pageNumber:(b==null?void 0:b.pageNumber)??1}})},[y,b]);const s=k.find(f,{type:"vendor"}),[u,,C,{isLoading:v,isError:F}]=Wt({onSuccess:E=>{t.setQueryData(q.VENDOR.paginated({pageNumber:E==null?void 0:E.pageNumber,id:s==null?void 0:s.id}),E)}});L.useEffect(()=>{Pe({fetchFn:u,latestData:C,isLoading:v,isError:F,params:{id:s==null?void 0:s.id,pageNumber:(C==null?void 0:C.pageNumber)??1}})},[s,C]);const U=k.find(f,{type:"landlord"}),[A,,_,{isLoading:D,isError:J}]=Dt({onSuccess:E=>{t.setQueryData(q.LANDLORD.paginated({pageNumber:E==null?void 0:E.pageNumber,id:U==null?void 0:U.id}),E)}});L.useEffect(()=>{Pe({fetchFn:A,latestData:_,isLoading:D,isError:J,params:{id:U==null?void 0:U.id,pageNumber:(_==null?void 0:_.pageNumber)??1}})},[U,_]);const W=k.find(f,{type:"offer"}),[B,,R,{isLoading:H,isError:ae}]=Hn({onSuccess:E=>{t.setQueryData(q.OFFER.paginated({pageNumber:E==null?void 0:E.pageNumber,id:W==null?void 0:W.id}),E)}});L.useEffect(()=>{Pe({fetchFn:B,latestData:R,isLoading:H,isError:ae,params:{id:W==null?void 0:W.id,pageNumber:(R==null?void 0:R.pageNumber)??1}})},[W,R]);const K=k.find(f,{type:"tenancy"}),[oe,,X,{isLoading:fe,isError:Fe}]=Zn({onSuccess:E=>{t.setQueryData(q.TENANCY.paginated({pageNumber:E==null?void 0:E.pageNumber,id:K==null?void 0:K.id}),E)}});L.useEffect(()=>{Pe({fetchFn:oe,latestData:X,isLoading:fe,isError:Fe,params:{id:K==null?void 0:K.id,pageNumber:(X==null?void 0:X.pageNumber)??1}})},[K,X]);const he=L.useMemo(()=>Ne({queryClient:t,queryParams:{id:y==null?void 0:y.id},latestData:b,QUERY_KEYS:"APPLICANT"}),[b,h]);L.useEffect(()=>{var E;if(!h&&b&&((E=b==null?void 0:b._embedded)!=null&&E.length)){const me=So(he);n(me)}},[b]);const[ue,,ee,{isLoading:G,isError:de}]=Xn({onSuccess:E=>{t.setQueryData(q.AREA.paginated({pageNumber:E.pageNumber,id:i}),E)}});L.useEffect(()=>{Pe({fetchFn:ue,latestData:ee,isLoading:G,isError:de,params:{id:i,pageNumber:(ee==null?void 0:ee.pageNumber)??1}})},[i,ee]);const Ie=L.useMemo(()=>Ne({queryClient:t,queryParams:{id:s==null?void 0:s.id},latestData:C,QUERY_KEYS:"VENDOR"}),[C,v]),pe=L.useMemo(()=>Ne({queryClient:t,queryParams:{id:U==null?void 0:U.id},latestData:_,QUERY_KEYS:"LANDLORD"}),[_,D]),ge=L.useMemo(()=>Ne({queryClient:t,queryParams:{id:W==null?void 0:W.id},latestData:R,QUERY_KEYS:"OFFER"}),[R,H]),Ce=L.useMemo(()=>Ne({queryClient:t,queryParams:{id:K==null?void 0:K.id},latestData:X,QUERY_KEYS:"TENANCY"}),[X,fe]);L.useEffect(()=>{var me,ye,ke,Le;if(!(v||D||H||fe)&&((me=C==null?void 0:C._embedded)!=null&&me.length||(ye=_==null?void 0:_._embedded)!=null&&ye.length||(ke=R==null?void 0:R._embedded)!=null&&ke.length||(Le=X==null?void 0:X._embedded)!=null&&Le.length)){const sn=Lo({vendorsData:Ie,landlordsData:pe,offersData:ge,tenanciesData:Ce});c(sn)}},[C,_,R,X]);const[P,,O,{isLoading:M,isError:w}]=Ke({onSuccess:E=>{t.setQueryData(q.PROPERTY.paginated({pageNumber:E==null?void 0:E.pageNumber,id:a==null?void 0:a.id}),E)}});L.useEffect(()=>{Pe({fetchFn:P,latestData:O,isLoading:M,isError:w,params:{id:a==null?void 0:a.id,pageNumber:(O==null?void 0:O.pageNumber)??1}})},[a,O]);const[V,,x,{isLoading:$,isError:z}]=Ke({onSuccess:E=>{t.setQueryData(q.PROPERTY.paginated({pageNumber:E==null?void 0:E.pageNumber,landlordId:a==null?void 0:a.landlordId}),E)}});L.useEffect(()=>{Pe({fetchFn:V,latestData:x,isLoading:$,isError:z,params:{landlordId:a==null?void 0:a.landlordId,pageNumber:(x==null?void 0:x.pageNumber)??1}})},[a,x]);const Q=L.useMemo(()=>Ne({queryClient:t,queryParams:{id:i},latestData:ee,QUERY_KEYS:"AREA"}),[ee,G]),se=L.useMemo(()=>Ne({queryClient:t,queryParams:{id:a==null?void 0:a.id},latestData:O,QUERY_KEYS:"PROPERTY"}),[O,M]),j=L.useMemo(()=>Ne({queryClient:t,queryParams:{landlordId:a==null?void 0:a.landlordId},latestData:x,QUERY_KEYS:"PROPERTY"}),[x,$]);return{isHasRelationships:g,isLoading:I,isError:T,isFetching:m,error:d,associatesData:{vendor:{isLoading:s&&M||v,data:Ie},landlord:{isLoading:U&&M||$||D,data:pe},applicant:{isLoading:y&&M||h,data:he},tenancy:{isLoading:G||fe,data:Ce},offer:{isLoading:W&&M||H,data:ge}},areasData:Q,propertiesData:se,propertiesDataForLandlords:j}},Pe=({fetchFn:e,latestData:o,isLoading:t,isError:i,params:n})=>{var a,c;if(((a=n.id)!=null&&a.length||(c=n==null?void 0:n.landlordId)!=null&&c.length)&&!t&&!i){if(!(o!=null&&o.pageNumber))return e({...n});if(o!=null&&o.pageNumber&&(o!=null&&o.totalPageCount)&&(o==null?void 0:o.pageNumber)<(o==null?void 0:o.totalPageCount))return e({...n,pageNumber:(n==null?void 0:n.pageNumber)+1})}},Ne=({queryClient:e,queryParams:o,latestData:t,QUERY_KEYS:i})=>{const n=t==null?void 0:t.totalPageCount,a=[];if(n===1)return t==null?void 0:t._embedded;if(n>1)for(let c=1;c<=n;c++){const g=q[i].paginated({pageNumber:c,...o}),d=e.getQueryData(g);d!=null&&d._embedded&&a.push(...d._embedded)}return a},Po=({id:e,type:o})=>{const[t,i]=L.useState([]),[n,a]=L.useState([]),[c,g]=L.useState(1),[d,I,{isLoading:T,isError:m,isFetching:f}]=ft(e,{queryParams:{pageNumber:c},fetchWhenTrue:[e&&o==="contact"]}),[y,N,{isLoading:b,isError:h,isFetching:l}]=mt(e,{queryParams:{pageNumber:c},fetchWhenTrue:[e&&o==="company"]});return L.useEffect(()=>{var u;const s=o==="contact"?d:y;if(s!=null&&s.pageNumber&&(s!=null&&s.totalPageCount)&&s.pageNumber<s.totalPageCount&&g((s==null?void 0:s.pageNumber)+1),(u=s==null?void 0:s._embedded)!=null&&u.length&&a(C=>[...C,...s._embedded]),c===(s==null?void 0:s.totalPageCount)&&(s!=null&&s._embedded)){const C=No([...n,...s._embedded]);i(C)}},[d,y,o]),[!!(d!=null&&d.totalCount||y!=null&&y.totalCount),N||I,{isLoading:T||b,isError:m||h,isFetching:f||l},t]},No=e=>{const o=[];return e.map(t=>{if(k.find(o,{type:t==null?void 0:t.associatedType})){const n=k.findIndex(o,["type",t==null?void 0:t.associatedType]),a=o[n].id;o[n].id=[...a,t==null?void 0:t.associatedId]}else o.push({id:[t==null?void 0:t.associatedId],type:t==null?void 0:t.associatedType})}),o},So=e=>{const o=[];return e!=null&&e.length&&e.map(t=>{var i;(t==null?void 0:t.locationType)==="areas"&&(i=t==null?void 0:t.locationOptions)!=null&&i.length&&o.push(...t.locationOptions)}),o!=null&&o.length?k.uniq(o):null},Lo=({vendorsData:e,landlordsData:o,offersData:t,tenanciesData:i})=>{const n={id:[],landlordId:[]};return e!=null&&e.length&&e.map(a=>{a!=null&&a.propertyId&&n.id.push(a==null?void 0:a.propertyId)}),o!=null&&o.length&&o.map(a=>{n.landlordId.push(a==null?void 0:a.id)}),t!=null&&t.length&&t.map(a=>{a!=null&&a.propertyId&&n.id.push(a==null?void 0:a.propertyId)}),i!=null&&i.length&&i.map(a=>{a!=null&&a.propertyId&&n.id.push(a==null?void 0:a.propertyId)}),{id:k.uniq(n==null?void 0:n.id),landlordId:k.uniq(n==null?void 0:n.landlordId)}},ne=(e=0,o)=>{const{removeDecimal:t=!1}=o??{},i=t?Number(e.toFixed(0)):e,n=i!==Math.floor(i);return Intl.NumberFormat("en-GB",{currency:"GBP",style:"currency",minimumFractionDigits:n?0:void 0,maximumFractionDigits:n?2:0}).format(i)},tn=e=>{var a,c,g,d,I,T,m,f;let o="0",t="0",i,n;if(e.marketingMode==="buying"?(i=(a=e==null?void 0:e.buying)==null?void 0:a.priceFrom,n=(c=e==null?void 0:e.buying)==null?void 0:c.priceTo,o=ne((g=e==null?void 0:e.buying)==null?void 0:g.priceFrom),t=ne((d=e==null?void 0:e.buying)==null?void 0:d.priceTo)):(i=(I=e==null?void 0:e.renting)==null?void 0:I.rentFrom,n=(T=e==null?void 0:e.renting)==null?void 0:T.rentTo,o=ne((m=e==null?void 0:e.renting)==null?void 0:m.rentFrom),t=ne((f=e==null?void 0:e.renting)==null?void 0:f.rentTo)),i&&n)return`${o} to ${t}`;if(!i&&n)return`Up to ${t}`;if(i&&!n)return`From ${o}`;if(!i&&!n)return`${o}`},vo=(e,o)=>{const{min:t,max:i}={receptions:{min:(e==null?void 0:e.receptionsMin)??0,max:(e==null?void 0:e.receptionsMax)??0},bathrooms:{min:(e==null?void 0:e.bathroomsMin)??0,max:(e==null?void 0:e.bathroomsMax)??0},bedrooms:{min:(e==null?void 0:e.bedroomsMin)??0,max:(e==null?void 0:e.bedroomsMax)??0}}[o];if(t&&i&&t!==i)return`${t} to ${i}`;if(t&&i&&t===i)return`${i}`;if(!t&&i)return`Up to ${i}`;if(t&&!i)return`${t}+`},Eo=(e,o)=>{var t,i;if((e==null?void 0:e.locationType)==="addresses")return(t=e==null?void 0:e.locationOptions)==null?void 0:t[0];{if(!(o!=null&&o.length)||!((i=e==null?void 0:e.locationOptions)!=null&&i.length))return;const n=e.locationOptions.map(a=>{const c=k.find(o,{id:a});return c==null?void 0:c.name});return xe(n)}},Oo=({associatesData:e,areasData:o,propertiesData:t,propertiesDataForLandlords:i})=>{var T,m,f,y,N;const n=[],{applicant:a,offer:c,landlord:g,tenancy:d,vendor:I}=e;if(a.isLoading||a!=null&&a.data&&((T=a==null?void 0:a.data)!=null&&T.length)){const{data:b,isLoading:h}=a;n.push({title:"Applicants",titleItems:[S(Y,{children:[r(Te,{icon:"listInfographic"}),b==null?void 0:b.length]})],content:h?r(te,{}):b==null?void 0:b.map(l=>r(Se,{hasGreyText:!0,"data-testid":"single-aplicant-active",children:Ao({applicant:l,areasData:o})},l.id))})}if(c.isLoading||c!=null&&c.data&&((m=c==null?void 0:c.data)!=null&&m.length)){const{data:b,isLoading:h}=c;n.push({title:"Offers",titleItems:[S(Y,{children:[r(Te,{icon:"listInfographic"}),b==null?void 0:b.length]})],content:h?r(te,{}):b==null?void 0:b.map(l=>r(Se,{hasGreyText:!0,"data-testid":"single-offer-active",children:Fo({offer:l,propertiesData:t})},l.id))})}if(g.isLoading||g!=null&&g.data&&((f=g==null?void 0:g.data)!=null&&f.length)){const{data:b,isLoading:h}=g,l=(t==null?void 0:t.filter(u=>u.marketingMode==="sellingAndLetting"))??[],s=k.uniqBy([...l,...i],u=>u.id);n.push({title:"Landlord",titleItems:[S(Y,{children:[r(Te,{icon:"listInfographic"}),s==null?void 0:s.length]})],content:h?r(te,{}):s==null?void 0:s.map(u=>r(Se,{hasGreyText:!0,"data-testid":"single-landlord-active",children:Lt({ownerType:"landlord",property:u,landlordsData:b})},u.id))})}if(d.isLoading||d!=null&&d.data&&((y=d==null?void 0:d.data)!=null&&y.length)){const{data:b,isLoading:h}=d;n.push({title:"Tenancies",titleItems:[S(Y,{children:[r(Te,{icon:"listInfographic"}),b==null?void 0:b.length]})],content:h?r(te,{}):b==null?void 0:b.map(l=>r(Se,{hasGreyText:!0,"data-testid":"single-tenancy-active",children:wo({propertiesData:t,tenancy:l})},l.id))})}if(I.isLoading||I!=null&&I.data&&((N=I==null?void 0:I.data)!=null&&N.length)){const{data:b,isLoading:h}=I;n.push({title:"Vendor",titleItems:[S(Y,{children:[r(Te,{icon:"listInfographic"}),b==null?void 0:b.length]})],content:h?r(te,{}):b==null?void 0:b.map(l=>{const s=t.find(u=>u.id===(l==null?void 0:l.id));return r(Se,{hasGreyText:!0,"data-testid":"single-vendor-active",children:Lt({ownerType:"vendor",property:s})},l.id)})})}return n},Ao=({applicant:e,areasData:o})=>{var m;const t=Eo(e,o),i=k.capitalize(e==null?void 0:e.locationType),n=i&&t?`${i}: ${t}`:null,a=vo(e,"bedrooms"),c=tn(e),g=Tt[(m=e==null?void 0:e.renting)==null?void 0:m.rentFrequency],I=[g?`${c} per ${g}`:c,a?`${a} Bedrooms`:void 0,n],T=e!=null&&e.active?"success":"danger";return S(Y,{children:[r(Qe,{"data-testid":"single-offer-status-indicator",intent:T}),S("span",{"data-testid":"single-applicant-active-content",children:[" ",xe(I)," "]})]})},Fo=({offer:e,propertiesData:o})=>{const t=[["success",["accepted"]],["pending",["pending","noteOfInterest"]],["warning",["rejected"]],["danger",["withdrawn","noteOfInterestWithdrawn"]]],i=o.find(d=>d.id===(e==null?void 0:e.propertyId)),n=Z(no[e==null?void 0:e.status],"Unknown Status"),a=ne(e.amount,{removeDecimal:!0}),c=ce(k.pick(i==null?void 0:i.address,["buildingName","buildingNumber","line1","line2","postcode"])),g=ze(e==null?void 0:e.status,t);return S(Y,{children:[r(Qe,{"data-testid":"single-offer-status-indicator",intent:g??"default"}),S("span",{"data-testid":"single-offer-active-content",children:[" ",`${n} - ${a} for ${c}`," "]})]})},Lt=({property:e,ownerType:o,landlordsData:t})=>{var f,y,N,b,h,l,s;if(!e)return;const i=[["neutral",["withdrawn","provisional","tenancyCurrentUnavailable","tenancyFinished","tenancyCancelled","sold","letByOtherAgent","letPrivately"]],["success",["toLet","arrangingTenancyUnavailable","arrangingTenancy","tenancyCurrent","underOfferUnavailable","underOffer"]],["pending",["valuation"]],["warning",["toLetUnavailable"]]],n=[["neutral",["exchanged","completed","withdrawn","soldExternally"]],["success",["forSale","underOffer","underOfferUnavailable"]],["pending",["valuation","paidValuation"]],["warning",["forSaleUnavailable","reserved"]],["default",["preAppraisal"]]],a=t!=null&&t.length?t.find(u=>{var C;return(u==null?void 0:u.id)===((C=e==null?void 0:e.letting)==null?void 0:C.landlordId)}):null,c=ce(k.pick(e==null?void 0:e.address,["buildingName","buildingNumber","line1","line2","postcode"])),g=o==="vendor"?ne((f=e==null?void 0:e.selling)==null?void 0:f.price,{removeDecimal:!0}):ne((y=e==null?void 0:e.letting)==null?void 0:y.rent,{removeDecimal:!0}),d=o==="vendor"?Z(jt[(N=e==null?void 0:e.selling)==null?void 0:N.status],"Unknown Status"):Z(Jt[(b=e==null?void 0:e.letting)==null?void 0:b.status],"Unknown Status"),I=o==="vendor"?ze((h=e==null?void 0:e.selling)==null?void 0:h.status,n):a!=null&&a.active?ze((l=e==null?void 0:e.letting)==null?void 0:l.status,i):"danger",T=Tt[(s=e==null?void 0:e.letting)==null?void 0:s.rentFrequency],m=T?`${g} per ${T}`:g;return S(Y,{children:[r(Qe,{"data-testid":`single-${o}-status-indicator`,intent:I??"default"}),r("span",{"data-testid":`single-${o}-active-content`,children:`${c}, ${o==="vendor"?g:m} - ${d}`})]})},wo=({tenancy:e,propertiesData:o})=>{const t=[["neutral",["offerWithdrawn","finished"]],["success",["current"]],["pending",["offerPending","arranging"]],["warning",["offerRejected"]],["danger",["cancelled"]]],i=o.find(T=>T.id===(e==null?void 0:e.propertyId)),n=ce(k.pick(i==null?void 0:i.address,["buildingName","buildingNumber","line1","line2","postcode"])),a=ne(e.rent,{removeDecimal:!0}),c=Tt[e==null?void 0:e.rentFrequency],g=c?`${a} per ${c}`:a,d=Z(oo[e==null?void 0:e.status],"Unknown Status"),I=ze(e==null?void 0:e.status,t);return S(Y,{children:[r(Qe,{"data-testid":"single-tenancy-status-indicator",intent:I??"default"}),S("span",{"data-testid":"single-tenancy-active-content",children:[`${d} for ${n}, ${g}`," "]})]})},ze=(e,o)=>k.compact(o.map(([i,n])=>n.includes(e)&&i))[0],nn=({entityId:e,type:o})=>{const{isMobile:t,isTablet:i}=At(),{isHasRelationships:n,isLoading:a,isFetching:c,isError:g,error:d,associatesData:I,areasData:T,propertiesData:m,propertiesDataForLandlords:f}=en({id:e,type:o}),y=L.useMemo(()=>Oo({associatesData:I,areasData:T,propertiesData:m,propertiesDataForLandlords:f}),[I,T,m,f]);return S("div",{className:"el-mt8 el-mb4",children:[r(dn,{"data-testid":"active-roles-pane-title",children:"Active Roles"}),c||a?r(te,{}):g?r(be,{"data-testid":"active-roles-pane-error-notification",isExpanded:!0,isFullWidth:t||i,intent:"danger",children:(d==null?void 0:d.readableMessage)||Mn.DEFAULT}):n&&y.length?r(it,{"data-testid":"active-roles-pane-accordion-container",items:y}):r(be,{"data-testid":"active-roles-pane-not-found-notification",className:"el-mt8",isExpanded:!0,intent:"default",isInline:!0,isFullWidth:t||i,children:"No Data Found!"})]})},_o=(e,o,t,i,n,a)=>{var h,l,s;const{name:c,negotiatorIds:g,supplierTypeId:d,address:I,officeIds:T,email:m,typeIds:f}=e,y=(l=(h=e.additionalContactDetails)==null?void 0:h.find(u=>u.type==="Business"))==null?void 0:l.value,N=[{key:"Company Name",iconName:"companySystem",intent:"primary",conditional:p(c),value:r(re,{children:c})},{key:"Offices",iconName:"authenticationSystem",intent:"primary",conditional:p(o)&&p(T),value:r(Y,{children:T==null?void 0:T.map(u=>{var C,v;return r(re,{children:((v=(C=o==null?void 0:o._embedded)==null?void 0:C.find(F=>F.id===u))==null?void 0:v.name)??""},u)})})},{key:"Company Type",iconName:"settingsSystem",conditional:p(f)&&p(i==null?void 0:i.supplierTypes),value:r(re,{children:f==null?void 0:f.map(u=>{var C,v;return((v=(C=i==null?void 0:i.companyTypes)==null?void 0:C.find(F=>F.id===u))==null?void 0:v.value)??""}).join(", ")})},{key:"Supplier Type",iconName:"settingsSystem",conditional:p(d)&&p(i==null?void 0:i.supplierTypes),value:r(Y,{children:(s=d==null?void 0:d.split(","))==null?void 0:s.map(u=>{var C,v;return r(re,{children:((v=(C=i==null?void 0:i.supplierTypes)==null?void 0:C.find(F=>F.id===u))==null?void 0:v.value)??""},u)})})},{key:"Email",iconName:"emailSystem",intent:"primary",conditional:p(m),value:r(re,{onClick:u=>{u.stopPropagation(),a()},children:m})},{key:"Business Phone",iconName:"phoneSystem",intent:"primary",conditional:p(y),value:r(re,{onClick:()=>n(y,"mobile"),children:y})},{key:"Primary Address",iconName:"homeSystem",intent:"primary",conditional:p(I),value:r(re,{children:ce(I)})},{key:"Negotiators",iconName:"authenticationSystem",intent:"primary",conditional:p(g)&&p(t),value:r(Y,{children:g==null?void 0:g.map(u=>{var C,v;return r(re,{children:((v=(C=t==null?void 0:t._embedded)==null?void 0:C.find(F=>F.id===u))==null?void 0:v.name)??""},u)})})}],b=[];return N.forEach(({key:u,conditional:C,value:v,iconName:F})=>{C&&b.push({key:u,value:v,iconName:F})}),b},Ro=({data:e,createJournalEntryRef:o})=>{const{id:t,negotiatorIds:i,officeIds:n}=e,a=Me("root"),c=Me("root"),g=Ve(u=>u.storeDraftedMessage),{PhoneContactModal:d,openPhoneContactModal:I}=ht({onActionClick:(u,C)=>{g(C.message),a.openModal()},isUsingDraftModal:!0}),[T,,{isLoading:m}]=Gt({queryParams:{id:i},fetchWhenTrue:[i==null?void 0:i.length]}),[f,,{isLoading:y}]=Qt({queryParams:{id:n},fetchWhenTrue:[n==null?void 0:n.length]}),[N,,{isLoading:b}]=Xe();if(!e)return null;if(b||y||m)return r(te,{});const l=u=>{g(u),window.open(`mailto:${e.email}?body=${u}`),a.openModal()},s=()=>{var u;(u=o==null?void 0:o.current)==null||u.openDrawer()};return S("div",{className:"el-pb12",children:[r(Ft,{hasGrid:!0,items:_o(e,f,T,N,I,c.openModal)}),r(d,{}),r(gt,{modalInstance:c,onConfirmCallback:l}),r(yt,{ModalInstance:a,message:"Do you want to record this action to the Journal ?",ctaMessage:"Yes",title:"",ctaIntent:"primary",ctaConfirmFn:s}),r(nn,{entityId:t,type:"company"})]})},Mo=(e,o,t,i,n)=>{const{title:a,forename:c,surname:g,negotiatorIds:d,primaryAddress:I,officeIds:T,mobilePhone:m,email:f}=e??{},y=[{key:"Contact Name",iconName:"usernameSystem",intent:"primary",conditional:!0,value:r(re,{children:Ae(a,c,g)})},{key:"Primary Address",iconName:"homeSystem",intent:"primary",conditional:p(I),value:r(re,{children:ce(I)})},{key:"Mobile Phone",iconName:"phoneSystem",intent:"primary",conditional:p(m),value:r(re,{onClick:()=>i(m,"mobile"),children:m})},{key:"Email",iconName:"emailSystem",intent:"primary",conditional:p(f),value:r(re,{onClick:b=>{b.stopPropagation(),n()},children:f})},{key:"Negotiators",iconName:"authenticationSystem",intent:"primary",conditional:p(d)&&p(t),value:r(Y,{children:d==null?void 0:d.map(b=>{var h,l;return r(re,{children:((l=(h=t==null?void 0:t._embedded)==null?void 0:h.find(s=>s.id===b))==null?void 0:l.name)??""},b)})})},{key:"Offices",iconName:"authenticationSystem",intent:"primary",conditional:p(o)&&p(T),value:r(Y,{children:T==null?void 0:T.map(b=>{var h,l;return r(re,{children:((l=(h=o==null?void 0:o._embedded)==null?void 0:h.find(s=>s.id===b))==null?void 0:l.name)??""},b)})})}],N=[];return y.forEach(({key:b,conditional:h,value:l,iconName:s})=>{h&&N.push({key:b,value:l,iconName:s})}),N},xo=({data:e,createJournalEntryRef:o})=>{const{id:t,negotiatorIds:i,officeIds:n}=e??{},a=Me("root"),c=Ve(l=>l.storeDraftedMessage),g=Me("root"),{PhoneContactModal:d,openPhoneContactModal:I}=ht({onActionClick:(l,s)=>{c(s.message),a.openModal()},isUsingDraftModal:!0}),[T,,{isLoading:m}]=Gt({queryParams:{id:i},fetchWhenTrue:[i==null?void 0:i.length]}),[f,,{isLoading:y}]=Qt({queryParams:{id:n},fetchWhenTrue:[n==null?void 0:n.length]}),N=m||y,b=()=>{var l;(l=o==null?void 0:o.current)==null||l.openDrawer()},h=l=>{c(l),window.open(`mailto:${e.email}?body=${l}`),a.openModal()};return N?r(te,{}):S("div",{className:"el-pb12",children:[r(Ft,{hasGrid:!0,items:Mo(e,f,T,I,g.openModal)}),r(d,{}),r(gt,{modalInstance:g,onConfirmCallback:h}),r(yt,{ModalInstance:a,message:"Do you want to record this action to the Journal ?",ctaMessage:"Yes",title:"",ctaIntent:"primary",ctaConfirmFn:b}),r(nn,{entityId:t,type:"contact"})]})},ko=(e,o)=>{const t=["activity-feed",o,e],i=Ye(),[n,a]=L.useState(i.getQueryData(t)??[]),[c,g]=L.useState(!1),[d]=Vt(),[I]=Yt({onSuccess:h=>{const l=h;for(const s of l._embedded??[])i.setQueryData(q.NEGOTIATOR.single(s==null?void 0:s.id),s)}}),[T]=Ke(),m=async h=>{g(!0);const s=await qo(h,[{type:o,records:[{associatedId:e,associatedType:o,entries:[]}]}],d,T),u=$o(s,i);p(u)&&await I({id:u,pageSize:100}),i.setQueryData(t,s),a(s),g(!1)},[,,{isFetching:f},{refetch:y}]=ft(e,{fetchWhenTrue:[p(e),o==="contact",!p(n)],onSuccess:m}),[,,{isFetching:N},{refetch:b}]=mt(e,{fetchWhenTrue:[p(e),o==="company",!p(n)],onSuccess:m});return{isLoading:c||f||N,collection:n,sortedEntries:((n==null?void 0:n.flatMap(({records:h})=>h.flatMap(({entries:l})=>l)))??[]).sort((h,l)=>new Date(l.created).getTime()-new Date(h.created).getTime()),refetchEntries:()=>{o==="contact"?y():b()}}},$o=(e,o)=>{if(!p(e)||!o)return[];const t=e.flatMap(({records:i})=>i.flatMap(({entries:n})=>n.map(({negotiatorId:a})=>p(a)?a:"").filter(a=>a!=="")));for(const i of k.uniq([...t])){const n=o.getQueryData(q.NEGOTIATOR.single(i));p(n)&&t.splice(t.indexOf(i),1)}return t},qo=async(e,o,t,i)=>{var y,N,b,h;const n=[...o];for(const l of(e==null?void 0:e._embedded)??[]){const s=n.findIndex(C=>C.type===l.associatedType),u={...l,entries:[]};s===-1?n.push({type:l.associatedType,records:[u]}):n[s].records.find(({associatedId:v})=>v===l.associatedId)||n[s].records.push(u)}await Uo(n,i);const a=n.filter(({type:l})=>l==="applicant"),c=n.filter(({type:l})=>l==="landlord"),g=n.filter(({type:l})=>l==="contact"),d=n.filter(({type:l})=>l==="company"),I=n.filter(({type:l})=>l==="tenancy"),T=n.filter(({type:l})=>l==="worksOrder"),m=n.filter(({type:l})=>l==="vendor"),f=await Promise.all([p(a)?Ee(["applicant",a],t):[],p(c)?Ee(["landlord",c],t):[],p(g)?Ee(["contact",g],t):[],p(d)?Ee(["company",d],t):[],p(m)?Ee(["propertyAndOffer",m],t):[],p(I)?Ee(["tenancy",I],t):[],p(T)?Ee(["worksOrder",T],t):[]]);for(const l of k.uniqWith([...f].flatMap(s=>s),k.isEqual)){if(Do(l,n))continue;if(p(l.propertyId)&&Wo(l)){const C=(y=n.find(F=>F.type==="vendor"))==null?void 0:y.records.find(({associatedId:F})=>F===l.propertyId);if(p(C)){C.entries.push({...l,localFields:{role:"offer"}});continue}const v=(N=n.find(F=>F.type==="applicant"))==null?void 0:N.records.find(({associatedId:F})=>F===l.associatedId);if(p(v)){v.entries.push({...l,localFields:{role:"offer"}});continue}}if(l.associatedType===""){(((h=(b=n.find(v=>v.type==="vendor"))==null?void 0:b.records.find(({associatedId:v})=>v===l.propertyId))==null?void 0:h.entries)??[]).push({...l,localFields:{role:"property"}});continue}const s=n.findIndex(({type:C})=>C===l.associatedType);if(s===-1){n.push({type:l.associatedType,records:[{associatedType:l.associatedType,associatedId:l.associatedId,entries:[{...l,localFields:{role:st(l)?"tenancy":l.associatedType}}]}]});continue}const u=n[s].records.find(({associatedId:C})=>C===l.associatedId);if(!u){n[s].records.push({associatedType:l.associatedType,associatedId:l.associatedId,entries:[{...l,localFields:{role:st(l)?"tenancy":l.associatedType}}]});continue}u==null||u.entries.push({...l,localFields:{role:st(l)?"tenancy":l.associatedType}})}return n},Ee=async(e,o)=>{const[t,i]=e,n=k.uniq(i.flatMap(({records:I})=>I.map(({associatedId:T})=>T)));if(!p(n))return[];let a=[],c=1,g;const d={...t==="propertyAndOffer"?{propertyId:n}:{associatedId:n,associatedType:t},pageSize:100};for(;;){const I=await o({...d,pageNumber:c});if(g=I==null?void 0:I.totalPageCount,c++,!I||(a=[...a,...(I==null?void 0:I._embedded)??[]],(I==null?void 0:I.pageNumber)>=g))break;await new Promise(T=>setTimeout(T,1e3))}return a},Uo=async(e,o)=>{var n;const t=((n=e.find(({type:a})=>a==="landlord"))==null?void 0:n.records.map(({associatedId:a})=>a))??[],i=p(t)?await o({landlordId:t,pageSize:100}):void 0;if(p(i))for(const a of(i==null?void 0:i._embedded)??[]){const c=a.id,g=e.find(({type:d})=>d==="vendor");g?g!=null&&g.records.find(({associatedId:I})=>I===c)||g.records.push({associatedType:"vendor",associatedId:c,entries:[]}):e.push({type:"vendor",records:[{associatedType:"vendor",associatedId:c,entries:[]}]})}},Do=(e,o)=>{if(["MN"].includes(e.typeId))return!0;for(const{records:t}of o)for(const{entries:i}of t)return i.some(n=>(n==null?void 0:n.typeId)===(e==null?void 0:e.typeId)&&(n==null?void 0:n.description)===(e==null?void 0:e.description)&&le(n==null?void 0:n.created).diff(e==null?void 0:e.created,"seconds")<=10);return!1},Wo=e=>["OF","OA","OP","FP","FR","FW","ON","OR","OU","OW"].includes(e.typeId),st=e=>["TA","TX","TF","TC"].includes(e.typeId),Qo=(e,o=1,t=10)=>{const i=(o-1)*t,n=i+t,a=Math.ceil(e.length/t);return{entries:e.slice(i,n),availablePageNumber:a}},Yo=({sortedEntries:e,isFeedLoading:o})=>{var U;const t=Ye(),i=Ge(),n=Ze(),[a,c,g]=wt(),[d,I]=L.useState(null),[T,,{isLoading:m}]=Xe(),[f,y]=L.useState(1),[N,b]=L.useState(!1),h=A=>{I(A),c()},l=()=>{I(null),g()},s=A=>{var D;const _=T==null?void 0:T.journalEntryTypes;return(D=_==null?void 0:_.find(J=>J.id===A))==null?void 0:D.value},u=A=>{var _;return(_=t.getQueryData(q.NEGOTIATOR.single(A)))==null?void 0:_.name},C=A=>{const _=A.localFields.role;return _==="applicant"?"applicantInfographic":_==="property"?"houseInfographic":_==="landlord"?"landlordInfographic":_==="tenancy"?"usernameSystem":_==="offer"?"paymentSystem":_==="company"?"companySystem":_==="worksOrder"?"listInfographic":_==="contact"?"usernameSystem":"placeholderSmall"},{entries:v,availablePageNumber:F}=Qo(e,f);return L.useEffect(()=>{y(1)},[e]),L.useEffect(()=>{const A=setTimeout(()=>{b(!1)},500);return()=>clearTimeout(A)},[f]),S("div",{className:"el-pb12",children:[o||m||N?r(te,{"data-testid":"feeds-dependencies-loader"}):S("div",{className:ln,"data-testid":"activity-feeds-container",children:[p(e)?S(Y,{children:[v.map(A=>{var J;const _=u(A==null?void 0:A.negotiatorId),D=jn({length:5});return r(un,{className:_t("el-my5",k.isEqual(A,d)&&et),onClick:()=>{h(A)},"data-testid":"feed-container",onMouseEnter:W=>W.currentTarget.classList.add(et),onMouseLeave:W=>W.currentTarget.classList.remove(et),children:S(mn,{children:[r(fn,{children:r(Te,{icon:C(A),iconSize:"small","data-testid":"feed-icon"})}),S(hn,{className:gn,children:[r(yn,{"data-testid":"feed-header",children:Z(A==null?void 0:A.description)}),S(Tn,{"data-testid":"feed-sub-header",children:[k.capitalize((J=A==null?void 0:A.localFields)==null?void 0:J.role)," -"," ",Z(s(A==null?void 0:A.typeId))]}),S(bn,{"data-testid":"feed-sub-header-additional",children:[le(A.created).format("DD/MM/YYYY hh:mm A")," ",p(_)&&`by ${_}`]})]})]})},D)}),F>1&&r(In,{callback:A=>{y(A),b(!0)},currentPage:f,numberPages:F})]}):r(be,{isExpanded:!0,isInline:!0,isFullWidth:!0,"data-testid":"feeds-no-activity-notification",children:"No activity to display"}),r(We,{onClick:()=>{i(n.pathname.replace("activity-feed","full-journal"))},className:"el-mt10","data-testid":"full-journal-cta",children:"View Full Journal"})]}),S(a,{onDrawerClose:l,"data-testid":"highlighted-entry-container",title:`${k.capitalize((U=d==null?void 0:d.localFields)==null?void 0:U.role)} - ${s(d==null?void 0:d.typeId)}`,subtitle:le(d==null?void 0:d.created).format("dddd, DD MMMM YYYY hh:mm A"),footerItems:r(Rt,{alignment:"right",children:r(We,{intent:"default",onClick:l,children:"Close"})}),children:[r(pn,{"data-testid":"highlighted-entry-content",children:Z(d==null?void 0:d.description)}),p(u(d==null?void 0:d.negotiatorId))&&S(Se,{hasGreyText:!0,"data-testid":"highlighted-entry-additional-content",children:["Created by ",u(d==null?void 0:d.negotiatorId)]})]})]})},Go=({currentEntity:e,associatesData:o,propertiesData:t,propertiesDataForLandlords:i})=>{const n=[],a=T=>"branch"in T,c=a(e)?"company":"contact";n.push({id:`${c}-${e.id}`,value:`${k.capitalize(c)}: ${a(e)?e==null?void 0:e.name:Ae(e==null?void 0:e.title,e==null?void 0:e.forename,e==null?void 0:e.surname)}`});const{applicant:g,vendor:d,landlord:I}=o;return p(g==null?void 0:g.data)&&g.data.map(T=>{n.push({id:`applicant-${T.id}`,value:Vo({applicant:T})})}),p(d==null?void 0:d.data)&&d.data.map(T=>{const{text:m}=vt({ownerType:"vendor",propertiesData:t,vendor:T});n.push({id:`property-${T.id}`,value:m})}),p(I==null?void 0:I.data)&&I.data.map(T=>{const{text:m,propertyId:f}=vt({ownerType:"landlord",propertiesData:i,landlord:T});n.push({id:`property-${f}`,value:m})}),n},on={weekly:"P/W",monthly:"P/M",annually:"P/A"},vt=({ownerType:e,vendor:o,landlord:t,propertiesData:i})=>{var I,T,m,f,y;const n=e==="vendor"?i.find(N=>N.id===(o==null?void 0:o.id)):i.find(N=>{var b;return((b=N==null?void 0:N.letting)==null?void 0:b.landlordId)===(t==null?void 0:t.id)}),a=ce(k.pick(n==null?void 0:n.address,["buildingName","buildingNumber","line1","line2","postcode"])),c=e==="landlord"?on[(I=n==null?void 0:n.letting)==null?void 0:I.rentFrequency]:void 0,g=ne(e==="vendor"?(T=n==null?void 0:n.selling)==null?void 0:T.price:(m=n==null?void 0:n.letting)==null?void 0:m.rent),d=e==="vendor"?Z(jt[(f=n==null?void 0:n.selling)==null?void 0:f.status],"Unknown Status"):Z(Jt[(y=n==null?void 0:n.letting)==null?void 0:y.status],"Unknown Status");return{text:`Property: ${xe([a,g,c,d])}`,propertyId:n==null?void 0:n.id}},Vo=({applicant:e})=>{var a,c;const o=(a=e==null?void 0:e.related)==null?void 0:a[0],t=(o==null?void 0:o.name)??Ae(o==null?void 0:o.title,o==null?void 0:o.forename,o==null?void 0:o.surname),i=tn(e),n=on[(c=e==null?void 0:e.renting)==null?void 0:c.rentFrequency];return`Applicant: ${xe([t,i,(e==null?void 0:e.marketingMode)==="renting"?n:void 0])}`},Bo=kt().shape({type:Re().trim().required(De.FIELD_REQUIRED),description:Re().trim().required(De.FIELD_REQUIRED),role:Re().trim().required(De.FIELD_REQUIRED)}),jo=L.forwardRef(({entity:e,refetchFeeds:o},t)=>{var D,J,W,B;const{draftedMessage:i,storeDraftedMessage:n}=Ve(),a=Ze(),c=Ge(),{register:g,getValues:d,trigger:I,formState:{errors:T},reset:m,setValue:f}=lt({resolver:$t(Bo),mode:"all"});L.useEffect(()=>{i&&f("description",i)},[i]);const y=xn(),{error:N}=Cn(),[b,,,{isLoading:h}]=Jn({successMessage:"Journal entry created successfully",onError:R=>{if(((R==null?void 0:R.errors)??[]).find(({message:H})=>H.includes("Unsupported typeId"))){N("Failed to create entry due to unsupported entry type");return}N(R==null?void 0:R.readableMessage)}}),{associatesData:l,propertiesData:s,propertiesDataForLandlords:u}=en({id:e.id,type:"branch"in e?"company":"contact"}),[C,v,F]=wt(),U=Go({associatesData:l,propertiesData:s,propertiesDataForLandlords:u,currentEntity:e}),A=async()=>{if(!await I())return;const R=d();if(R.type==="alert")return console.log("alert is not supported yet");const H=await y.connectSession(),[ae,K]=R.role.split("-"),oe=ae==="property";await b({associatedId:oe?void 0:K,associatedType:oe?void 0:ae,description:R.description,typeId:R.type,propertyId:oe?K:void 0,negotiatorId:(H==null?void 0:H.loginIdentity.userCode)??""}),o(),_()};L.useImperativeHandle(t,()=>({openDrawer:v}),[]);const _=()=>{n(null),m(),F(),c(a.pathname,{replace:!0})};return r(C,{title:"New Entry","data-testid":"entry-wrapper",onDrawerClose:_,footerItems:S(Rt,{alignment:"right",children:[r(We,{type:"button",intent:"neutral",onClick:_,"data-testid":"journal-entry-creator-cancel-button",loading:h,disabled:h,children:"Cancel"}),r(We,{type:"button",intent:"primary",onClick:A,"data-testid":"journal-entry-creator-save-button",loading:h,disabled:h,children:"Save"})]}),children:S(rt,{hasMargin:!0,"data-testid":"journal-entry-creator-container",children:[r(tt,{children:S(Oe,{children:[r(qe,{children:"Type"}),S(pt,{...g("type"),"data-testid":"journal-entry-creator-field-type",className:"el-wfull",children:[Object.entries(so).map(([R,H])=>r("option",{value:R,children:H},R)),r("option",{disabled:!0,children:"Alert"})]}),r(Je,{message:((D=T.type)==null?void 0:D.message)??""})]})}),r(tt,{children:S(Oe,{children:[r(qe,{children:"Associated Role"}),r(pt,{...g("role"),"data-testid":"journal-entry-creator-field-role",className:"el-wfull",children:U.map(R=>r("option",{value:R.id,children:R.value},R.id))}),r(Je,{message:((J=T.role)==null?void 0:J.message)??""})]})}),r(tt,{children:S(Oe,{children:[r(qe,{children:"Description"}),r(Pn,{...g("description"),"data-testid":"journal-entry-creator-field-description",hasError:p((W=T==null?void 0:T.description)==null?void 0:W.message)}),r(Je,{message:((B=T.description)==null?void 0:B.message)??""})]})})]})})}),Jo=(e,o,t)=>i=>{if(o){const n=i.target.value;e(`/${t}/${o}/${n}`)}},Ko=({createJournalEntryRef:e})=>{const o=Ge(),t=Ze(),{id:i,sourceType:n}=dt(),{pathname:a,search:c}=t,d=Ve(v=>v.draftedMessage)===null,I=kn.parse(c,{ignoreQueryPrefix:!0}),T=n==="company",[m,,{isLoading:f}]=Ut(i??"",{fetchWhenTrue:[i,!T],queryParams:{embed:["offices","negotiators","source"]}}),[y,,{isLoading:N}]=qt(i??"",{fetchWhenTrue:[i,T],queryKey:q.COMPANY.single(i??"")}),{sortedEntries:b,isLoading:h,refetchEntries:l}=ko(i,T?"company":"contact"),s=L.useMemo(()=>{if(T)return(y==null?void 0:y.name)??"Unknown";{const{title:v,forename:F,surname:U}=m??{};return Ae(v,F,U)}},[T,m,y]),u=f||N,C=u&&(T?!!y:!!m);return L.useEffect(()=>{var v;I.createJournal==="true"&&!d&&((v=e.current)==null||v.openDrawer())},[I,d]),u?r(te,{}):S(Mt,{children:[r(He,{children:s}),C?r(be,{isExpanded:!0,isFullWidth:!0,isInline:!0,intent:"default",children:"Contact not found"}):S(Y,{children:[r(Nn,{isFullWidth:!0,isControlled:!0,name:"app-edit-tabs",onChange:Jo(o,i,n),options:[{id:"view",value:"view",text:"Overview",isChecked:a.includes("view")},{id:"activity-feed",value:"activity-feed",text:"Activity feed",isChecked:a.includes("activity-feed")}]}),r("div",{className:at,children:S(xt,{children:[r(Ue,{path:"view",element:T?r(Ro,{createJournalEntryRef:e,data:y}):r(xo,{createJournalEntryRef:e,data:m})}),r(Ue,{path:"activity-feed",element:r(Yo,{sortedEntries:b,isFeedLoading:h})})]})}),r(jo,{ref:e,entity:T?y:m,refetchFeeds:l})]})]})},Et="DD-MM-YYYY HH:mm",je="YYYY-MM-DD",zo=e=>({LE:"mailInfographic",PR:"houseInfographic"})[e]??"listInfographic",Ho={weekly:"week",monthly:"month",annually:"year"},Zo=e=>{var o,t,i,n,a,c,g;return e.marketingMode==="buying"?`${((o=e.buying)==null?void 0:o.priceFrom)!=0?ne((t=e.buying)==null?void 0:t.priceFrom):"up"} to ${ne((i=e.buying)==null?void 0:i.priceTo)}`:`${((n=e.renting)==null?void 0:n.rentFrom)!=0?ne((a=e.renting)==null?void 0:a.rentFrom):"up"} to ${ne((c=e.renting)==null?void 0:c.rentTo)} per ${Ho[((g=e.renting)==null?void 0:g.rentFrequency)??"week"]}`};le.extend(Kn);le.extend(zn);const Xo=()=>{var Ce;const{id:e,sourceType:o}=dt(),t=o==="company",{register:i,watch:n}=lt({defaultValues:{query:""}}),[a]=Ut(e??"",{fetchWhenTrue:[e,!t],queryParams:{embed:["offices","negotiators","source"]}}),[c]=qt(e??"",{fetchWhenTrue:[e,t]}),g=L.useMemo(()=>{if(t)return(c==null?void 0:c.name)??"Unknown";{const{title:P,forename:O,surname:M}=a??{};return Ae(P,O,M)}},[t,a,c]),[d,I]=L.useState([]),[T,m]=L.useState([]),[f]=Xe({staleTime:1e3*60*60*12}),[y,,{isLoading:N}]=ft(e??"",{fetchWhenTrue:[e,o=="contact"]}),[b,,{isLoading:h}]=mt(e??"",{fetchWhenTrue:[e,o=="company"]}),l=o==="contact"?y:b,s=N||h,u=(Ce=l==null?void 0:l._embedded)!=null&&Ce.length?{applicantId:(Array.isArray(l._embedded)?l._embedded:[]).filter(P=>P.associatedType==="applicant").map(P=>P.associatedId),vendorId:(Array.isArray(l._embedded)?l._embedded:[]).filter(P=>P.associatedType==="vendor").map(P=>P.associatedId),landlordId:(Array.isArray(l._embedded)?l._embedded:[]).filter(P=>P.associatedType==="landlord").map(P=>P.associatedId),offerId:(Array.isArray(l._embedded)?l._embedded:[]).filter(P=>P.associatedType==="offer").map(P=>P.associatedId),tenancyId:(Array.isArray(l._embedded)?l._embedded:[]).filter(P=>P.associatedType==="tenancy").map(P=>P.associatedId)}:null,[C,,{isLoading:v}]=$e({fetchWhenTrue:[u==null?void 0:u.applicantId.length],queryParams:{associatedType:"applicant",associatedId:(u==null?void 0:u.applicantId)??[]}}),[F,,{isLoading:U}]=Nt({fetchWhenTrue:[u==null?void 0:u.vendorId.length],queryParams:{id:(u==null?void 0:u.vendorId)??[]}}),[A,,{isLoading:_}]=$e({fetchWhenTrue:[u==null?void 0:u.landlordId.length],queryParams:{associatedType:"landlord",associatedId:(u==null?void 0:u.landlordId)??[]}}),[D,,{isLoading:J}]=$e({fetchWhenTrue:[u==null?void 0:u.offerId.length],queryParams:{associatedType:"offer",associatedId:(u==null?void 0:u.offerId)??[]}}),[W,,{isLoading:B}]=$e({fetchWhenTrue:[u==null?void 0:u.tenancyId.length],queryParams:{associatedType:"tenancy",associatedId:(u==null?void 0:u.tenancyId)??[]}}),[R,,{isLoading:H}]=$e({fetchWhenTrue:[e],queryParams:{associatedType:t?"company":"contact",associatedId:[e]}}),[ae,,{isLoading:K}]=Nt({fetchWhenTrue:[u==null?void 0:u.landlordId.length,!t],queryParams:{landlordId:[u==null?void 0:u.landlordId]}}),[oe,,{isLoading:X}]=Bn({fetchWhenTrue:[u==null?void 0:u.applicantId.length,!t],queryParams:{id:u==null?void 0:u.applicantId}}),[fe,,,{isLoading:Fe}]=Vt(),he=async(P,O,M=!1)=>{var V;const w=await fe(P);return O&&((V=w._embedded)==null||V.unshift(...O._embedded)),w.pageNumber<w.totalPageCount?he({...P,pageNumber:(P.pageNumber??1)+1,embed:M?["property"]:void 0},w):w},ue=P=>{const O=ve.groupBy(P,"typeId");return Object.entries(O).map(([M,w])=>{var V,x;return{title:((x=(V=f==null?void 0:f.journalEntryTypes)==null?void 0:V.find($=>$.id===M))==null?void 0:x.value)??"Unknown",id:M,icon:zo(M),content:w.map($=>`${le($.created).format(Et)} - ${$.description}`)}})};L.useEffect(()=>{var P;(P=ae==null?void 0:ae._embedded)!=null&&P.length&&ee({_embedded:ae._embedded.map(O=>{var M,w;return{propertyId:O.id,description:`${ce(O==null?void 0:O.address)}, ${ne((M=O==null?void 0:O.selling)==null?void 0:M.price)}, ${ve.startCase((w=O==null?void 0:O.selling)==null?void 0:w.status)}`}})})},[ae]),L.useEffect(()=>{var P;if((P=F==null?void 0:F._embedded)!=null&&P.length){const O=!!(u!=null&&u.landlordId.length)||!t,M=O?F._embedded.map(w=>{var V,x;return{title:`Vendor: ${ce(w==null?void 0:w.address)}, ${ne((V=w==null?void 0:w.selling)==null?void 0:V.price)}, ${ve.startCase((x=w==null?void 0:w.selling)==null?void 0:x.status)}`,id:w.id,content:[]}}):[{title:"Agent's shared commision sales properties",icon:"listInfographic",id:"non-standard-journal-1",content:[]}];he({propertyId:u==null?void 0:u.vendorId,pageSize:100}).then(w=>{const V=ve.groupBy(w._embedded,"propertyId");O?Object.entries(V).forEach(([,$])=>{const z=ue($),Q=M.find(se=>se.id===$[0].propertyId);Q.icon="listInfographic",Q.content.push(...z)}):Object.entries(V).forEach(([$,z])=>{var E,me;const Q=F._embedded.find(ye=>ye.id===$),j={title:`${ce(Q==null?void 0:Q.address)}, ${ne((E=Q==null?void 0:Q.selling)==null?void 0:E.price)}, ${ve.startCase((me=Q==null?void 0:Q.selling)==null?void 0:me.status)}`,id:$,icon:"listInfographic",content:ue(z)};M[0].content.push(j)});const x=M;I($=>{const z=[...$??[]],Q=z.find(se=>se.title==="Current Activity");if(Q){const se=x.map(j=>j.id+j.title);return Q.content=[...Q.content.filter(j=>!se.includes(j.id+j.title)),...x],z}else{const se=[{title:"Current Activity",content:x}],j=$.filter(E=>E.title!=="Current Activity");return j.length&&se.push(...j),se}})})}},[F,A]);const ee=P=>{var O;if((O=P==null?void 0:P._embedded)!=null&&O.length){const M=P._embedded.map(w=>({title:w.description,id:w.propertyId,content:[]}));he({propertyId:P._embedded.map(w=>w.propertyId),pageSize:100}).then(w=>{const V=ve.groupBy(w._embedded,"propertyId");Object.entries(V).forEach(([,x])=>{const $=ue(x),z=M.find(Q=>Q.id===x[0].propertyId);z.icon="listInfographic",z.content.push(...$)}),I(x=>{const $=[...x],z=$.find(Q=>Q.title==="Current Activity");return z?(z.content=[...z.content,...M],$):[{title:"Current Activity",content:M},...x.filter(Q=>Q.title!=="Current Activity")]})})}};L.useEffect(()=>{ee(A)},[A]),L.useEffect(()=>{var P,O;if((P=C==null?void 0:C._embedded)!=null&&P.length)if((O=oe==null?void 0:oe._embedded)!=null&&O.length){const M=oe._embedded.map(w=>({title:`${w.marketingMode==="buying"?"Sales":"Letting"} Applicant: ${Zo(w)}`,id:w.id,content:ue(C._embedded)}));I(w=>{const V=[...w],x=V.find($=>$.title==="Activity");return x?(x.content=[...x.content,...M],V):[{title:"Activity",content:M},...w.filter($=>$.title!=="Activity")]})}else ee(C)},[C,oe]),L.useEffect(()=>{ee(D)},[D]),L.useEffect(()=>{ee(W)},[W]),L.useEffect(()=>{var P,O;if((P=R==null?void 0:R._embedded)!=null&&P.length&&((O=f==null?void 0:f.journalEntryTypes)!=null&&O.length)){const M=ue(R._embedded);I(w=>{const V=w.find($=>$.title.includes("Activity")),x=[...M];return V&&x.unshift(V),x})}},[R,f]);const G=P=>Array.isArray(P)&&P.length?P[0].content?r(it,{items:P.map(O=>({...O,title:O.title,content:G(O.content),titleItems:O.icon?[S(Y,{children:[r(Te,{className:"el-mr1",icon:O.icon}),O.content.length]})]:void 0}))}):r("div",{children:P.map(O=>S(Se,{hasGreyText:!0,"data-testid":"single-offer-active",children:[r(Qe,{"data-testid":"single-offer-status-indicator",intent:"default"}),r("span",{"data-testid":"single-offer-active-content",children:O})]},O))}):P.content,de=Object.values(n()).some(P=>p(P)),Ie=v||U||_||J||B||H||K||X||Fe,pe=L.useCallback(()=>(de?T:d).map(P=>({...P,id:P.id??P.title,content:G(P.content),titleItems:[S(Y,{children:[r(Te,{className:"el-mr1",icon:"listInfographic"}),(P==null?void 0:P.content).length]})]})),[d,de,T]),ge=L.useCallback(P=>{m(((M,w)=>{const{query:V,dateFrom:x,dateTo:$}=w,z=new RegExp(V,"ig"),Q=j=>{j.forEach(E=>{(V&&!E.title.match(z)||x||$)&&Array.isArray(E.content)&&E.content.length&&(typeof E.content[0]!="string"?Q(E.content):E.content=E.content.filter(me=>{var ke;let ye=!!me.match(z);if(x||$){const Le=le((ke=me.match(ro))==null?void 0:ke[0],Et);x&&$?ye=Le.isSameOrAfter(le(x,je),"date")&&Le.isSameOrBefore(le($,je),"date"):x?ye=Le.isSameOrAfter(le(x,je),"date"):$&&(ye=Le.isSameOrBefore(le($,je),"date"))}return ye}))})};Q(M);const se=j=>Array.isArray(j.content)?j.content.length?typeof j.content[0]!="string"?(j.content=j.content.filter(se),j.content.length):!0:!1:!0;return M.filter(se)})(ve.cloneDeep(d),P))},[d]);if(d){const P=pe();return S(Mt,{children:[r(He,{children:g}),s?r(te,{className:"el-mt3"}):u?S(Y,{children:[r("form",{onChange:()=>{ge(n())},children:S(rt,{className:at,children:[r(_e,{children:r(Oe,{...i("query"),label:"Search",type:"search",icon:"searchSystem",placeholder:"Filter by role, journal type, or journal text","data-testid":"full-journal-search-input"})}),r(_e,{children:r(Oe,{...i("dateFrom"),label:"Date From",max:n("dateTo"),type:"date",icon:"calendarSystem","data-testid":"full-journal-date-from"})}),r(_e,{children:r(Oe,{...i("dateTo"),label:"Date To",min:n("dateFrom"),type:"date",icon:"calendarSystem","data-testid":"full-journal-date-to"})})]})}),Ie?r(te,{}):P.length?r(it,{items:P}):r(be,{"data-testid":"not-found-notification",className:"el-mt8",isExpanded:!0,intent:"default",isInline:!0,isFullWidth:!0,children:"No result!"})]}):r(be,{"data-testid":"not-found-notification",className:"el-mt8",isExpanded:!0,intent:"default",isInline:!0,isFullWidth:!0,children:"No Entries Found!"})]})}return r(te,{})},{CONTACTS_LIST:Ot}=eo,vs=()=>{var g;const e=Ge(),o=Ze(),{"*":t}=dt(),i=L.useRef(null),{pathname:n}=o,a=!n.includes(Ot),c=(g=window.__REAPIT_MARKETPLACE_GLOBALS__)==null?void 0:g.cntCode;return c&&!window.location.pathname.includes(c)?(window.__REAPIT_MARKETPLACE_GLOBALS__.cntCode=null,r($n,{to:`${c}/view`,replace:!0})):S(Sn,{isFlexAuto:!0,children:[S(Ln,{children:[r(He,{children:"Contacts"}),S(vn,{className:En,children:[r(nt,{onClick:Pt(e,Ot),active:n.includes("list"),children:"List"}),r(nt,{onClick:void 0,children:"New"}),a&&t&&r(nt,{onClick:Pt(e,t),active:a,children:"Details"})]}),r(Te,{className:Ct,icon:"leadGenerationInfographic",iconSize:"large"}),r(Se,{hasGreyText:!0,children:"This app allows you to find a Contact or Company record based on their address, name or contact details. Information on roles and activity are available from their record."}),a&&t&&r(We,{"data-testid":"new-journal-entry-button",className:Ct,intent:"primary",onClick:()=>{var d;return(d=i==null?void 0:i.current)==null?void 0:d.openDrawer()},children:"New Journal Entry"})]}),S(On,{className:_t(Fn,wn),children:[S(xt,{children:[r(Ue,{path:":id/full-journal",element:r(Xo,{})}),r(Ue,{path:":id/*",element:r(Ko,{createJournalEntryRef:i})}),r(Ue,{path:"list",element:r(Co,{})})]}),a&&t&&r(An,{"data-testid":"new-journal-entry-mobile-controls",buttonIcon:"addSystem",onClick:()=>{var d;return(d=i==null?void 0:i.current)==null?void 0:d.openDrawer()}})]})]})};export{vs as ContactsPage,vs as default};
