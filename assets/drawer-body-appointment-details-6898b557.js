var j=Object.defineProperty;var G=(n,e,i)=>e in n?j(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i;var c=(n,e,i)=>(G(n,typeof e!="symbol"?e+"":e,i),i);import{A as M,B as E,k as v,a6 as U,a7 as D,a8 as H,m as I,j as V,H as R,V as q,W as B}from"./app-1088c2df.js";import{ba as Y,b9 as L,u as S,aP as _,x as J,y as K,aL as N,F as Q,j as z,J as W,a2 as X,aM as Z}from"./elements-7fcf5525.js";import{a as C,F as b,j as t}from"./index-b3f50da9.js";import{i as O}from"./index-03408514.js";import{g as ee}from"./index-0d5dc733.js";import{u as re,M as ne,a as k,h as ie,c as te}from"./all-confirmed-section.helpers-eee887a0.js";import{g as se}from"./property-owner-1850ad04.js";import{g as oe}from"./appointment-card.helpers-60607de9.js";import{c as T}from"./index-fa19f396.js";import{A as F}from"./configuration-ddeef3ff.js";function le(n){return new Promise(e=>setTimeout(()=>e(!0),n))}class ce{constructor(e){c(this,"maxConcurrentCalls");c(this,"waitInterval");c(this,"currentConcurrentAPICallQueue",0);c(this,"queuedAPIFns",[]);c(this,"endpoint");c(this,"params");c(this,"modifiedParams");c(this,"headers",{});c(this,"totalPageCount",1);c(this,"currentPage",1);c(this,"results",[]);c(this,"initFirstPageFn",async()=>{try{const{data:e}=await M.get(this.endpoint,{params:this.params,baseURL:window.reapit.config.platformApiUrl,headers:this.headers,paramsSerializer:{serialize:i=>E.stringify(i,{arrayFormat:"repeat"})}});this.totalPageCount=(e==null?void 0:e.totalPageCount)??1,this.currentPage=(e==null?void 0:e.pageNumber)??1,this.results.push(e)}catch(e){throw O(e)?v(e):new Error(e)}this.queueingApiCalls()});c(this,"executeBasedOnMaxConcurrentLength",e=>{for(let i=0;i<this.maxConcurrentCalls;i++)e()});this.maxConcurrentCalls=e.maxConcurrentCalls,this.waitInterval=e.waitBetweenCallsInterval??4e3,this.endpoint=e.endpoint,this.params=e.params,this.modifiedParams={...e.params,pageNumber:this.currentPage},this.headers=e.headers??{}}async queueingApiCalls(){for(let e=this.currentPage+1;e<=this.totalPageCount;e++)this.queuedAPIFns.push(async()=>{try{const{data:i}=await M.get(this.endpoint,{params:{...this.modifiedParams,pageNumber:e},baseURL:window.reapit.config.platformApiUrl,headers:this.headers,paramsSerializer:{serialize:l=>E.stringify(l,{arrayFormat:"repeat"})}});this.results.push(i)}catch(i){throw O(i)?v(i):new Error(i)}})}async run(){for(this.resetQueue(),await this.initFirstPageFn();this.queuedAPIFns.length&&this.currentConcurrentAPICallQueue<=this.maxConcurrentCalls;){const e=this.queuedAPIFns.map((i,l)=>{if(l<this.maxConcurrentCalls)return i});this.executeBasedOnMaxConcurrentLength(()=>this.queuedAPIFns.shift()),e.length&&(this.executeBasedOnMaxConcurrentLength(()=>this.currentConcurrentAPICallQueue++),await this.callByChunk(e))}}async callByChunk(e){await le(this.waitInterval),await Promise.all(e.map(i=>i==null?void 0:i())),this.executeBasedOnMaxConcurrentLength(()=>this.currentConcurrentAPICallQueue--)}resetQueue(){this.totalPageCount=1,this.currentPage=1,this.modifiedParams=this.params,this.currentConcurrentAPICallQueue=0,this.queuedAPIFns=[],this.results=[]}}const Ie=async n=>{const{recordsId:e,queryClient:i,reapitConnectBrowserSession:l,endpoint:s,queryKey:u,onSetData:p,additionalQueryParams:P}=n,d=await U(l);if(!d)throw new D({description:H});let m=I.uniq(e);for(const h of m){const o=i.getQueryData(u(h));o&&(m=m.filter(f=>f!==o.id))}if(!m.length)return;const w={id:m,pageSize:100,pageNumber:1,...P},y=new ce({maxConcurrentCalls:5,waitBetweenCallsInterval:5e3,params:w,endpoint:s,headers:d});await y.run();for(const h of y.results)for(const o of(h==null?void 0:h._embedded)??[])o&&(typeof p=="function"?p(o):i.setQueryData(u(o.id),o))},$=({contactRole:n,data:e,appointmentId:i,contactType:l})=>{const s=I.pick(e,["homePhone","mobilePhone","workPhone"]),u=V(I.omitBy(s,I.isNil)),{Modal:p,openModal:P}=re({appointmentId:i,contactType:l}),{trackEvent:d}=R(),[m,w,y,h]=Y(),o=({Role:r,Type:g,Action:a,Source:x})=>{d(q.COMMUNICATION,{...B("DIARY"),Name:"Contact Drawer",Role:r,Type:g,Action:a,Source:x})()},f=r=>{const g=[];return r!=null&&r.name&&g.push({key:"Name",value:t(N,{"data-testid":"contact-name",children:(r==null?void 0:r.name)||T(r==null?void 0:r.title,r==null?void 0:r.forename,r==null?void 0:r.surname)}),iconName:"usernameSystem",textEllipsis:!0}),r!=null&&r.email&&g.push({key:"Email",value:t(N,{"data-testid":"contact-email",onClick:a=>{o({Role:n,Type:"Email",Action:F.OPEN_MAIL,Source:"Text"}),k(a)},children:r==null?void 0:r.email}),icon:t(S,{intent:"primary",icon:"emailSystem",onClick:a=>{o({Role:n,Type:"Email",Action:F.OPEN_MAIL,Source:"Icon"}),k(a)}}),textEllipsis:!0}),u&&g.push({key:"Phone Details",iconName:"phoneSystem",value:Object.keys(r).map(a=>{var x;if((x=a.match(/phone/gi))!=null&&x.length&&r[a]){const A=a.replace(/phone/gi,"");return C(N,{"data-testid":`contact-${A}`,onClick:()=>{A!=="mobile"&&o({Role:n,Type:I.capitalize(A),Action:"Call",Source:"Text"}),A!=="mobile"?P(r[a],A,n):w()},children:[r[a]," (",I.capitalize(A),")"]},a)}})}),g};return C(b,{children:[t(p,{}),t(L,{items:[{title:`${n} - ${(e==null?void 0:e.name)||T(e==null?void 0:e.title,e==null?void 0:e.forename,e==null?void 0:e.surname)}`,titleItems:[t(b,{children:t(S,{icon:"usernameSolidSystem"})})],content:C("div",{children:[t(_,{items:f(e)}),u&&(e==null?void 0:e.mobilePhone)&&t(m,{isOpen:h,title:`${e==null?void 0:e.mobilePhone}`,footerItems:t(J,{alignment:"right",children:t(K,{onClick:y,children:"Close"})}),children:t(ne,{includeHeader:!1,contactType:n==="attendee"?"attendee":"property",appointmentId:i,phoneNumber:e==null?void 0:e.mobilePhone,trackIconClicked:r=>o({Role:n,Type:"Mobile",Action:r,Source:"Icon"})})})]})}]})]})},ae=({drawerData:n,appointmentId:e,...i})=>{var m,w,y,h;const[l,s]=n,u=((w=(m=s==null?void 0:s.address)==null?void 0:m.geolocation)==null?void 0:w.latitude)&&((h=(y=s==null?void 0:s.address)==null?void 0:y.geolocation)==null?void 0:h.longitude),{trackEvent:p}=R(),P=o=>()=>{const r=["ios","android"].includes(ee())?"App":"Browser";p(q.THIRD_PARTY_REDIRECT,{...B("DIARY"),Name:`Google Map ${r}`,Action:`Opening Google Map ${r} from Drawer`,"Source Type":o==="link"?"Link":"Icon","Source Name":"Property Address"})()},{role:d}=se(s)??{};return C("div",{...i,children:[s&&C(b,{children:[C(Q,{isFlexAlignEnd:!0,className:"el-border-grey-b el-mb3 el-pb4",children:[t(S,{icon:"homeSolidSystem",iconSize:"small",intent:"primary"}),t(z,{"data-testid":"contact-title",hasNoMargin:!0,className:"el-ml2",children:"Property"})]}),t(_,{items:[{iconName:"pinSystem",key:"Address",value:t(N,{intent:u?"neutral":void 0,"data-testid":"property-text-content",onClick:()=>{var o,f,r,g;P("link")(),ie({coordinate:{latitude:(f=(o=s==null?void 0:s.address)==null?void 0:o.geolocation)==null?void 0:f.latitude,longitude:(g=(r=s==null?void 0:s.address)==null?void 0:r.geolocation)==null?void 0:g.longitude}})()},children:oe(s.address)})}]})]}),(l==null?void 0:l.related)&&l.related.map(o=>t($,{contactRole:d,data:o,appointmentId:e,contactType:"property"},o==null?void 0:o.id))]})},ue=({drawerData:n,appointmentId:e,...i})=>t("div",{...i,children:!!(n!=null&&n.length)&&t("div",{children:n.map(l=>t($,{contactRole:"Attendee",data:l,appointmentId:e,contactType:"attendee"},l==null?void 0:l.id))})}),xe=({contactDetailsContent:n})=>{var P,d;const{appointment:e,property:i}=n,l=te(e,i),{listConfirmed:s,availableOptions:u}=l,p=s.length===u.length;return C("div",{children:[C(Q,{isFlexAlignCenter:!0,className:"el-mb8",children:[t(W,{intent:p?"success":s.length===0?"danger":"warning"}),t(X,{hasNoMargin:!0,hasGreyText:!0,"data-testid":"confirmation-status",children:p?"All Confirmed":`${s.length}/${u.length} Confirmed`})]}),n.property&&t(ae,{"data-testid":"drawer-property-section",drawerData:[n.owner,n.property],appointmentId:(P=n.appointment)==null?void 0:P.id}),n.contacts&&t(ue,{"data-testid":"drawer-attendee-section",drawerData:n.contacts,appointmentId:(d=n.appointment)==null?void 0:d.id}),(e==null?void 0:e.description)&&t(L,{"data-testid":"drawer-notes-section",items:[{title:"Notes",titleItems:[t(b,{children:t(S,{icon:"emailSolidSystem"})})],content:C(z,{className:Z,children:[e.description," "]})}]})]})};export{xe as D,ce as G,Ie as g,le as w};
