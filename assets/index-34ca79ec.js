import{a as m,F as H,j as o}from"./index-b3f50da9.js";import{r as F,aE as Te,aF as fe,aG as Ne,aH as q,u as Y,aI as Ie,D as Pe,aJ as Ce,k as ye,V as re,n as ee,o as ae,v as Je,z as ve,A as ut,B as He,al as Ze,am as We,aK as ht,S as pt,aL as B,aM as G,F as ke,aN as At,aO as Et,j as gt,aP as Le,y as et,a2 as Fe,J as Tt,aQ as ft,E as Nt,I as It,i as me,f as Pt,h as Ct,e as Be,aR as yt,aD as Ft}from"./elements-7fcf5525.js";import{H as j,d as y,V as f,W as N,Z as X,_ as pe,$ as _e,g as _t,h as St,j as E,m as tt,P as Oe,u as Ue,Y as ot,X as ue,a0 as Se,a1 as ne,e as nt,B as wt,v as qe,q as Mt,c as Ot,G as Rt,t as Re,a2 as Dt}from"./app-1088c2df.js";import{Q as vt}from"./url-ce1d32f5.js";import{u as Me}from"./index-230a9ce9.js";import{u as Vt}from"./use-debounced-payload-fb4fc0f7.js";import{c as Ae,a as oe,o as kt}from"./index.esm-c689e26d.js";import{a as Q,u as Lt,F as Ut}from"./index.esm-70abc844.js";import{u as st,h as $t,a as it,b as lt,g as bt,c as rt,t as xt,d as Gt}from"./all-confirmed-section.helpers-eee887a0.js";import{u as $e,a as L,A as U}from"./configuration-ddeef3ff.js";import{u as Yt}from"./use-frequently-appointment-update-895837db.js";import{c as be}from"./index-fa19f396.js";import{g as Ht}from"./index-0d5dc733.js";import{g as xe}from"./property-owner-1850ad04.js";import{T as Xe,p as je,g as ce}from"./appointment-card.helpers-60607de9.js";import{w as De}from"./summary-page.helpers-79e039f8.js";import{M as Ee}from"./modal-dialog-0e8fb4f7.js";import{A as Wt,F as Bt}from"./feedback-button-10b39ca0.js";import{c as qt}from"./index-8f0c1425.js";import{u as Xt}from"./index-8aa18f6a.js";import{u as jt}from"./index-3010b16e.js";import{t as Ve,h as Qt,f as Qe,g as Ke,o as Kt}from"./view-appointment-page-helpers-413eb2ba.js";import{s as zt,E as le}from"./extended-yup-validation-e62a953f.js";import"./index-03408514.js";import"./index-7fcc6ec2.js";import"./index-b6bc85a8.js";import"./index-77752724.js";import"./index-706e92ed.js";import"./with-plugins-a1c7cafe.js";import"./isBetween-bb99a4b7.js";import"./isSameOrAfter-571fd34c.js";import"./department-mapping-99823d46.js";import"./index-c5c95794.js";import"./options-21b6589e.js";import"./object-manipulation-71eb9c9f.js";import"./rooms-naming-0ec8ee01.js";import"./index-6d471c01.js";const Jt=({selectedAccordionItemState:e,dispatchChangeFn:s})=>{var S;const t=Q(),n=t.watch("localFields.customStartDate")??t.watch("start"),i=t.watch("localFields.customEndDate")??t.watch("end"),{trackEvent:c}=j(),l=()=>{let r=n,p=i;t.getValues("localFields.customStartDate")||(r=t.getValues("start"),p=t.getValues("end"));const O=y(r).format("dddd, D MMMM");return`${`${y(r).format("HH:mm")} - ${y(p).format("HH:mm")}`}, ${O}`},a=()=>{var te,z;const r=t.getValues("localFields.appointmentDateForm"),p=t.getValues(),{date:O,startTime:$,endTime:b}=r,k=y(O),[g,D]=$.split(":"),v=k.hour(+g).minute(+D),[K,se]=b.split(":"),C=k.hour(+K).minute(+se);c(f.CHANGE_FORM_DATA,{...N("DIARY"),Action:`${p.start&&p.end?"Change":"Set"} Appointment Date/Time`,"Form Name":X.EDIT_APPOINTMENT,"Field Name":"Appointment Date and Time","Field Type":"Date & Time Modal","Field Value":`${v.format(pe)} (start), ${C.format(pe)} (end)`,"Field Previous Value":`${y(p.start).format(pe)} (start), ${y(p.end).format(pe)} (end)`})(),t.setValue("start",v.toISOString()),t.setValue("end",C.toISOString()),t.setValue("localFields.customStartDate",v.toISOString()),t.setValue("localFields.customEndDate",C.toISOString());let W={...p,start:v.toISOString(),end:C.toISOString()};if((te=p.followUp)!=null&&te.due){const ie=y(p.start).diff(v,"day"),J=y((z=p.followUp)==null?void 0:z.due,_e).subtract(ie,"day").format(_e);t.setValue("followUp.due",J),W={...W,followUp:{...p.followUp,due:J}}}s&&s(Ve(W))},d=(r,p,O)=>{const $=t.getValues("localFields.appointmentDateForm.endTime"),[b,k]=$.split(":");let g=0,D=0;if(r=="h"){g=(+p-O.h)*60,D=Math.floor(g/60);const K=g%60;g=+k+K}else r=="m"&&(g=+k+(+p-O.m));g>=60?(D++,g=g==60?0:g%60):g<0&&(D--,g=g==0?0:60+g%60),t.setValue("localFields.appointmentDateForm.endTime",`${je(+b<O.h?23:+b+ +D)}:${je(g)}`,{shouldValidate:!0}),t.trigger("localFields.appointmentDateForm")},[A,h]=F.useState(t.getValues("typeId")),[u]=$e(),T=r=>{const p=!!A,O=k=>{var g,D;return(D=(g=u==null?void 0:u.appointmentTypes)==null?void 0:g.find(v=>v.id===k))==null?void 0:D.value},$=O(r.target.value),b=O(A);c(f.CHANGE_FORM_DATA,{...N("DIARY"),"Form Name":X.EDIT_APPOINTMENT,"Field Name":L.APPOINTMENT_TYPE,Action:`${p?"Change":"Set"} ${L.APPOINTMENT_TYPE}`,"Field Type":"Dropdown","Field Value":$,"Field Previous Value":b})(),h(r.target.value)},[R,M]=e,_=R==="date",P=["localFields.appointmentDateForm.startTime","localFields.appointmentDateForm.endTime"];return m(H,{children:[m(Te,{"data-accordion-status":_?"open":"closed","data-testid":"accordion-item-date-container",onClick:M("date"),children:[o(fe,{children:l()}),m(Ne,{children:[o(q,{children:o(Y,{icon:"calendarSolidSystem"})}),o(q,{"data-testid":"accordion-icon-indicator-date",children:o(Y,{icon:_?"upSystem":"downSystem"})})]})]}),m(Ie,{"data-testid":"accordion-content-date",className:Pe(_&&Ce),children:[o(ye,{hasMargin:!0,children:o(re,{children:o(ee,{min:`${y().year()-1}-01-01`,max:`${y().year()+2}-01-01`,...t.register("localFields.appointmentDateForm.date",{onChange:a}),icon:"calendarSystem","data-testid":"appointment-date",label:"Date",type:"date"})})}),o(Xe,{onTimeChange:(...r)=>{d(...r),a()},label:"From",name:"localFields.appointmentDateForm.startTime",timeInputGroupNames:P}),o(Xe,{label:"To",name:"localFields.appointmentDateForm.endTime",minTime:t.watch("localFields.appointmentDateForm.startTime"),timeInputGroupNames:P,onTimeChange:a}),o(ye,{className:"el-mb6",children:o(re,{children:m(ee,{children:[o(ae,{children:"Type"}),o(Je,{"data-testid":"appointment-types-options",...t.register("typeId",{onChange:T}),children:zt(u==null?void 0:u.appointmentTypes).map(r=>o("option",{value:r.id,children:r.value},r.id))}),o(ve,{message:(S=t.formState.errors.typeId)==null?void 0:S.message})]})})})]})]})},at=e=>{const s=_t(),{connectSession:t}=St(s),n=Zt(e,t),i=(n==null?void 0:n.type)==="company",[c,,{isLoading:l}]=Xt(n==null?void 0:n.primary,{fetchWhenTrue:[i,n==null?void 0:n.primary]}),[a,,{isLoading:d}]=jt(n==null?void 0:n.primary,{fetchWhenTrue:[!i,n==null?void 0:n.primary]});return{identity:n,isLoading:i?l:d,agentData:(i?c:a)??null}},Zt=(e,s)=>{const t=((e==null?void 0:e.negotiatorIds)??[]).some(n=>{var i;return((i=s==null?void 0:s.loginIdentity)==null?void 0:i.userCode)===n});if(E(e==null?void 0:e.otherAgentId))return{type:"company",primary:e.otherAgentId,lists:[e.otherAgentId]};if(E(e==null?void 0:e.negotiatorIds)&&e.negotiatorIds.length>=1&&E(e==null?void 0:e.officeIds)&&e.officeIds.length>1){const n=t?e.officeIds.filter(i=>i!==(s==null?void 0:s.loginIdentity.officeId)):e.officeIds;return{type:"negotiatorsAndOffices",primary:e.negotiatorIds[0],lists:[...e.negotiatorIds,...n]}}else return E(e==null?void 0:e.negotiatorIds)&&e.negotiatorIds.length>1?{type:"negotiators",primary:e==null?void 0:e.negotiatorIds[0],lists:e.negotiatorIds}:E(e==null?void 0:e.negotiatorIds)&&e.negotiatorIds.length===1?{type:"negotiator",primary:e==null?void 0:e.negotiatorIds[0],lists:e.negotiatorIds}:(console.warn("No registered accompany in this appointment"),null)};const eo={toggle:"t1j45w1r"},ge=({name:e,label:s,onChange:t,...n})=>{const i=Q();return m(ee,{className:eo.toggle,children:[E(s)&&o(ae,{className:"el-mr4",children:s}),m(ut,{...n,...i.register(e,{onChange:t}),id:`${e}-toggler`,"data-testid":`${e}-toggler`,hasGreyBg:!0,children:[o(He,{}),o(He,{})]})]})},we=56,ct=({textAreaRef:e,elementId:s})=>{if(e.current&&e.current.style){const t=window.document.getElementById(s),n=(t==null?void 0:t.scrollHeight)??we;e.current.style.height="inherit",e.current.style.height=`${Math.max(n,we)}px`;return}},to=()=>{var l;const e=Q(),s=F.useRef(null),{trackEvent:t}=j();F.useLayoutEffect(()=>{ct({textAreaRef:s,elementId:"entry-notes-text-area"})},[(l=s.current)==null?void 0:l.value]);const n=F.useCallback(tt.debounce(()=>{t(f.CHANGE_FORM_DATA,{...N("DIARY"),"Form Name":X.EDIT_APPOINTMENT,Action:`${L.ENTRY_NOTES} changed`,"Field Name":L.ENTRY_NOTES,"Field Type":"Textarea","Field Value":""})()},2500),[]),{ref:i,...c}=e.register("description",{onChange:n});return o(ye,{children:o(re,{children:m(ee,{children:[o(ae,{children:"Entry Notes"}),o(Ze,{id:"entry-notes-text-area","data-testid":"entry-notes",placeholder:"Enter entry comments",...c,ref:a=>{i(a),s.current=a},style:{minHeight:we}})]})})})},oo=()=>{var v,K,se,C,W,te,z,ie,J,he;const{watch:e,register:s,setValue:t,formState:{errors:n},getValues:i,trigger:c,setError:l}=Q(),[a]=$e(),{trackEvent:d}=j(),[A,h]=F.useState(i("followUp.responseId")),u=y().year(),T=e("start"),{due:R,notes:M,responseId:_}=e("followUp")??{},P=R===null,S=P&&(E(M)||E(_)),r=async()=>await c("followUp"),p=F.useRef(null);F.useLayoutEffect(()=>{ct({textAreaRef:p,elementId:"follow-up-notes-text-area"})},[(v=p.current)==null?void 0:v.value]),F.useEffect(()=>{if(!S&&P){const w=y(y(T).set("hours",0).set("minutes",0).set("seconds",0)).add(2,"days").format(_e);t("followUp.due",w,{shouldDirty:!0})}},[S,P]);const O=async w=>{if(!P&&![M,_].some(I=>!!I)){w.currentTarget.checked=!1,await r(),_||l("followUp.responseId",{message:"Required"}),M||l("followUp.notes",{message:"Required"});return}const V=w.currentTarget.checked;let Z=null;V?d(f.CHANGE_FORM_DATA,{...N("DIARY"),"Form Name":X.EDIT_APPOINTMENT,Action:"Follow up Appointment","Field Name":L.FOLLOW_UP_TOGGLE,"Field Type":"Toggle","Field Value":!0})():Z=y(y(T).set("hours",0).set("minutes",0).set("seconds",0)).add(2,"days").format(_e),t("followUp.due",Z,{shouldDirty:!0})},$=w=>{const V=w.target.value;d(f.CHANGE_FORM_DATA,{...N("DIARY"),"Form Name":X.EDIT_APPOINTMENT,Action:`Change ${L.FOLLOW_UP_DATE}`,"Field Name":L.FOLLOW_UP_DATE,"Field Type":"Date","Field Value":`${y(V).format(Oe)}`,"Field Previous Value":`${y(R).format(Oe)}`})()},b=async w=>{const V=w.currentTarget.value;await r();const Z=!!A,I=dt=>{var Ge,Ye;return(Ye=(Ge=a==null?void 0:a.followUpResponses)==null?void 0:Ge.find(mt=>mt.id===dt))==null?void 0:Ye.value},x=I(V),de=I(A);d(f.CHANGE_FORM_DATA,{...N("DIARY"),"Form Name":X.EDIT_APPOINTMENT,Action:`${Z?"Change":"Set"} ${L.FOLLOW_UP_FEEDBACK}`,"Field Name":L.FOLLOW_UP_FEEDBACK,"Field Type":"Dropdown","Field Value":x??"No option selected","Field Previous Value":de})(),h(V)},k=F.useCallback(tt.debounce(()=>{d(f.CHANGE_FORM_DATA,{...N("DIARY"),"Form Name":X.EDIT_APPOINTMENT,Action:`${L.FOLLOW_UP_NOTE} changed`,"Field Name":L.FOLLOW_UP_NOTE,"Field Type":"Textarea","Field Value":""})()},2500),[]),{ref:g,...D}=s("followUp.notes",{onChange:async()=>{await r(),k()}});return m(ye,{"data-testid":"follow-up-container",children:[o(We,{children:o(ge,{checked:S,label:S?"Followed Up":"Follow Up",name:"localFields.followUpTickBox",onChange:O})}),!S&&o(We,{children:o(ee,{min:`${u-1}-01-01`,max:`${u+2}-01-01`,...s("followUp.due",{onChange:$}),icon:"calendarSystem","data-testid":"follow-up-due",type:"date",label:"Follow Up Date",pattern:Oe,errorMessage:(se=(K=n.followUp)==null?void 0:K.due)==null?void 0:se.message})}),o(re,{children:m(ee,{children:[o(ae,{children:"Feedback"}),m(Je,{...s("followUp.responseId",{onChange:b}),"data-testid":"follow-up-response-id",className:ht,children:[o("option",{value:"",children:"Select follow up feedback"}),(C=a==null?void 0:a.followUpResponses)==null?void 0:C.map(w=>o("option",{value:w.id,children:w.value},w.id))]}),o(ve,{"data-testid":"follow-up-response-id-validation",message:(te=(W=n.followUp)==null?void 0:W.responseId)==null?void 0:te.message})]})}),o(re,{children:m(ee,{children:[o(ae,{children:"Follow Up Notes"}),o(Ze,{...D,id:"follow-up-notes-text-area","data-testid":"follow-up-notes",placeholder:"Enter follow up notes",hasError:!!((ie=(z=n.followUp)==null?void 0:z.notes)!=null&&ie.message),ref:w=>{g(w),p.current=w},style:{minHeight:we}}),o(ve,{"data-testid":"follow-up-notes-validation",message:(he=(J=n.followUp)==null?void 0:J.notes)==null?void 0:he.message})]})})]})},no=()=>{const s=Q().watch("end"),t=y().isAfter(s),[n,i]=F.useState(t?"1":"0");return m(H,{children:[o(pt,{isFullWidth:!0,name:"appointment-notes",onChange:a=>{const d=a.currentTarget.value;i(d)},options:[{id:"notes",value:"0",text:"Notes",isChecked:n==="0"},{id:"follow-up",value:"1",text:"Follow Up",isChecked:n==="1"}]}),[o(to,{},"0"),o(oo,{},"1")][n]]})},so=()=>Q().watch("end")?o(no,{}):null,io=(e,s)=>{var l,a;const{primaryContact:t,role:n,hasMultipleMode:i}=xe(e)??{};return[{key:`Name (${i?"Vendor And Landlord":n})`,value:be(t==null?void 0:t.name),iconName:"usernameSystem",conditional:E(t==null?void 0:t.name),textEllipsis:!0},{key:"Address",value:(()=>{var A,h,u,T;const d=!!((h=(A=e==null?void 0:e.address)==null?void 0:A.geolocation)!=null&&h.latitude)&&!!((T=(u=e==null?void 0:e.address)==null?void 0:u.geolocation)!=null&&T.longitude);return o(B,{"data-testid":"property-address",onClick:d?s==null?void 0:s.onAddressClick:void 0,intent:d?"neutral":void 0,className:G,children:ce(e==null?void 0:e.address)})})(),conditional:E(ce(e==null?void 0:e.address)),iconName:"homeSystem"},{key:"Phone Details",value:m(ke,{isFlexWrap:!0,isFlexColumn:!0,children:[E(t==null?void 0:t.mobilePhone)&&m(B,{"data-testid":"mobile-phone",onClick:()=>s==null?void 0:s.onPhoneClick(t.mobilePhone,"mobile"),className:G,children:[t==null?void 0:t.mobilePhone," (Mobile)"]}),E(t==null?void 0:t.workPhone)&&m(B,{"data-testid":"work-phone",onClick:()=>s==null?void 0:s.onPhoneClick(t.mobilePhone,"work"),className:G,children:[t==null?void 0:t.workPhone," (Work)"]}),E(t==null?void 0:t.homePhone)&&m(B,{"data-testid":"home-phone",onClick:()=>s==null?void 0:s.onPhoneClick(t.mobilePhone,"home"),className:G,children:[t==null?void 0:t.homePhone," (Home)"]})]}),conditional:E(t==null?void 0:t.mobilePhone)||E(t==null?void 0:t.workPhone)||E(t==null?void 0:t.homePhone),iconName:"phoneSystem"},{key:"Email",value:o(B,{"data-testid":"email",onClick:s==null?void 0:s.onEmailClick,className:G,children:t==null?void 0:t.email}),iconName:"emailSystem",conditional:E(t==null?void 0:t.email)},{key:"Property Keys",value:o(At,{className:"el-wfull",rowGapMobile:1,rowGapTablet:1,rowGap4KScreen:1,rowGapDesktop:1,rowGapWideScreen:1,rowGapSuperWideScreen:1,children:(((l=e==null?void 0:e._embedded)==null?void 0:l.keys)??[]).map(d=>o(Et,{spanMobile:4,spanTablet:4,spanDesktop:8,spanWideScreen:12,spanSuperWideScreen:16,span4KScreen:20,children:m(gt,{hasNoMargin:!0,hasGreyText:!0,"data-testid":"property-detail-keys",className:G,children:["Key #",d.number]})},d.id))}),conditional:E((a=e==null?void 0:e._embedded)==null?void 0:a.keys),iconName:"securityTokenSystem"}].reduce((d,{conditional:A,...h})=>A?[...d,h]:d,[])},lo=({propertyData:e,appointmentId:s})=>{const{trackEvent:t}=j(),n=Ue(),{Modal:i,openModal:c}=st({appointmentId:s,contactType:"property"}),{role:l}=xe(e)??{},a=()=>{var R,M,_,P;const T=["ios","android"].includes(Ht())?"App":"Browser";t(f.THIRD_PARTY_REDIRECT,{...N("DIARY"),Name:`Google Map ${T}`,Action:`Opening Google Map ${T} from Accordion Content`,"Source Type":"Link","Source Name":"Property Address"})(),$t({coordinate:{latitude:(M=(R=e==null?void 0:e.address)==null?void 0:R.geolocation)==null?void 0:M.latitude,longitude:(P=(_=e==null?void 0:e.address)==null?void 0:_.geolocation)==null?void 0:P.longitude}})()},d=u=>{t(f.COMMUNICATION,{...N("DIARY"),Name:"Property Accordion Content",Action:U.OPEN_MAIL,Source:"Text",Type:"Email",Role:l})(),it(u)},A=(u,T)=>{T!=="mobile"&&t(f.COMMUNICATION,{...N("DIARY"),Name:"Property Accordion Content",Action:U.OPEN_DIALER,Source:"Text",Type:ne.capitalize(T),Role:l})(),c(u,T,l)},h=()=>{t(f.INTERACTION_SECTION,{...N("DIARY"),Name:"Property Accordion Change Button",Action:ot.NAVIGATE("change property"),"Event Type":"Click"})(),n({pathname:ue.EXTENDED_VIEW_APPOINTMENT_PROPERTY(s)},{state:Se.ACCESS_EXTENDED_VIEW_APPOINTMENT})};return m(H,{children:[o(Le,{hasGrid:!0,"data-testid":"property-key-value-list",items:io(e,{onAddressClick:a,onEmailClick:d,onPhoneClick:A})}),o(et,{className:"el-mt5","data-testid":"property-change-button",intent:"primary",onClick:h,type:"button",children:"Change"}),o(i,{})]})},ro=(e,s,t)=>{var i,c,l,a,d;return[{key:`Name (${ne.capitalize(s==null?void 0:s.replace("tenancy","tenant"))})`,value:be(e==null?void 0:e.title,e==null?void 0:e.forename,e==null?void 0:e.surname),iconName:"usernameSystem",conditional:!0,textEllipsis:!0},{key:"Address",value:ce(e==null?void 0:e.primaryAddress),conditional:E(ce(e==null?void 0:e.primaryAddress)),iconName:"homeSystem",textEllipsis:!0},{key:"Phone Details",value:m(ke,{isFlexWrap:!0,isFlexColumn:!0,children:[E(e==null?void 0:e.mobilePhone)&&m(B,{"data-testid":"mobile-phone",onClick:()=>t==null?void 0:t.onPhoneClick(e.mobilePhone,"mobile"),className:G,children:[e.mobilePhone," (Mobile)"]}),E(e==null?void 0:e.workPhone)&&m(B,{"data-testid":"work-phone",onClick:()=>t==null?void 0:t.onPhoneClick(e.mobilePhone,"work"),className:G,children:[e.workPhone," (Work)"]}),E(e==null?void 0:e.homePhone)&&m(B,{"data-testid":"home-phone",onClick:()=>t==null?void 0:t.onPhoneClick(e.mobilePhone,"home"),className:G,children:[e.homePhone," (Home)"]})]}),conditional:E(e==null?void 0:e.mobilePhone)||E(e==null?void 0:e.workPhone)||E(e==null?void 0:e.homePhone),iconName:"phoneSystem"},{key:"Email",value:o(B,{"data-testid":"email",onClick:t.onEmailClick,className:G,children:e==null?void 0:e.email}),iconName:"emailSystem",conditional:E(e==null?void 0:e.email)},{key:"Looking for property ranging",value:o(H,{children:(e==null?void 0:e.marketingMode)==="buying"?ze((i=e==null?void 0:e.buying)==null?void 0:i.priceFrom,(c=e==null?void 0:e.buying)==null?void 0:c.priceTo):ze((l=e==null?void 0:e.renting)==null?void 0:l.rentFrom,(a=e==null?void 0:e.renting)==null?void 0:a.rentTo,` ${ne.capitalize((d=e==null?void 0:e.renting)==null?void 0:d.rentFrequency)}`)}),conditional:s==="applicant",iconName:"euroSystem"}].reduce((A,{conditional:h,...u})=>h?[...A,u]:A,[])},ze=(e,s,t)=>e&&s?`${De(e)} to ${De(s)}${t??""}`:e||s?`${De(e||s||0)}${t??""}`:"-",ao=({data:e,type:s,appointmentId:t})=>{const{trackEvent:n}=j(),i=Ue(),{Modal:c,openModal:l}=st({appointmentId:t,contactType:"attendee"}),a=h=>{n(f.COMMUNICATION,{...N("DIARY"),Name:"Attendee Accordion Content",Action:U.OPEN_MAIL,Source:"Text",Type:"Email",Role:s})(),it(h)},d=(h,u)=>{u!=="mobile"&&n(f.COMMUNICATION,{...N("DIARY"),Name:"Attendee Accordion Content",Action:U.OPEN_DIALER,Source:"Text",Type:ne.capitalize(u),Role:s})(),l(h,u,s)},A=()=>{n(f.INTERACTION_SECTION,{...N("DIARY"),Name:"Attendee Accordion Change Button",Action:ot.NAVIGATE("change attendee"),"Event Type":"Click"})(),i({pathname:ue.EXTENDED_VIEW_APPOINTMENT_ATTENDEE(t)},{state:Se.ACCESS_EXTENDED_VIEW_APPOINTMENT})};return m(H,{children:[o(Le,{"data-testid":"attendee-key-value-list",hasGrid:!0,items:ro(e,s,{onEmailClick:a,onPhoneClick:d})}),o(et,{className:"el-mt5","data-testid":"attendee-change-button",intent:"primary",onClick:A,type:"button",children:"Change"}),o(c,{})]})},co=({selectedAccordionItemState:e})=>{const{appointmentId:s}=nt(),t=Q(),n=t.watch("propertyId"),[i]=Me(n,{fetchWhenTrue:[n],queryParams:{embed:["landlord","vendor","keys"]}}),[c,l]=e,{data:a,role:d}=lt(t.getValues())??{},A=!ne.isNil(d)&&E(a),h=E(n);return m(H,{children:[m(Te,{"data-accordion-status":c==="property"?"open":"closed","data-testid":"accordion-item-property-container",onClick:l("property"),children:[o(fe,{children:h?ce(i==null?void 0:i.address):o(Fe,{"data-testid":"accordion-add-property",hasNoMargin:!0,intent:"neutral",children:"Add property"})}),m(Ne,{children:[o(q,{children:o(Y,{icon:"homeSolidSystem"})}),h&&o(q,{"data-testid":"accordion-icon-indicator-property",children:o(Y,{icon:c==="property"?"upSystem":"downSystem"})})]})]}),h&&o(Ie,{"data-testid":"accordion-content-property",className:Pe(c==="property"&&Ce),children:o(lo,{propertyData:i,appointmentId:s})}),m(Te,{"data-accordion-status":c==="attendee"?"open":"closed","data-testid":"accordion-item-attendee-container",onClick:l("attendee"),children:[o(fe,{children:A?be(a==null?void 0:a.title,a==null?void 0:a.forename,a==null?void 0:a.surname):o(Fe,{"data-testid":"accordion-add-attendee",hasNoMargin:!0,intent:"neutral",children:"Add Attendee"})}),m(Ne,{children:[o(q,{children:o(Y,{icon:"usernameSolidSystem"})}),A&&o(q,{"data-testid":"accordion-icon-indicator-attendee",children:o(Y,{icon:c==="attendee"?"upSystem":"downSystem"})})]})]}),A&&o(Ie,{"data-testid":"accordion-content-attendee",className:Pe(c==="attendee"&&Ce),children:o(ao,{data:a,type:d,appointmentId:s})})]})},mo=({modalInstance:e,appointmentData:s,propertyData:t,configurationData:n,isNewAppointment:i})=>{var S,r;const{trackEvent:c}=j(),{agentData:l}=at(s),a=(r=(S=n==null?void 0:n.appointmentTypes)==null?void 0:S.find(p=>p.id===s.typeId))==null?void 0:r.value,{time:d,date:A}=bt(s),{data:h}=lt(s)??{},{primaryContact:u}=xe(t)??{},T=(h==null?void 0:h.email)??"",R=(u==null?void 0:u.email)??"",M=(l==null?void 0:l.workPhone)??(l==null?void 0:l.mobilePhone)??"Unknown Number",_=(l==null?void 0:l.name)??"Unknown Negotiator Name";return o(Ee,{ModalInstance:e,title:"Email Confirmation",message:"Do you want to send an email confirmation?",ctaIntent:"primary",ctaMessage:"Yes",ctaConfirmFn:()=>{window.history.replaceState({},document.title),c(f.INTERNAL_APP_STATE_CHANGE,{...N("DIARY"),Name:"Prompt Email Confirmation",Action:U.SEND_EMAIL(i?"after create new appointment":"from floating menu button"),Value:"Yes"})();const p={bcc:`${T},${R}`,subject:`Viewing with ${_}`,body:`Hello,%0D%0A%0D%0AI am delighted to confirm your ${a} on ${A} at ${d}${t!=null&&t.address?` for ${qt(t==null?void 0:t.address)}`:""}.%0D%0AIf you have any questions prior to the appointment please do not hesitate to contact me on ${M}.%0D%0A%0D%0AKind Regards,%0D%0A${_}`};return window.open(`mailto:${(l==null?void 0:l.email)??""}?${wt.stringify(p,{encode:!1})}`,"_blank")},ctaCancelFn:()=>{window.history.replaceState({},document.title),c(f.INTERNAL_APP_STATE_CHANGE,{...N("DIARY"),Name:"Prompt Email Confirmation",Action:U.SEND_EMAIL(i?"after create new appointment":"from floating menu button"),Value:"No"})(),e.closeModal()}})},uo=()=>{const{setValue:e,register:s,watch:t,getValues:n}=Q(),i=t(),c=t("propertyId"),[l]=Me(c,{fetchWhenTrue:[c],queryParams:{embed:["landlord","vendor","keys"]}}),a=i.attendee,d=i.accompanied,A=i.propertyId,{availableOptions:h,listConfirmed:u}=rt(i,l),T=u.length===h.length,{trackEvent:R}=j(),M=F.useState(h.map(({value:r})=>({value:n(`${r}Confirmed`),name:r}))),_=r=>{const p=r.target.value.split(",");xt({selectedValues:p,prevValuesState:M},R),a&&e("attendeeConfirmed",p.includes("attendee")),d&&e("negotiatorConfirmed",p.includes("negotiator")),A&&e("propertyConfirmed",p.includes("property"))},[P,S]=F.useState(!1);return m(H,{children:[m(ke,{isFlexAlignCenter:!0,className:"el-mb7",onClick:()=>S(!P),children:[o(Tt,{intent:T?"success":u.length===0?"danger":"warning"}),o(Fe,{hasNoMargin:!0,hasGreyText:!0,"data-testid":"confirmed-title",children:T?"All Confirmed":`Confirmed (${u.length}/${h.length})`})]}),o(ft,{isOpen:P,onModalClose:()=>S(!P),title:T?"All Confirmed":`Confirmed (${u.length}/${h.length})`,children:o(re,{children:m(ee,{children:[o(ae,{children:"Select to confirm"}),o(Nt,{"data-testid":"multiselect-confirmation",...s("localFields.allConfirmed",{onChange:_}),id:"confirmation",options:h,defaultValues:u})]})})})]})},ho=({accompanyingAgent:e,data:s,trackEvent:t})=>{const{agentData:n,identity:i}=e??{},c=l=>{const a=l.target.checked,d=s.accompanied;t(f.CHANGE_FORM_DATA,{...N("DIARY"),"Form Name":X.EDIT_APPOINTMENT,"Field Name":"Accompany Toggle",Action:`Turn ${d?"Off":"On"} Accompanied Toggle`,"Field Type":"Toggle","Field Value":a,"Field Previous Value":d})()};return[{key:"Accompanied By",iconName:(i==null?void 0:i.type)==="company"?"companySystem":"usernameSystem",value:(n==null?void 0:n.name)??""},{key:"Accompanied",iconName:"authenticationSystem",value:o(ge,{name:"accompanied",onChange:c})},{key:"Confirmation",iconName:"authenticationSystem",value:o(uo,{})},{key:"Virtual",iconName:"authenticationSystem",value:o(ge,{name:"virtual"})},{key:"Repeat",iconName:"authenticationSystem",value:o(ge,{name:"isRepeat"})}]},po=({selectedAccordionItemState:e})=>{var T;const{watch:s}=Q(),{trackEvent:t}=j(),n=s(),i=at(n),[c]=Me(n==null?void 0:n.propertyId,{fetchWhenTrue:[n==null?void 0:n.propertyId],queryParams:{embed:["landlord","vendor","keys"]}}),{availableOptions:l,listConfirmed:a}=rt(n,c),d=a.length===l.length,[A,h]=e,u=A==="details";return m(H,{children:[m(Te,{"data-accordion-status":u?"open":"closed","data-testid":"accordion-item-details-container",onClick:h("details"),children:[m(fe,{children:["Accompanied By ",((T=i==null?void 0:i.agentData)==null?void 0:T.name)??""," ",d?"All Confirmed":`${a.length}/${l.length} Confirmed`]}),m(Ne,{children:[m(q,{children:["Virtual ",o(Y,{icon:n.virtual?"checkSolidSystem":"closeSolidSystem",className:"el-ml3"})]}),m(q,{children:["Repeat ",o(Y,{icon:n.isRepeat?"checkSolidSystem":"closeSolidSystem",className:"el-ml3"})]}),o(q,{"data-testid":"accordion-icon-indicator-property",children:o(Y,{icon:u?"upSystem":"downSystem"})})]})]}),o(Ie,{"data-testid":"accordion-content-property",className:Pe(u&&Ce),children:o(Le,{hasGrid:!0,items:ho({data:n,accompanyingAgent:i,trackEvent:t})})})]})};const Ao={container:"c1t1sopt"},Eo=Ae().shape({typeId:oe().required(le.INVALID_OPTION),localFields:Ae().shape({appointmentDateForm:Ae().shape({date:oe().required(le.FIELD_REQUIRED),startTime:oe().required(le.FIELD_REQUIRED).shouldNotExceed("localFields.appointmentDateForm.endTime"),endTime:oe().required(le.FIELD_REQUIRED).shouldExceed("localFields.appointmentDateForm.startTime")})}),followUp:Ae().shape({due:oe().shouldExceed("localFields.appointmentDateForm.date").nullable(),responseId:oe().test({test:(e,s)=>{var c,l;const t=((l=(c=s.options)==null?void 0:c.context)==null?void 0:l.from)??s.options.from,n=ne.get(t[t.length-1].value,s.path);return qe(t,"localFields.followUpTickBox")?E(n)||n==="":!0},message:le.FIELD_REQUIRED}).nullable(),notes:oe().test({test:(e,s)=>{var c,l;const t=((l=(c=s.options)==null?void 0:c.context)==null?void 0:l.from)??s.options.from,n=ne.get(t[t.length-1].value,s.path);return qe(t,"localFields.followUpTickBox")?!0:E(n)||n===""||n===null},message:le.FIELD_REQUIRED}).nullable()})}),go=()=>m(H,{children:[o(Y,{"data-testid":"controls-icon",className:"el-mb5",icon:"editAppInfographic",iconSize:"large"}),o(Fe,{"data-testid":"controls-description",hasGreyText:!0,children:Wt})]}),To=()=>{const{isMobile:e,isTablet:s}=It(),t=Mt(),{appointmentId:n}=nt(),{trackEvent:i}=j(),c=Ue(),{state:l}=Ot(),a=me(),d=me(),A=me(),h=me(),{Modal:u,closeModal:T}=me(),{bulkAddAdditionalMenu:R}=Rt(),[M,_]=F.useState("date");F.useEffect(Qt(e,T),[e]);const[P,S]=F.useState(null),{data:r,error:p,isFetching:O,isLoading:$}=Gt(n,{staleTime:1e3*60*60*8,refetchOnMount:!0,enabled:!!n}),[b,,{isLoading:k}]=$e(),[g,,{isLoading:D}]=Me(r==null?void 0:r.propertyId,{fetchWhenTrue:[!!(r&&(r!=null&&r.propertyId))],queryParams:{embed:["landlord","vendor","keys"]},onError:I=>{if(I instanceof Re){t.setQueryData(vt.APPOINTMENT.single(n),{...r,propertyId:""});return}}}),v=!n||p instanceof Re,K=p&&!(p instanceof Re),se=O||$||k||D,C=Lt({defaultValues:Qe(r),resolver:kt(Eo),mode:"all"}),{update:W,isLoading:te}=Yt(n),{dispatch:z}=Vt({timeout:2500,onDebounce:I=>{Object.keys(C.formState.errors).length||W(Ve(I))}});F.useEffect(()=>{r&&C.reset(Qe(r))},[r]);const ie=!!r&&C.watch("start"),J=C.watch("cancelled"),he=te||O,w=async()=>{const I=!J;i(f.CHANGE_FORM_DATA,{...N("DIARY"),"Form Name":X.EDIT_APPOINTMENT,"Field Name":"Cancel Confirmation Pop-up",Action:"Change appointment status","Field Type":"Button","Field Value":`Appointment ${I?"Cancelled":"Rescheduled"}`})(),await W(Ve({...C.getValues(),cancelled:I})),a.closeModal()},V=(I={includeProperty:null,includeAttendee:null})=>{const x={confirmation:I,appointment:{...r,_embedded:{property:g}}};i(f.INTERACTION_SECTION,{...N("DIARY"),Name:"Floating Menu Item",Action:U.CREATE_APPOINTMENT,"Event Type":"Click"})(),c(ue.NEW_APPOINTMENT,{state:x})},Z=I=>()=>{const x={property:()=>{if(!E(C.getValues("propertyId"))){c({pathname:ue.EXTENDED_VIEW_APPOINTMENT_PROPERTY(n)},{state:Se.ACCESS_EXTENDED_VIEW_APPOINTMENT});return}},attendee:()=>{if(!E(C.getValues("attendee.contacts"))){c({pathname:ue.EXTENDED_VIEW_APPOINTMENT_ATTENDEE(n)},{state:Se.ACCESS_EXTENDED_VIEW_APPOINTMENT});return}}};x!=null&&x[I]&&x[I](),_(de=>de!==I?I:null)};return F.useEffect(()=>{const I=setTimeout(()=>{l!=null&&l.isNewAppointment&&h.openModal()},4e3);return()=>clearTimeout(I)},[l]),F.useEffect(()=>{const I=e?[]:Ke({data:r,openNewAppointmentPage:V,PropertyAppointmentModal:d,AttendeeAppointmentModal:A,EmailConfirmationModal:h,CancelAppointmentModal:a});R(I.map(({label:x,onClick:de})=>({name:x,callback:de})))},[e,r]),o(Pt,{children:se?o(Ct,{"data-testid":"view-appointment-loader",fullPage:!0}):v?o(Be,{"data-testid":"view-appointment-not-found-notification",isExpanded:!0,isFullWidth:e||s,intent:"default",children:n?`Appointment with "${n}" ID is not found`:"Appointment not found"}):K?o(Be,{"data-testid":"view-appointment-error-notification",isExpanded:!0,isFullWidth:e||s,intent:"danger",children:p.readableMessage||Dt.DEFAULT}):ie&&m(H,{children:[m("div",{"data-testid":"view-appointment-container",className:Ao.container,children:[o(Ut,{...C,children:m("form",{onChange:Kt(()=>z(C.getValues())),children:[m(yt,{children:[o(Jt,{dispatchChangeFn:z,selectedAccordionItemState:[M,Z]}),o(co,{selectedAccordionItemState:[M,Z]}),o(po,{selectedAccordionItemState:[M,Z]})]}),o(so,{}),o(Ft,{"data-testid":"view-appointment-mobile-control",buttonIcon:"moreSystem",mobileControlItems:Ke({data:C.watch(),openNewAppointmentPage:V,PropertyAppointmentModal:d,AttendeeAppointmentModal:A,EmailConfirmationModal:h,CancelAppointmentModal:a})})]})}),o(Bt,{})]}),o(u,{title:"Controls",children:o(go,{})}),g&&o(Ee,{ModalInstance:d,title:"Property",message:`Do you want to include ${ce(g.address)}?`,ctaIntent:"primary",ctaMessage:"Yes",ctaConfirmFn:()=>{i(f.INTERNAL_APP_STATE_CHANGE,{...N("DIARY"),Name:"Prompt Include Property",Action:U.CREATE_APPOINTMENT_WITH_EXISTING("property"),Value:"Yes"})(),S(!0),d.closeModal(),r!=null&&r.attendee?A.openModal():V({includeProperty:!0,includeAttendee:null})},ctaCancelFn:()=>{i(f.INTERNAL_APP_STATE_CHANGE,{...N("DIARY"),Name:"Prompt Include Property",Action:U.CREATE_APPOINTMENT_WITH_EXISTING("property"),Value:"No"})(),S(!1),r!=null&&r.attendee?A.openModal():V({includeProperty:!1,includeAttendee:null})}}),r.attendee&&o(Ee,{ModalInstance:A,title:"Attendee",message:`Do you want to include ${r.attendee.contacts[0].name}?`,ctaIntent:"primary",ctaMessage:"Yes",ctaConfirmFn:()=>{i(f.INTERNAL_APP_STATE_CHANGE,{...N("DIARY"),Name:"Prompt Include Attendee",Action:U.CREATE_APPOINTMENT_WITH_EXISTING("attendee"),Value:"Yes"})(),V({includeProperty:P,includeAttendee:!0})},ctaCancelFn:()=>{i(f.INTERNAL_APP_STATE_CHANGE,{...N("DIARY"),Name:"Prompt Include Attendee",Action:U.CREATE_APPOINTMENT_WITH_EXISTING("attendee"),Value:"No"})(),V({includeProperty:P,includeAttendee:!1})}}),o(Ee,{ModalInstance:a,title:"Confirmation",message:`Do you want to ${J?"reschedule":"cancel"} the appointment?`,ctaIntent:"primary",ctaMessage:"Yes",ctaConfirmFn:w,isCtaLoading:he}),r&&o(mo,{modalInstance:h,appointmentData:r,propertyData:g,configurationData:b,isNewAppointment:l==null?void 0:l.isNewAppointment})]})})},on=To;export{on as default};
