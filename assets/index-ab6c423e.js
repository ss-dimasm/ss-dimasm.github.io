import{j as o,F as W,a as T}from"./index-154d360c.js";import{r as O,j as re,x as $,y as x,I as k,a6 as z,U as Fe,D as N,a7 as Se,a8 as Ee,$ as Ne,e as Y,s as Ae,k as ie,l as _,n as V,v as Ce,o as De,i as Re,d as w,F as Z,O as Oe,h as xe,a9 as U,aa as _e,ab as Ve,ac as ve}from"./elements-7fcf5525.js";import{g as je,h as Me,i as Pe,j as we,k as qe,u as ce,L as $e,l as le,m as h,d as p}from"./app-071066e2.js";import{a as He,C as Be,u as ee,F as te}from"./index.esm-70abc844.js";import{c as Ge,a as Ie,o as Ye}from"./index.esm-c689e26d.js";import{E as Le,D as We}from"./error-messages-27b293ab.js";import{n as de,p as ue,e as me,a as ge,b as he}from"./regex-aa179d17.js";import{S as ke,a as ze,P as Ke,b as Je}from"./page-layout-cd2512b9.js";import{A as Qe}from"./index-43613dd1.js";import{A as Xe,U as Ze}from"./axios-12d950d5.js";import{R as I,a as Ue}from"./routes-4ccd8c9c.js";import{s as et,g as tt,c as at}from"./search-results.helpers-369a93a4.js";import{u as ot}from"./use-user-agent-7653ecfd.js";import{M as nt}from"./options-21b6589e.js";import{I as st}from"./input-error-ab59bffb.js";import"./with-plugins-9d0f23e8.js";import{r as rt}from"./object-manipulation-71eb9c9f.js";import"./index-c5c95794.js";import"./rooms-naming-0ec8ee01.js";import"./isBetween-bb99a4b7.js";import"./isSameOrAfter-571fd34c.js";const q={formLayout:"f1c3vid6",title:"t1g1dj1r",subtitle:"sdw5rbd",logo:"l16w41e"},it=new RegExp(`${de.source}|${ue.source}`),ct=Ge().shape({searchInput:Ie().test({name:"search-input-validation",message:Le.INVALID_INPUT_PATTERN,test:e=>e===""?!0:me.isValidSync(e)||ge.isValidSync(e)||it.test(e)})}),lt=async(e,t)=>{try{return(await Xe.get(Ze.APPLICANTS,{params:{...e,pageSize:ke},headers:{Authorization:`Bearer ${t==null?void 0:t.accessToken}`}})).data}catch(a){throw a instanceof Qe?qe(a):new Error(a)}};function dt(e,t={}){const a=je(),{connectSession:n}=Me(a);return Pe(["applicants",e],{...t,queryFn:()=>lt(e,n),enabled:!!(n&&(t!=null&&t.enabled))})}const ae=e=>we(e)?ge.isValidSync(e)||me.isValidSync(e)?{type:e.match(/@/)?"email":"phone",params:{contactDetail:[e]}}:de.test(e)?{type:"name",params:{name:e}}:ue.test(e)?{type:"post code",params:{address:e}}:{type:!1,params:{}}:{type:!1,params:{}},L={type:"",priceFrom:"",priceTo:"",dateFrom:"",dateTo:""},oe=({type:e})=>{const[t,a]=O.useState(!1),n=ce();O.useEffect(()=>{const i=setTimeout(()=>{a(!0)},2500);return()=>{clearTimeout(i)}},[]);const l={pathname:Ue.REGISTRATION,state:I.SEARCH_TO_REGISTRATION};return e==="found"?o(W,{children:t&&T(re,{"data-testid":"text-continue-registration",className:et.ctaFound,children:["Not found what you are looking for?"," ",o("span",{onClick:()=>n(l,{state:I.SEARCH_TO_REGISTRATION}),children:"Create New"})]})}):o($,{className:"el-pt12",children:o($e,{to:l,state:I.SEARCH_TO_REGISTRATION,children:o(x,{"data-testid":"btn-continue-registration",intent:"primary",children:"Continue Registration"})})})},ut=({data:e,pageState:t,searchParam:a,filterState:n})=>{const{isMobile:l,isTablet:i}=k(),{params:r,encodeParamsAndAssignToURL:u}=le(),[d,m]=t,[g,f]=n,b=g?f:(e==null?void 0:e._embedded)??[],A=ce(),v=j=>{const C={...r,page:j};m(j),u(C)};return o("div",{className:z,children:e&&(b.length?T("div",{"data-testid":"search-result-found",children:[o(oe,{type:"found"}),o(Fe,{numberColumns:9,rows:tt(a,b,A),className:at}),o("div",{className:N(Se,Ee),children:(e==null?void 0:e.totalPageCount)>1&&!g&&o(Ne,{callback:v,currentPage:d,numberPages:(e==null?void 0:e.totalPageCount)??1,"data-testid":"search-result-pagination"})})]}):T("div",{"data-testid":"search-result-not-found",children:[o(Y,{isExpanded:!0,intent:"danger",isInline:!0,isFullWidth:l||i,className:l?"el-my12 el-pt10":"el-my12",children:"No Records Found"}),o(oe,{type:"not-found"})]}))})};const mt=Ae("div")({name:"ControlsContainer",class:"chc3ioo",propsAsIs:!1}),E={formLayout:"f17kpqej",inputFullWidth:"i155s1lu",dateForSafari:"dlpqk2c",dateNotHaveValue:"d137qrnz",dateHaveValue:"d1n55cgq"},ne=({control:e,name:t,label:a})=>{const n=l=>{const i=l.target.value;let r=typeof i=="string"?i.replace(he,"").toLowerCase():i;return typeof r=="string"&&(r.includes("k")?r=+r.replace(/.$/,"")*1e3:r.includes("m")&&(r=+r.replace(/.$/,"")*1e6)),r};return o(Be,{control:e,name:t,render:({field:{value:l,...i}})=>{const r=u=>{n(u),i.onChange(n(u)),i.onBlur()};return o(_,{children:o(V,{className:E.inputFullWidth,type:"text",label:a,onChange:r,value:l||"","data-testid":`filter-${t}`})})}})},se=()=>{const{browser:e}=ot(),{register:t,watch:a,control:n,reset:l,getValues:i}=He(),r=a("dateFrom"),u=a("dateTo"),{isMobile:d}=k(),m=i().dateFrom,g=i().dateTo;return T(W,{children:[o(mt,{children:T(ie,{className:E.formLayout,children:[o(_,{children:T(V,{children:[T(Ce,{...t("type"),"data-testid":"filter-type",children:[o("option",{value:"",children:"None selected"},"default-option"),nt.map(({id:f,value:b})=>o("option",{value:f,children:b},f))]}),o(De,{children:"Type"})]})}),o(ne,{control:n,name:"priceFrom",label:"Price From"}),o(ne,{control:n,name:"priceTo",label:"Price To"}),o(_,{children:o(V,{type:"date",label:"Date From",...t("dateFrom"),max:u,"data-testid":"filter-dateFrom",placeholder:m?"":"Select Date",className:N(e.isSafari&&E.dateForSafari,m?E.dateHaveValue:E.dateNotHaveValue)})}),o(_,{children:o(V,{type:"date",label:"Date To",...t("dateTo"),min:r,"data-testid":"filter-dateTo",placeholder:g?"":"Select Date",className:N(e.isSafari&&E.dateForSafari,g?E.dateHaveValue:E.dateNotHaveValue)})})]})}),!d&&o($,{alignment:"left",className:z,children:o(x,{intent:"primary",onClick:()=>l(L),children:"Reset"})})]})},S={type:"marketingMode",priceFrom:"buying.priceFrom",priceTo:"buying.priceTo",rentFrom:"renting.rentFrom",rentTo:"renting.rentTo",dateFrom:"created",dateTo:"created"},F="YYYY-MM-DD",gt=(e,t)=>{let a=[];return Object.keys(t).forEach(n=>{const l=a!=null&&a.length||"type"in t?a:e;let i=[];return n==="type"&&(i=e.filter(r=>h.get(r,S[n])===t[n])),(n==="priceTo"||n==="priceFrom")&&(i=l.filter(r=>{const u=r.marketingMode==="renting"?n.replace(/price/i,"rent"):n;if("priceFrom"in t&&"priceTo"in t){const d=Number(t.priceFrom),m=Number(t.priceTo);if(d>m)return!1;if(r.marketingMode==="renting"){const b=h.get(r,S.rentFrom),A=h.get(r,S.rentTo);return(h.inRange(b,d,m)||b===d)&&(h.inRange(A,d,m)||A===m)}const g=h.get(r,S.priceFrom),f=h.get(r,S.priceTo);return(h.inRange(g,d,m)||g===d)&&(h.inRange(f,d,m)||f===m)}return u==="priceFrom"||u==="rentFrom"?h.get(r,S[u])>=Number(t[n]):h.get(r,S[u])<=Number(t[n])})),(n==="dateFrom"||n==="dateTo")&&(i=l.filter(r=>{const u=p(h.get(r,S[n])),d=p(t[n]);if("dateFrom"in t&&"dateTo"in t){const m=p(t.dateFrom).format(F),g=p(t.dateTo).format(F);return p(u.format(F)).isBetween(m,p(g),"day","[]")}return n==="dateFrom"?p(u.format(F)).isSameOrAfter(d.format(F),"day"):p(u.format(F)).isSameOrBefore(d.format(F),"day")})),a=[...i],a}),h.uniqBy(a,"id")},H=e=>{let t=typeof e=="string"?e.replace(he,"").toLowerCase():e;return typeof t=="string"&&(t.includes("k")?t=+t.replace(/.$/,"")*1e3:t.includes("m")&&(t=+t.replace(/.$/,"")*1e6)),t},ht=e=>{let t={};if(e!=null&&e.type&&(["sales","lettings"].includes(e.type)&&(t=Object.assign(t,{type:(e==null?void 0:e.type)==="sales"?"buying":"renting"})),["buying","renting"].includes(e.type)&&(t=Object.assign(t,{type:e==null?void 0:e.type}))),e!=null&&e.priceFrom){const a=H(e.priceFrom);a&&(t=Object.assign(t,{priceFrom:a}))}if(e!=null&&e.priceTo){const a=H(e.priceTo);a&&(t=Object.assign(t,{priceTo:a}))}if(e!=null&&e.dateFrom){const a=p.utc(e.dateFrom).local().format(F);a&&a!=="Invalid Date"&&(t=Object.assign(t,{dateFrom:a}))}if(e!=null&&e.dateTo){const a=p.utc(e.dateTo).local().format(F);a&&a!=="Invalid Date"&&(t=Object.assign(t,{dateTo:a}))}return t},ft=e=>{let t={};const a="DD-MM-YYYY";if(e!=null&&e.type&&(["buying","renting"].includes(e.type)?t=Object.assign(t,{type:(e==null?void 0:e.type)==="buying"?"sales":"lettings"}):t=Object.assign(t,{type:e==null?void 0:e.type})),e!=null&&e.priceFrom){const n=H(e.priceFrom);n&&(t=Object.assign(t,{priceFrom:n}))}if(e!=null&&e.priceTo){const n=H(e.priceTo);n&&(t=Object.assign(t,{priceTo:n}))}if(e!=null&&e.dateFrom){const n=p.utc(e.dateFrom).local().format(a);n&&n!=="Invalid Date"&&(t=Object.assign(t,{dateFrom:n}))}if(e!=null&&e.dateTo){const n=p.utc(e.dateTo).local().format(a);n&&n!=="Invalid Date"&&(t=Object.assign(t,{dateTo:n}))}return t},pt=()=>{var J,Q;const{isMobile:e,isTablet:t}=k(),{params:a,encodeParamsAndAssignToURL:n}=le(),l=ae(a==null?void 0:a.q),{Modal:i,openModal:r,closeModal:u}=Re(),[d,m]=w.useState(l.type?l.params:{}),[g,f]=w.useState(+a.page),{register:b,watch:A,formState:{errors:v},setValue:j}=ee({defaultValues:{searchInput:a==null?void 0:a.q},resolver:Ye(ct),mode:"all"}),C=ee({mode:"all"}),{getValues:fe,watch:pe,reset:K,setValue:D}=C,Te=pe(["type","dateFrom","dateTo","priceFrom","priceTo"]),{data:c,isFetching:R,isError:B,error:G}=dt({...d,pageNumber:g},{enabled:!!Object.keys(d).length&&!Object.keys(v).length&&!!A("searchInput")&&Number.isInteger(g)&&g>=1});O.useEffect(()=>{if(a.page&&(!Number.isInteger(+(a==null?void 0:a.page))||+(a==null?void 0:a.page)<1)){const y={...a,page:1};n(y),f(1)}},[]),O.useEffect(()=>{j("searchInput",a.q,{shouldValidate:!0}),m(l.type?l.params:{}),f(a.page?+a.page:1)},[a.page,a.q]),O.useEffect(()=>{var y;if((y=c==null?void 0:c._embedded)!=null&&y.length&&(a!=null&&a.q)){const s=ht(h.omit(a,["q","page"]));s!=null&&s.type&&D("type",s.type),s!=null&&s.priceFrom&&D("priceFrom",s==null?void 0:s.priceFrom),s!=null&&s.priceTo&&D("priceTo",s==null?void 0:s.priceTo),s!=null&&s.dateFrom&&D("dateFrom",s==null?void 0:s.dateFrom),s!=null&&s.dateTo&&D("dateTo",s==null?void 0:s.dateTo)}},[a.page,a.q,c]);const ye=w.useMemo(()=>h.debounce(y=>{const{value:s}=y.target,{params:M,type:P}=ae(s);if(!P)return;K(L),f(1),m(M),n({q:s,page:1})},ze),[]),be=w.useMemo(()=>{var M;const y=(c==null?void 0:c._embedded)??[],s=fe();if(rt(s),(M=c==null?void 0:c._embedded)!=null&&M.length){const P=ft(s),X={q:a==null?void 0:a.q,page:(a==null?void 0:a.page)||1,...P};n(X)}return Object.keys(s).length?[!0,gt(y,s)]:[!1,[]]},Te);return T(Ke,{prefixTestId:"sp",secondaryContent:(()=>{var y;if(!R&&((y=c==null?void 0:c._embedded)!=null&&y.length))return o(te,{...C,children:o(se,{})})})(),children:[e&&!R&&!!((J=c==null?void 0:c._embedded)!=null&&J.length)&&o(Z,{isFlexJustifyEnd:!0,children:o($,{alignment:"right",children:o(x,{intent:"default",onClick:r,children:"Filters"})})}),o(Oe,{className:q.title,children:"New Registration"}),o(re,{hasGreyText:!0,className:q.subtitle,children:"Please enter applicant's details in the search field to verify if any record already exists"}),o(ie,{className:q.formLayout,children:T(_,{children:[o(V,{...b("searchInput",{onChange:ye}),"data-testid":"sp-search-field",type:"search",icon:"searchSystem",placeholder:"First Name, Surname, Email or Postcode"}),o(st,{message:(Q=v.searchInput)==null?void 0:Q.message})]})}),T(i,{title:"Filters",children:[o(te,{...C,children:o(se,{})}),T($,{alignment:"center",className:"el-mt8",children:[o(x,{intent:"default",onClick:()=>{K(L)},children:"Reset"}),o(x,{fixedWidth:!0,intent:"primary",onClick:u,children:"Close"})]})]}),R&&o(xe,{"data-testid":"search-page-loader",className:N(_e,z)}),!R&&!c&&!B&&o("div",{style:{height:"63px"}}),!c&&!B&&T(W,{children:[o(Y,{isExpanded:!0,intent:"neutral",isInline:!0,isFullWidth:!0,"data-testid":"search-page-announcement",className:N(e&&Ve),children:"Let us double-check if we already hold any records on our database to save you some time."}),e&&o(Z,{isFlexJustifyCenter:!0,children:o("img",{className:N("el-mt6",q.logo),src:Je,alt:"Applicant Registration Logo"})})]}),!!c&&!R&&o(ut,{searchParam:d,data:c,pageState:[g,f],filterState:be}),B&&o(Y,{className:e?N(U,ve):U,isExpanded:!0,isInline:!0,intent:"danger",isFullWidth:e||t,"data-testid":"search-page-error",children:(G==null?void 0:G.readableMessage)??We.DEFAULT})]})},Ht=pt;export{Ht as default};
