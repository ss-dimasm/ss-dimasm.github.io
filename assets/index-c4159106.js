import{a as T,j as n,F as ce}from"./index-b3f50da9.js";import{k as me,V as ue,n as he,x as Ne,y as Me,aS as Pe,o as Z,v as be,r as E,h as ee,j as de,a2 as V,i as G,F as j,e as w,ae as ye,aT as fe,u as ge,f as ve,K as ke}from"./elements-7fcf5525.js";import{u as De,H as te,c as Q,q as xe,j as x,m as _e,V as ne,W as oe,d as v,a as Re,t as Le,a2 as Oe,$ as K,a1 as U,l as Ue,g as we,N as Ve,X as Be}from"./app-1088c2df.js";import{c as O,a as _,o as He}from"./index.esm-c689e26d.js";import{a as z,u as $e,F as We}from"./index.esm-70abc844.js";import{F as Ye}from"./feedback-button-10b39ca0.js";import{u as Ge,a as je}from"./index-706e92ed.js";import{u as qe}from"./index-3010b16e.js";import{u as re,A as Se}from"./configuration-ddeef3ff.js";import{T as Qe,p as le,a as ze}from"./appointment-card.helpers-60607de9.js";import{a as Je}from"./use-frequently-appointment-update-895837db.js";import{s as Xe,E as W}from"./extended-yup-validation-e62a953f.js";import{I as Ke}from"./input-error-f3e61811.js";import{a as Ze,u as et,S as J,g as tt,b as nt}from"./search-attendee.helper-76fe97bb.js";import{M as q}from"./modal-dialog-0e8fb4f7.js";import{U as ot}from"./url-ce1d32f5.js";import{c as rt}from"./index-8f0c1425.js";import{a as at}from"./index-230a9ce9.js";import{S as X}from"./index-35dae0a4.js";import"./index-6d471c01.js";import"./index-77752724.js";import"./with-plugins-a1c7cafe.js";import"./isBetween-bb99a4b7.js";import"./isSameOrAfter-571fd34c.js";import"./index-fa19f396.js";import"./index-c5c95794.js";import"./search-results.helpers-7bbf52a9.js";import"./routes-4ccd8c9c.js";import"./rooms-naming-0ec8ee01.js";import"./regex-aa179d17.js";import"./useInfiniteQuery-a457b465.js";import"./helper-ac9457cc.js";import"./property-owner-1850ad04.js";const Ie=e=>{const t="dummy";e.value="dummy-changed-value";const o=e._valueTracker;o&&o.setValue(t),e.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!1}))};function it(){var S,C,u;const e=z(),[t,,]=re(),o=De(),{trackEvent:r}=te(),{state:i}=Q(),a=xe(),l=e.getValues("negotiatorIds"),p=l!=null&&l.length?l[0]:"",[d,,]=qe(p,{fetchWhenTrue:[p]}),f=(I,s,h)=>{const y=I==="h"?+s:h.h,F=I==="m"?+s:h.m,N=30;let M=y,m=F+N;m>59&&(M+=1,m-=60),e.setValue("localFields.appointmentDateForm.endTime",`${le(M)}:${le(m)}`)},[c,,,{isLoading:g}]=Ge({shouldReturnRecord:!0,onSuccess:I=>{Je(I,a),o(`/${I.id}`,{replace:!0,state:{isNewAppointment:!0}})},successMessage:`New appointment is created ${d!=null&&d.name?`for ${d==null?void 0:d.name}`:""}`.trim()}),A=()=>{var h,y,F,N;const I=e.getValues(),s=yt(I,i);r(ne.CREATE_FORM_DATA,{...oe("DIARY"),Name:"Create Appointment",Action:"Create appointment form data","Appointment Type":(y=(h=t==null?void 0:t.appointmentTypes)==null?void 0:h.find(M=>M.id===s.typeId))==null?void 0:y.value,"Property ID":(s==null?void 0:s.propertyId)??"Skipped","Attendee ID":((F=s==null?void 0:s.attendee)==null?void 0:F.id)??"Skipped","Attendee Type":((N=s==null?void 0:s.attendee)==null?void 0:N.type)??"Skipped"})(),c(s)};return T("div",{"data-testid":"step-four-container",children:[n(me,{hasMargin:!0,children:n(ue,{children:n(he,{type:"date",label:"Select appointment date","data-testid":"appointment-date-input",...e.register("localFields.appointmentDateForm.date"),errorMessage:(u=(C=(S=e.formState.errors.localFields)==null?void 0:S.appointmentDateForm)==null?void 0:C.date)==null?void 0:u.message})})}),n(Qe,{onTimeChange:f,label:"Select appointment time",name:"localFields.appointmentDateForm.startTime",className:"el-flex1"}),n(Ne,{className:"el-mt10",children:n(Me,{"data-testid":"create-appointment-button",intent:"primary",type:"button",onClick:A,disabled:g||x(_e.omit(e.formState.errors,["propertyId","attendee"])),children:"Create Appointment"})})]})}function st(){var i,a;const e=z(),[t,,{isLoading:o,isError:r}]=re();return o||r||!((i=t==null?void 0:t.appointmentTypes)!=null&&i.length)?null:n("div",{"data-testid":"step-one",children:n(me,{className:Pe,children:n(ue,{children:T(he,{children:[n(Z,{children:"Choose an appointment type"}),T(be,{"data-testid":"appointment-types-options",...e.register("typeId"),children:[n("option",{disabled:!!e.watch("typeId"),value:"",children:"Select appointment type"}),Xe(t==null?void 0:t.appointmentTypes).map(l=>n("option",{value:l.id,children:l.value},l.id))]}),n(Ke,{message:(a=e.formState.errors.typeId)==null?void 0:a.message})]})})})})}const Ee=({selectedId:e,attendeeType:t})=>{const o=E.useMemo(()=>{const r={start:v().toISOString(),end:v().add(4,"weeks").toISOString(),sortBy:"+start"};return e?t?{...r,attendeeId:[e],attendeeType:t}:{...r,propertyId:[e]}:r},[e,t]);return je({queryParams:o,fetchWhenTrue:[e],encodeParam:!0})},dt=(e,t)=>{const o=[];if(t==="attendee"){const r=(e==null?void 0:e.contacts)&&e.contacts.length>1&&e.contacts.slice(1);r&&r.length&&r.map(({name:i})=>i&&o.push(i))}return t==="property"&&e!=null&&e.contacts&&e.contacts.length&&e.contacts.map(({name:r})=>r&&o.push(r)),o};function Te({data:e,isLoading:t=!1,cardType:o}){const[r]=re();return t?n(ee,{label:"Loading data"}):e!=null&&e.length?T("div",{children:[n(de,{"data-testid":"upcoming-appointment-title",children:"Upcoming appointments"}),e.map(({id:i,typeId:a,start:l,attendee:p})=>{const d=dt(p,o);return n(ce,{children:T(V,{hasGreyText:!0,children:[`At ${v(l).format("HH:mm")} on ${v(l).format("DD/MM/YY")} for `,n("b",{children:ze(a,r)}),!!d.length&&` with ${d.join(", ")}`]},i)})})]}):n(de,{children:"No upcoming appointments"})}const lt=({attendeeId:e,attendeeType:t})=>Re({fetchWhenTrue:[e,t],path:t?`${ot[Ze[t]]}/${e}`:""});function pt(){var ie,se;const{trackEvent:e}=te(),{watch:t,setValue:o,getValues:r}=z(),{state:i}=Q(),{attendee:a}=t(),l=(a==null?void 0:a.id)!==void 0||(a==null?void 0:a.type)!==void 0,p=E.useRef(null),[{searchInput:d,applicantType:f,attendeeType:c},g]=E.useState({searchInput:null,applicantType:"sales",attendeeType:"applicant"}),[A,S]=E.useState({}),C=!!Object.keys(A).length,{data:u,isFetching:I,error:s,isError:h}=et({type:c,searchInput:d,marketingMode:f,options:{enabled:!!d&&!!c&&!C},pageSize:25}),[y,,{isLoading:F}]=Ee({selectedId:(a==null?void 0:a.id)??"",attendeeType:a==null?void 0:a.type}),N=G("root"),M=G("root"),[m,k]=E.useState(r("localFields.selectedAttendee")),[P]=lt({attendeeId:(ie=i==null?void 0:i.confirmation)!=null&&ie.includeAttendee?a==null?void 0:a.id:"",attendeeType:a==null?void 0:a.type});E.useEffect(()=>{P&&k(P)},[P]);const B=!((se=u==null?void 0:u.pages)!=null&&se.length)||!u.pages[0]._embedded.length||s instanceof Le,H=b=>{k(b),N.openModal()},$=()=>{o("attendee.id",m==null?void 0:m.id),o("attendee.type",c),o("localFields.selectedAttendee",m)},D=()=>{M.openModal()},R=()=>{o("attendee.id",void 0),o("localFields.selectedAttendee",void 0),o("attendee.type",void 0),k(void 0)},Fe=()=>{o("attendee.id",""),o("attendee.type",""),o("localFields.selectedAttendee",void 0)};E.useEffect(()=>{Ie(p.current)},[a==null?void 0:a.id]);const ae=()=>{e(ne.INTERACTION_SECTION,{...oe("DIARY"),Name:"New Appointment Attendee Pane Expand Button",Action:Se.OPEN_UPCOMING_APPOINTMENT,"Event Type":"Click"})()};return T("div",{children:[n("input",{ref:p,name:"attendee-field",style:{display:"none"}}),l?m!=null&&m.id?T("div",{"data-testid":"step-three-edit-container",children:[n(Z,{onClick:D,children:"Press attendee to remove"}),n(J.Table,{data:[{_embedded:[m??{id:""}]}],onCardClick:D,attendeeType:a.type?a.type:c,expandableLabel:"Upcoming appointments",expandableContent:!!m&&n(Te,{isLoading:F,data:y==null?void 0:y._embedded,cardType:"attendee"}),onExpand:ae})]}):n(ye,{onClick:R,children:n(fe,{className:"el-p5",children:T(j,{isFlexAlignCenter:!0,children:[n(ge,{icon:"usernameSolidSystem",intent:"neutral",fontSize:"1.3rem"}),n(V,{hasNoMargin:!0,intent:"neutral",className:"el-ml5",children:"Add attendee"})]})})}):T("div",{style:{position:"relative"},"data-testid":"step-three-select-container",children:[n(J.Form,{searchFieldLabel:"Select attendee or skip this step",searchFieldPlaceholder:"Search name or contact details",onSearchFieldChange:b=>{g(L=>({...L,searchInput:tt(b,c)}))},onApplicantTypeChange:b=>{g(L=>({...L,applicantType:b}))},onAttendeeTypeChange:b=>{g(L=>({...L,attendeeType:b}))},subscribeToFormErrorState:S,headerContent:n(j,{isFlexJustifyEnd:!0,children:n(V,{hasNoMargin:!0,hasBoldText:!0,intent:"primary",onClick:Fe,"data-testid":"step-three-skip-link",children:"Skip"})})}),C?n(w,{className:"el-mt8",isExpanded:!0,intent:"danger",isInline:!0,isFullWidth:!0,children:Object.values(A)[0].message}):I?n(ee,{"data-testid":"search-attendee-loader",className:"el-mt8 el-mb10"}):h?n(w,{className:"el-mt8",isExpanded:!0,intent:"danger",isInline:!0,isFullWidth:!0,children:(s==null?void 0:s.readableMessage)||Oe.DEFAULT}):u===void 0?n(ce,{}):B?n(w,{className:"el-mt8",isExpanded:!0,intent:"default",isInline:!0,isFullWidth:!0,children:"No result!"}):n(J.Table,{data:u==null?void 0:u.pages.flatMap(b=>b),attendeeType:c,onCardClick:H,onExpand:ae})]}),n(q,{ModalInstance:N,title:"Select Attendee",message:`Select ${nt(c,m).name}?`,ctaIntent:"primary",ctaMessage:"Yes",ctaConfirmFn:$,"data-testid":"select-attendee-modal"}),n(q,{ModalInstance:M,title:"Edit Attendee",message:"Do you want to change the selected attendee?",ctaIntent:"primary",ctaMessage:"Yes",ctaConfirmFn:R,"data-testid":"edit-attendee-modal"})]})}function ct(){var H,$;const{trackEvent:e}=te(),{setValue:t,watch:o}=z(),{state:r}=Q(),{propertyId:i,localFields:a}=o(),l=i!==void 0,p=E.useRef(null),[d,f]=E.useState({pageNumber:1,pageSize:25,address:"",sortBy:"-created",marketingMode:["selling"],embed:["landlord","vendor"]}),[c,g,{isError:A,isFetching:S,isSuccess:C}]=at({queryParams:d,fetchWhenTrue:[d.address]}),u=G("root"),I=G("root"),[s,h]=E.useState((H=r==null?void 0:r.confirmation)!=null&&H.includeProperty?($=r==null?void 0:r.appointment._embedded)==null?void 0:$.property:a==null?void 0:a.selectedProperty),[y,,{isLoading:F}]=Ee({selectedId:s==null?void 0:s.id}),N=()=>{t("propertyId",""),t("localFields.selectedProperty",void 0)},M=D=>{h(D),u.openModal()},m=()=>{t("propertyId",s==null?void 0:s.id),t("localFields.selectedProperty",s)};E.useEffect(()=>{Ie(p.current)},[i]);const k=()=>{I.openModal()},P=()=>{t("propertyId",void 0),t("localFields.selectedProperty",void 0),h(void 0)},B=()=>{e(ne.INTERACTION_SECTION,{...oe("DIARY"),Name:"New Appointment Property Pane Expand Button",Action:Se.OPEN_UPCOMING_APPOINTMENT,"Event Type":"Click"})()};return T("div",{children:[n("input",{name:"property-field",ref:p,style:{display:"none"}}),l?s!=null&&s.id?T("div",{"data-testid":"step-two-edit-container",children:[n(Z,{onClick:k,children:"Press property to remove"}),n(X.Table,{data:[s??{id:""}],onCardClick:k,marketingMode:s==null?void 0:s.marketingMode[0],expandableLabel:"Upcoming appointments",expandableContent:!!s&&n(Te,{isLoading:F,data:y==null?void 0:y._embedded,cardType:"property"}),onExpand:B})]}):n(ye,{onClick:P,children:n(fe,{className:"el-p5",children:T(j,{isFlexAlignCenter:!0,children:[n(ge,{icon:"homeSolidSystem",intent:"neutral",fontSize:"1.3rem"}),n(V,{hasNoMargin:!0,intent:"neutral",className:"el-ml5",children:"Add property"})]})})}):T("div",{style:{position:"relative"},"data-testid":"step-two-select-container",children:[n(X.Form,{searchFieldLabel:"Select property or skip this step",onMarketingModeFieldChange:D=>{f(R=>({...R,marketingMode:D,pageNumber:1}))},onAddressFieldChange:D=>{f(R=>({...R,address:D,pageNumber:1}))},headerContent:n(j,{isFlexJustifyEnd:!0,children:n(V,{hasNoMargin:!0,hasBoldText:!0,intent:"primary",onClick:N,"data-testid":"step-two-skip-link",children:"Skip"})})}),S?n(ee,{"data-testid":"add-properties-loader",className:"el-mb10 el-mt8"}):C&&!x(c==null?void 0:c._embedded)?n(w,{"data-testid":"not-found-properties-list",intent:"default",isExpanded:!0,isInline:!0,isFullWidth:!0,children:"No result!"}):A?n(w,{"data-testid":"error-properties-list",intent:"danger",isExpanded:!0,isInline:!0,isFullWidth:!0,children:g==null?void 0:g.readableMessage}):x(c==null?void 0:c._embedded)&&n(X.Table,{data:(c==null?void 0:c._embedded)??[],onCardClick:M,marketingMode:d.marketingMode[0],onExpand:B})]}),n(q,{ModalInstance:u,title:"Select Property",message:`Select ${rt(s==null?void 0:s.address)}?`,ctaIntent:"primary",ctaMessage:"Yes",ctaConfirmFn:m,"data-testid":"select-property-modal"}),n(q,{ModalInstance:I,title:"Edit Property",message:"Do you want to change the selected property?",ctaIntent:"primary",ctaMessage:"Yes",ctaConfirmFn:P,"data-testid":"edit-property-modal"})]})}const Ae=["VL","ES","IA"],Ce=["ME","HY"],mt=({appointmentType:e,includeProperty:t,includeAttendee:o,fromExternalApp:r=!1})=>{const i=[st,ct,pt,it];return!t&&o&&!r?i.splice(1,1):!o&&t&&!r?i.splice(2,1):o&&t&&!r||(Ae.includes(e)?i.splice(2,1):Ce.includes(e)&&i.splice(1,2)),i.map((l,p)=>({item:(++p).toString(),content:n(l,{})}))},Y=[["typeId"],["propertyId"],["attendee.id"],["localFields.appointmentDateForm"]],ut=["typeId","property-field","attendee-field"],ht=({trigger:e,maxSteps:t,stepState:[o,r]})=>async i=>{const{name:a}=(i==null?void 0:i.target)??{},l=Y[o-1];if(!x(l)||!x(a)||!ut.includes(a)||o>1&&a==="typeId")return;let p=1;for(let d=0;d<Y.length;d++){const f=Y[d];if(!await e(f)||d===Y.length-1){p=d+1;break}}r(p>=t?t:p)},yt=(e,t)=>{var y,F;const{confirmation:o,appointment:r}=t??{},i=["localFields"];r!=null&&r.id?(!(o!=null&&o.includeAttendee)&&i.push("attendee"),!(o!=null&&o.includeProperty)&&i.push("propertyId")):(Ae.includes(e==null?void 0:e.typeId)&&i.push("attendee"),Ce.includes(e==null?void 0:e.typeId)&&i.push("attendee","propertyId"));const a=U.omit(e,i),{date:l,startTime:p,endTime:d}=e.localFields.appointmentDateForm,f=v(l),[c,g]=p.split(":"),A=f.hour(+c).minute(+g),[S,C]=d.split(":"),u=f.hour(+S).minute(+C),I=!i.includes("attendee")&&x((y=e==null?void 0:e.attendee)==null?void 0:y.id)&&x((F=e==null?void 0:e.attendee)==null?void 0:F.type)?e==null?void 0:e.attendee:void 0,s=N=>{const M=["typeId","attendee.id","attendee.type","propertyId"];let m=e;return N==="previous"&&(m=r),M.reduce((k,P)=>({...k,[P]:U.get(m,P)}),{})},h={accompanied:!0,virtual:!1,isRepeat:!1};return!U.isEmpty(t)&&U.isEqual(s("current"),s("previous"))&&(o!=null&&o.includeAttendee)&&(o!=null&&o.includeProperty)&&(h.accompanied=r==null?void 0:r.accompanied,h.virtual=r==null?void 0:r.virtual,h.isRepeat=!0),{...a,start:A.toISOString(),end:u.toISOString(),followUpOn:A.add(2,"day").format(K),attendee:I,...h}},pe=({state:e})=>{var o,r,i,a,l;const t=!!((o=e==null?void 0:e.appointment)!=null&&o.id);return{typeId:(r=e==null?void 0:e.appointment)==null?void 0:r.typeId,accompanied:!0,followUpOn:v().add(2,"days").format(K),propertyId:t?e.confirmation.includeProperty?e==null?void 0:e.appointment.propertyId:"":void 0,attendee:t?e.confirmation.includeAttendee?e==null?void 0:e.appointment.attendee:{id:"",type:""}:void 0,localFields:{appointmentDateForm:{date:v((i=e==null?void 0:e.preparedData)==null?void 0:i.date).format(K),startTime:(a=e==null?void 0:e.preparedData)!=null&&a.date?v(e.preparedData.date).format("HH:mm"):"12:00",endTime:(l=e==null?void 0:e.preparedData)!=null&&l.date?v(e.preparedData.date).add(30,"minutes").format("HH:mm"):"12:30"}}}},ft=O().shape({typeId:_().required(W.INVALID_OPTION),propertyId:_().shouldBeThruty(),attendee:O().shape({id:_().shouldBeThruty()}),followUp:O().shape({due:_().shouldExceed("localFields.appointmentDateForm.date")}),localFields:O().shape({appointmentDateForm:O().shape({date:_().required(W.FIELD_REQUIRED),startTime:_().required(W.FIELD_REQUIRED).shouldNotExceed("localFields.appointmentDateForm.endTime"),endTime:_().required(W.FIELD_REQUIRED).shouldExceed("localFields.appointmentDateForm.startTime")})})});function Jt(){var g,A;const{params:e}=Ue(),{state:t}=Q(),o=we(),r=!!((g=t==null?void 0:t.appointment)!=null&&g.id),i=$e({defaultValues:pe({state:t}),resolver:He(ft),mode:"all"}),[a]=i.watch(["typeId"]),l=mt({appointmentType:a,...t==null?void 0:t.confirmation,fromExternalApp:t==null?void 0:t.fromExternalApp}),p=l.length,[d,f]=E.useState(r?p:(A=t==null?void 0:t.appointment)!=null&&A.typeId?2:1);E.useEffect(()=>{i.reset(pe({state:t})),o.connectSession().then(S=>{const C=S==null?void 0:S.loginIdentity.userCode;C&&i.setValue("negotiatorIds",[C])})},[o,t]),E.useEffect(()=>{d>p&&f(p)},[p,d]);const c=ht({trigger:i.trigger,stepState:[d,f],maxSteps:p});return x(e)?n(Ve,{to:Be.NEW_APPOINTMENT,state:{...U.mapValues(e,S=>JSON.parse(S)),fromExternalApp:!0},replace:!0}):T(ve,{children:[n(We,{...i,children:n("form",{onChange:c,children:n(ke,{steps:l,selectedStep:d.toString(),className:"el-mb12"})})}),n(Ye,{})]})}export{Jt as default};
