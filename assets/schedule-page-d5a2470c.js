import{j as w,a as W,F as ue}from"./index-b3f50da9.js";import{Z as re,r as p,bk as me,bl as pe,C as fe,e as se,I as $,G as Ee,ba as he,h as Y,x as Se,y as X}from"./elements-7fcf5525.js";import{d as A,q as z,g as ye,P as R,r as q,i as Ae,a6 as Ie,a7 as Te,a8 as we,ab as J,m as x,k as Oe,a2 as Z,u as ne,H as oe,t as De,j as U,V as ie,W as ce,Y as ae,D as L,ac as le,l as ge,J as be,aa as Ne}from"./app-1088c2df.js";import{Q as v,U as V}from"./url-ce1d32f5.js";import{i as ve}from"./index-03408514.js";import{w as ee,G as Re,g as K,D as _e}from"./drawer-body-appointment-details-6898b557.js";import{i as Pe,a as ke}from"./isSameOrAfter-571fd34c.js";import{i as Me}from"./isBetween-bb99a4b7.js";import{b as xe,a as Fe,c as H,g as Ce}from"./appointment-card.helpers-60607de9.js";import{e as Ge}from"./all-confirmed-section.helpers-eee887a0.js";import{w as te}from"./index-c5c95794.js";import{u as Le}from"./index-230a9ce9.js";import{A as Be}from"./appointment-card-82b17dcf.js";import{u as Ve}from"./configuration-ddeef3ff.js";import{g as He}from"./property-owner-1850ad04.js";import"./index-0d5dc733.js";import"./index-fa19f396.js";import"./index.esm-70abc844.js";import"./index-8f0c1425.js";import"./index-7fcc6ec2.js";import"./index-b6bc85a8.js";import"./index-77752724.js";A.extend(Pe);A.extend(ke);A.extend(Me);const G=(e,n)=>{if(e.isSame(n,"day"))return[];let l=0;const h=[];for(;e.add(l,"day").isSameOrBefore(n,"day");)h.push(e.add(l,"day")),l++;return h},Ye=e=>{const n=z(),l=ye(),{error:h}=re(),[d,s]=p.useState(!1),i=p.useCallback(async(o,m)=>{try{if(d)return;s(!0);const a=A(o,R),c=G(a.subtract(2,"week").startOf("week"),a.add(3,"week").endOf("week")),u=await Q({DATES_RANGE:c,reapitConnectBrowserSession:l,queryClient:n});m.scrollTo({top:m.clientHeight+m.scrollTop-window.innerHeight+60,behavior:"auto"}),await ee(0),n.setQueryData(v.APPOINTMENT.seamlessScroll,u)}catch(a){let c=Z.ERR_NETWORK;q(a)&&(c=a.readableMessage),console.error(a),h(c)}s(!1)},[d,l,n]),E=p.useCallback(async(o,m)=>{try{if(d)return;s(!0);const a=A(o,R),c=G(a.subtract(3,"week").startOf("week"),a.add(2,"week").endOf("week")),u=await Q({DATES_RANGE:c,reapitConnectBrowserSession:l,queryClient:n});await ee(0),m.scrollTo({top:30,behavior:"auto"}),s(!1),n.setQueryData(v.APPOINTMENT.seamlessScroll,u)}catch(a){s(!1);let c=Z.ERR_NETWORK;q(a)&&(c=a.readableMessage),console.error(a),h(c)}},[d,l,n]);return{...Ae({enabled:!!l,queryKey:v.APPOINTMENT.seamlessScroll,cacheTime:1/0,queryFn:async()=>{const o=A(e),m=G(o.startOf("week"),o.endOf("week")),a=m[m.length-1],c=m[0],u=[...G(c.subtract(1,"day").startOf("week"),c.subtract(1,"day").endOf("week")),...m,...G(a.add(1,"day").startOf("week"),a.add(1,"day").endOf("week"))];return await Q({DATES_RANGE:u,reapitConnectBrowserSession:l,queryClient:n})}}),isScrollUpOrDownLoading:d,onScrollUp:i,onScrollDown:E}},Q=async e=>{var n,l,h,d;try{const{reapitConnectBrowserSession:s,queryClient:i,DATES_RANGE:E}=e,f=await s.connectSession(),o=await Ie(s);if(!o||!f)throw new Te({description:we});const m=f==null?void 0:f.loginIdentity,a={start:E[0].set("hours",0).set("minutes",0).set("milliseconds",0).set("seconds",0).toISOString(),end:E[E.length-1].set("hours",23).set("minutes",59).set("seconds",59).set("milliseconds",999).toISOString(),negotiatorId:[m==null?void 0:m.userCode],pageSize:100},c=new Re({maxConcurrentCalls:5,waitBetweenCallsInterval:2500,endpoint:V.APPOINTMENTS,params:a,headers:o});await c.run();const u=[],g=[],I=[];for(const t of c.results)for(const r of(t==null?void 0:t._embedded)??[])r.start&&(r.start=J(r.start)),r.end&&(r.end=J(r.end)),r.otherAgentId&&g.push(r.otherAgentId),(n=r==null?void 0:r.negotiatorIds)!=null&&n[0]&&u.push(r.negotiatorIds[0]),r!=null&&r.propertyId&&I.push(r.propertyId);await K({recordsId:u,queryClient:i,reapitConnectBrowserSession:s,queryKey:v.NEGOTIATOR.single,endpoint:V.NEGOTIATORS}),await K({recordsId:g,queryClient:i,reapitConnectBrowserSession:s,queryKey:v.COMPANY.single,endpoint:V.COMPANIES}),await K({recordsId:I,queryClient:i,reapitConnectBrowserSession:s,queryKey:v.PROPERTY.single,endpoint:V.PROPERTIES,additionalQueryParams:{embed:["landlord","vendor"]},onSetData:t=>{var r,D;i.setQueryData(v.PROPERTY.single(t.id),t),(r=t._embedded)!=null&&r.landlord&&i.setQueryData(v.LANDLORD.single(t._embedded.landlord.id),t._embedded.landlord),(D=t._embedded)!=null&&D.vendor&&i.setQueryData(v.VENDOR.single(t._embedded.vendor.id),t._embedded.vendor)}});const O=c.results.flatMap(t=>(t==null?void 0:t._embedded)??[]),T=O.filter(t=>!t.recurring),y=E.map(t=>[t.format(R),[]]);for(let t=0;t<T.length;t++){const r=A(T[t].start).format(R),D=y.findIndex(([S])=>S===r);D===-1?y.push([r,[T[t]]]):y[D][1].push(T[t])}const F=O.filter(t=>t.recurring),C=[];for(let t=0;t<F.length;t++){const r=F[t],D=A(r.start),S=A(y[0][0],R),b=A(y[y.length-1][0],R);let N=0;const P=(l=r.recurrence)==null?void 0:l.interval,M={monthly:"month",weekly:"week",daily:"day",yearly:"year"}[(h=r.recurrence)==null?void 0:h.type];for(;D.add(N,M).isSameOrBefore(b);){const _=D.add(N,M),B=_.format(R);if(N+=P,!(!_.isBetween(S,b,"date")||(d=r.recurrence)!=null&&d.until&&_.isAfter(A(r.recurrence.until),"date"))){const j=C.findIndex(([de])=>de===B);j===-1?C.push([B,[r]]):C[j][1].push(r)}}}const k=x.cloneDeep(y);for(let t=0;t<C.length;t++){const[r,D]=C[t],S=k.findIndex(([b])=>b===r);S===-1?k.push([r,D]):k[S][1].push(...D)}return k.map(([t,r])=>{const D=A(t,R);return r.map(S=>{if(S.localFields={customStartDate:S.start,customEndDate:S.end},S.recurring){const b=M=>({h:A(M).get("hour"),m:A(M).get("minute"),s:A(M).get("second")}),N=b(S.start),P=b(S.end);S.localFields.customStartDate=D.set("hours",N.h).set("minutes",N.m).set("seconds",N.s).toISOString(),S.localFields.customEndDate=D.set("hours",P.h).set("minutes",P.m).set("seconds",P.s).toISOString()}return S.localFields.appointmentDateForm=Ge(S.localFields.customStartDate,S.localFields.customEndDate),S}),r==null?void 0:r.sort((S,b)=>{var N,P;return A((N=S==null?void 0:S.localFields)==null?void 0:N.customStartDate).diff(A((P=b==null?void 0:b.localFields)==null?void 0:P.customStartDate))})}),k.forEach(([,t])=>{t.forEach(r=>{i.setQueryData(v.APPOINTMENT.single(r==null?void 0:r.id),r)})}),k}catch(s){throw ve(s)?Oe(s):q(s)?s:new Error(s)}},Ue=({data:e,contactDetailsDrawerHandler:n})=>{const l=ne(),{trackEvent:h}=oe(),d=z(),{error:s}=re(),[i]=Le((e==null?void 0:e.propertyId)??"",{onError:I=>{I instanceof De||s(I.readableMessage)}}),[E]=Ve(),f=xe(e),{data:o}=He(i)??{},{openDrawer:m}=n,a=I=>{var O,T,y;I.stopPropagation(),!U(f)&&!U(i)&&!U(o)&&c(),m({appointment:e,contacts:f,property:i,owner:o,appointmentTime:`${A((O=e==null?void 0:e.localFields)==null?void 0:O.customStartDate).format("dddd,  MMMM D YYYY")}  ${H((T=e==null?void 0:e.localFields)==null?void 0:T.customStartDate)} - ${H((y=e==null?void 0:e.localFields)==null?void 0:y.customEndDate)}`,appointmentType:`${e.accompanied?"Accompanied":e.virtual?"Virtual":"Unaccompanied"} - ${x.capitalize(u)}`})},c=()=>{h(ie.INTERACTION_SECTION,{...ce("DIARY"),Name:"Appointment Card List",Action:ae.NAVIGATE("View Appointment"),"Event Type":"Click"})(),d.removeQueries({queryKey:v.PROPERTY.single(e==null?void 0:e.propertyId)}),l({pathname:e==null?void 0:e.id})},u=Fe(e.typeId,E),g=()=>{var O,T,y,F;const I=[];return i&&I.push({title:te((T=(O=o==null?void 0:o.related)==null?void 0:O[0])==null?void 0:T.name,"No Vendor or Landlord found"),data:Ce(i.address??{}),iconName:"usernameSystem","data-testid":"appointment-property-info-item"}),(F=(y=e.attendee)==null?void 0:y.contacts)!=null&&F.length&&I.push({title:te(e.attendee.contacts[0].name),data:x.capitalize(e.attendee.type),iconName:"usernameSystem","data-testid":"appointment-applicant-item"}),I};return w(Be,{heading:`${H(e.start)} - ${H(e.end)}`,subHeading:e.accompanied?"Accompanied":e.virtual?"Virtual":"Unaccompanied",onClick:a,badge:w(me,{children:w(pe,{children:u==null?void 0:u.toUpperCase()})}),listItems:g()})},Ke=({date:e,groupedAppointments:n,onAppointmentCardsGroupFocus:l,contactDetailsDrawerHandler:h,isSeamlessContainerAlreadyRender:d})=>{const{placeholderDateMetadata:s,setPlaceholderDateMetadata:i}=L(),E=le(e),f=E.format(R);return p.useEffect(()=>{A(E).isSame(s.date,"day")&&(s.shouldScroll||!d.current)&&(l(f),d.current=!0,i(o=>({...o,shouldScroll:!1})))},[s.date]),W("div",{id:`seamless-appointment-${f}`,className:"el-my12","data-testid":"appointment-card-group",children:[w(fe,{hasGreyText:!0,"data-testid":"appointment-group-header-date",children:E.format("dddd,  MMMM D YYYY")}),n!=null&&n.length?w("div",{"data-testid":"appointments-list-container",children:n==null?void 0:n.map(o=>w(Ue,{data:o,contactDetailsDrawerHandler:h},o.id))}):w(se,{"data-testid":"no-appointments-found",isFullWidth:!0,isExpanded:!0,isInline:!0,intent:"primary",children:"No Appointment Found"})]})},Qe=({headerContainerEl:e,navContainerEl:n,pageContainerEl:l,refetch:h})=>{const{isMobile:d}=$(),{currentDate:s}=L(),i=p.useCallback(o=>document.getElementById(`seamless-appointment-${o}`),[]),E=p.useCallback(async o=>{if(!e.current||!n.current||!l.current)return;const m=i(o);if(!m)return;const a=d?e.current.clientHeight+n.current.clientHeight:e.current.clientHeight;l.current.scrollTo({top:m.offsetTop-a,behavior:"auto"})},[d]),f=p.useCallback(x.debounce(async o=>{i(o)||await h()},200),[]);return p.useEffect(()=>{f(s.format(R))},[s]),{refetchOnAppointmentGroupNotExist:f,onAppointmentCardsGroupFocus:E}},We=({setCurrentDate:e})=>n=>{const l=n.filter(s=>s.isIntersecting);if(!l.length)return;const d=l.reduce((s,i)=>i.intersectionRatio>=s.intersectionRatio?i:s).target.id;e(le(d.replace(/seamless-appointment-/i,"")))},qe=({data:e,isLoadingOnInit:n,seamlessContainerRef:l,pageContainerRef:h,headerContainerRef:d,navContainerRef:s})=>{const{setCurrentDate:i}=L(),{isMobile:E}=$(),{navState:{navMenuOpen:f}}=Ee(),o=p.useRef(null),m=p.useRef(null),a=p.useCallback(()=>{var O;if(!e||!d.current||!s.current||n)return;const u=d.current.clientHeight+s.current.clientHeight-window.innerHeight,g=`-${d.current.clientHeight}px 0px ${u+5}px 0px`;(!o.current||m.current!==g)&&(o.current=new IntersectionObserver(We({setCurrentDate:i}),{root:h.current,rootMargin:g}),m.current=g),(((O=l.current)==null?void 0:O.childNodes)??[]).forEach(T=>{o.current.observe(T)})},[e,E,n,f]),c=p.useCallback(x.debounce(a,200),[a]);return p.useEffect(()=>{c()},[c]),p.useEffect(()=>(window.addEventListener("resize",c),()=>{var u;window.removeEventListener("resize",c),(u=o.current)==null||u.disconnect()}),[c]),{observingAppointmentsGroupByDate:a}},$e=({pageContainerRef:e,isRefetching:n,isScrollUpOrDownLoading:l,onScrollDown:h,onScrollUp:d})=>{const{currentDate:s}=L(),[i,E]=p.useState(!1),[f,o]=p.useState(!1),m=p.useCallback(x.debounce(()=>{if(!e.current||n)return;const c=e.current.scrollTop,u=e.current.scrollHeight,g=e.current.clientHeight;E(c===0),o(c+g>=u-20)},500),[n]);p.useEffect(()=>{var c;return(c=e.current)==null||c.addEventListener("scroll",m),()=>{var u;(u=e.current)==null||u.removeEventListener("scroll",m)}},[]);const a=p.useCallback(x.debounce(async c=>{const{isOnTop:u,isOnBottom:g,currentDate:I,isRefetching:O,isScrollUpOrDownLoading:T}=c;if(u&&!O&&!T){await h(I.startOf("week").format(R),e.current),E(y=>!y);return}if(g&&!O&&!T){await d(I.endOf("week").format(R),e.current),o(y=>!y);return}},600),[]);return p.useEffect(()=>{a({isOnTop:i,isOnBottom:f,currentDate:s,isRefetching:n,isScrollUpOrDownLoading:l})},[i,f,s,n,l]),{isOnTop:i,isOnBottom:f,onPageContainerScroll:m,handleContainerScrollEvent:a}},ze=(e,n)=>{const{params:l}=ge(),h=l.view==="schedule",{scheduleViewScrollPosition:d,setScheduleViewScrollPosition:s}=be(),i=p.useCallback(x.debounce(()=>{!(e!=null&&e.current)||!h||n||!e.current.scrollTop||s(e.current.scrollTop)},300),[h,n,e==null?void 0:e.current]);return p.useEffect(()=>{var E,f;return d&&!n&&((E=e==null?void 0:e.current)==null||E.scrollTo({top:d,behavior:"auto"})),(f=e==null?void 0:e.current)==null||f.addEventListener("scroll",i),()=>{var o;(o=e==null?void 0:e.current)==null||o.removeEventListener("scroll",i)}},[h]),{scrollPosition:d,setScrollPosition:s}},yt=()=>{const{currentDate:e}=L(),{isMobile:n,isTablet:l}=$(),{trackEvent:h}=oe(),d=z(),s=ne(),i=p.useRef(document.getElementById("page-container")),E=p.useRef(document.getElementById("header-container")),f=p.useRef(document.getElementById("nav-container")),o=p.useRef(null),m=p.useRef(!1);p.useEffect(()=>{i.current=document.getElementById("page-container"),E.current=document.getElementById("header-container"),f.current=document.getElementById("nav-container")},[]);const{data:a,isScrollUpOrDownLoading:c,isRefetching:u,refetch:g,onScrollUp:I,onScrollDown:O,isError:T,error:y}=Ye(e.toISOString());ze(i,c||u);const{onAppointmentCardsGroupFocus:F}=Qe({headerContainerEl:E,pageContainerEl:i,navContainerEl:f,refetch:g});qe({data:a,isLoadingOnInit:u||!a,pageContainerRef:i,headerContainerRef:E,navContainerRef:f,seamlessContainerRef:o});const{isOnTop:C,isOnBottom:k}=$e({pageContainerRef:i,isRefetching:u,isScrollUpOrDownLoading:c,onScrollDown:O,onScrollUp:I}),[t,r]=p.useState(null),[D,S,b]=he(),N=_=>{r(_),S()},P=()=>{r(null),b()},M=()=>{var _;h(ie.INTERACTION_SECTION,{...ce("DIARY"),Name:"Edit Appointment Button",Action:ae.NAVIGATE("View Appointment"),"Event Type":"Click"})(),d.removeQueries({queryKey:v.PROPERTY.single((_=t==null?void 0:t.property)==null?void 0:_.id)}),s({pathname:t==null?void 0:t.appointment.id})};return w("div",{ref:o,id:"seamless-container","data-testid":"seamless-container",className:"el-px7 el-my4",children:T?w(se,{"data-testid":"seamless-error-notification",isExpanded:!0,isInline:!0,isFullWidth:n||l,intent:"danger",children:y instanceof Ne?y.readableMessage:"Failed to load appointments"}):u||!a?w(Y,{fullPage:!0,label:"Loading","data-testid":"seamless-loader"}):W(ue,{children:[C&&c&&w(Y,{"data-testid":"seamless-scroll-down-loader"}),a.map(([_,B=[]])=>w(Ke,{date:_,groupedAppointments:B,onAppointmentCardsGroupFocus:F,contactDetailsDrawerHandler:{openDrawer:N,closeDrawer:P},isSeamlessContainerAlreadyRender:m},_)),k&&c&&w(Y,{"data-testid":"seamless-scroll-up-loader"}),((t==null?void 0:t.property)||(t==null?void 0:t.contacts))&&w(D,{"data-testid":"schedule-view-drawer-contact-details",title:t.appointmentTime,subtitle:t.appointmentType,footerItems:W(Se,{alignment:"right",children:[w(X,{intent:"default",onClick:b,children:"Close"}),w(X,{intent:"primary",onClick:M,children:"Edit Appointment"})]}),children:w(_e,{contactDetailsContent:t})})]})})};export{yt as default};
