import{j as a,a as g,F as ae}from"./index-b3f50da9.js";import{i as Z,D as U,b5 as v,j as te,Z as ge,r as R,aQ as pe,b6 as ue,k as ie,V as x,n as B,o as se,v as oe,z as H,y as z,x as ne,b7 as re,aN as he,aO as Ie,f as ye,h as be,O as Pe,C as fe,b8 as Se,aD as Ee}from"./elements-7fcf5525.js";import{a as Me,b as F,q as J,aa as ee,m as W,A as Re,e as we}from"./app-1088c2df.js";import{Q as I,U as Q}from"./url-ce1d32f5.js";import{c as de,a as q,o as le}from"./index.esm-c689e26d.js";import{u as me}from"./index.esm-70abc844.js";import{g as N}from"./options-f2badf58.js";import{L as K}from"./lazy-loaded-image-567ccffc.js";import{M as Ce}from"./modal-dialog-0e8fb4f7.js";import{E as h}from"./error-messages-a063dfd8.js";const _e=e=>Me({queryKey:I.PROPERTY_IMAGES.paginated(e==null?void 0:e.queryParams),...e,path:Q.PROPERTY_IMAGES}),Te=e=>F({...e,method:"POST",path:Q.PROPERTY_IMAGES}),De=e=>F({...e,method:"PATCH",path:Q.PROPERTY_IMAGES}),ke=e=>F({...e,method:"DELETE",path:Q.PROPERTY_IMAGES}),Ge=e=>F({...e,method:"POST",path:`${Q.PROPERTY_IMAGES}/signedUrl`}),Oe=e=>{const s=e.replace(/^data.+base64,/,"").length;return 4*Math.ceil(s/3)*.5624896334383812/1e3**2},X=e=>{const s=e.match(/^data:image\/(jpeg|jpg|png);base64/);return s==null?!1:{size:Oe(e),type:s[1]}},Ae=e=>Re.put(e.signedUrl,e.data,{headers:{"Content-Type":`image/${e.type}`}}),Le=e=>{const s=J(),[d,,,{isLoading:b}]=Te({successMessage:"Image uploaded",shouldReturnRecord:!0,onSuccess:c=>{s.setQueryData(I.PROPERTY_IMAGES.paginated({propertyId:e,pageSize:100}),o=>({...o,_embedded:[...(o==null?void 0:o._embedded)??[],c]})),s.setQueryData(I.PROPERTY.single(e),o=>{var u;return{...o,_embedded:{...(o==null?void 0:o._embedded)??{},images:[...((u=o==null?void 0:o._embedded)==null?void 0:u.images)??[],c]}}})}}),[t,,,{isLoading:m}]=Ge({shouldReturnRecord:!0});return{uploadImage:async c=>{const o=c.data,u=X(o);if(!u)throw new ee({description:"Invalid base64 file",readableMessage:"Invalid file inputed",errors:[]});const{size:P,type:p}=u;if(P>30)throw new ee({description:"the maximum file size is 30mb",readableMessage:"Image size is too large, please upload maximum 30mb image",errors:[]});if(P<6)return d({...c,propertyId:e});const y=await t({amount:1}),C=await fetch(o).then(S=>S.blob());await Ae({signedUrl:y.urls[0],data:C,type:p});const f=W.omit(c,"data");return d({...f,fileUrl:y.urls[0],propertyId:e})},isLoading:b||m}};const _={image:"ilrn0d2",gridContainer:"gk9ej6w",modalImageScrollable:"m2obhb9",modalImageeFitScreen:"mpeo4s0",modalImageContainer:"muc7mdo",scrollableImageContainer:"s195xnry",previewImage:"p1nwrbcf",previewImageModal:"pbgxmxy",topLayerPreviewImageModal:"tqqcs8r",previewImageModalBackDrop:"pe2eqa6",previewImageModalBackDropOpen:"pu5th2g",previewImageCaption:"p1eaw9no"},ce=({imgSrc:e,caption:s,Link:d,closeModalFn:b,isOnTopLayer:t=!1,customRootId:m="image-preview"})=>{const{Modal:w}=Z(m),c=!!e;return a("div",{id:m,className:U(_.previewImageModalBackDrop,!!c&&_.previewImageModalBackDropOpen,t&&_.topLayerPreviewImageModal),children:g(w,{className:_.previewImageModal,onModalClose:b,isOpen:!!e,children:[a(K,{"data-testid":"previewed-image",className:U(_.previewImage),src:e,fallbackComponent:a(v,{"data-testid":"previewed-image-fallback",placeholder:"placeholderSmall",size:250,fillAvailable:!0})}),a(te,{className:_.previewImageCaption,children:s}),!!d&&a(d,{})]})})},Ue=de().shape({caption:q().required(h.REQUIRED("Caption")).max(20,h.MAXIMUM_CHARACTER_LENGTH(20)),type:q().required(h.REQUIRED("Type")),data:q().required(h.REQUIRED("Images")).test({name:"image-type-validation",message:h.INVALID_IMAGE,test:e=>!!X(e)}).test({name:"image-size-validation",message:h.MAXIMUM_FILE_SIZE_EXCEEDED,test:e=>{const s=X(e);if(s)return s.size<=6}})}),xe=de().shape({caption:q().required(h.REQUIRED("Caption")).max(20,h.MAXIMUM_CHARACTER_LENGTH(20)),type:q().required(h.REQUIRED("Type"))});const V={link:"lpcnpxz",image:"i7g24ta",gridContainer:"gse96l1",modalImageScrollable:"m1d7a2ef",modalImageeFitScreen:"m1bfwrcv",modalImageContainer:"mvrh9d3",scrollableImageContainer:"s16ourov",previewImage:"pli1m4",previewImageModal:"pxqqvyq",previewImageModalBackDrop:"pwx7v5o",previewImageModalBackDropOpen:"pnemab3",previewImageCaption:"p15pkhj6"},ze=({propertyImagesData:e,propertyId:s})=>{var k,G,O;const d=J(),b=ge(),[t,m]=R.useState(),[w,c]=R.useState(!1),[o,,,{isLoading:u}]=ke({successMessage:"Image deleted",useIdPath:!0}),[P,,,{isLoading:p}]=De({successMessage:"Image updated",shouldReturnRecord:!0,useIdPath:!0}),y=Z("root"),{register:C,reset:f,handleSubmit:S,formState:E}=me({defaultValues:e,resolver:le(xe),mode:"onChange"}),Y=()=>{m(void 0)},M=()=>{c(!1)},j=i=>{i.preventDefault(),c(!0)},T=async()=>{await o({id:t==null?void 0:t.id,eTag:t==null?void 0:t._eTag}),d.setQueryData(I.PROPERTY_IMAGES.paginated({propertyId:s,pageSize:100}),i=>{var n;return{...i,_embedded:(n=i==null?void 0:i._embedded)==null?void 0:n.filter(r=>r.id!==(t==null?void 0:t.id))}}),d.setQueriesData(I.PROPERTY.single(s),i=>{var n;return{...i,_embedded:{...(i==null?void 0:i._embedded)??{},images:(n=i==null?void 0:i._embedded)==null?void 0:n.images.filter(r=>r.id!==(t==null?void 0:t.id))}}}),M(),Y()},$=R.useCallback(async i=>{if(!E.isDirty){b.error("Oops, you didn't make any changes");return}const n=W.pick(i,"caption","type"),r=await P({...n,id:t.id,eTag:t==null?void 0:t._eTag});d.setQueryData(I.PROPERTY_IMAGES.paginated({propertyId:s,pageSize:100}),l=>{var A;return{...l,_embedded:(A=l==null?void 0:l._embedded)==null?void 0:A.map(L=>L.id===(t==null?void 0:t.id)?r:L)}}),d.setQueriesData(I.PROPERTY.single(s),l=>{var A;return{...l,_embedded:{...(l==null?void 0:l._embedded)??{},images:(A=l==null?void 0:l._embedded)==null?void 0:A.images.map(L=>L.id===(t==null?void 0:t.id)?r:L)}}}),m(l=>({...l,...r})),M()},[E.isDirty]);R.useEffect(()=>{f(t),t||M()},[t]);const D=p||u;return g(ae,{children:[a(Ce,{ModalInstance:y,title:"Delete Image",message:"Do you want to delete this image?",ctaIntent:"danger",ctaMessage:"Yes",isCtaLoading:D,ctaConfirmFn:T}),a(ce,{caption:`${t?`${N[t.type]}: ${t.caption}`:""}`,Link:()=>a(te,{hasBoldText:!0,onClick:j,intent:"neutral",children:"Edit image"}),closeModalFn:()=>{m(void 0)},imgSrc:t==null?void 0:t.url}),g(pe,{isOpen:w,onModalClose:Y,title:"Edit Image",children:[a("div",{className:U(V.modalImageContainer),children:a(K,{"data-testid":"property-image-edit",className:U(V.modalImageeFitScreen,ue),src:t==null?void 0:t.url,onClick:M,fallbackComponent:a(v,{"data-testid":"property-image-edit-loading-fallback",placeholder:"placeholderSmall",size:250,fillAvailable:!0})})}),g(ie,{children:[a(x,{children:g(B,{children:[a(se,{children:"Type"}),a(oe,{"data-testid":"image-type",...C("type"),children:Object.entries(N).map(([i,n])=>a("option",{value:i,children:n},i))}),a(H,{message:((k=E.errors.type)==null?void 0:k.message)??""})]})}),a(x,{children:a(B,{label:"Caption",...C("caption"),placeholder:"Image title .etc",errorMessage:(G=E.errors.caption)==null?void 0:G.message})}),a(z,{type:"button",disabled:D,loading:y.modalIsOpen,intent:"danger",onClick:y.openModal,children:"Delete Image"})]}),g(ne,{alignment:"center",className:re,children:[a(z,{type:"button",intent:"default",onClick:M,children:"Cancel"}),a(z,{type:"button",disabled:D,loading:p,intent:"primary",onClick:S($),children:"Save"})]})]}),a(he,{className:U(V.gridContainer),colGapMobile:1,colGapTablet:2,colGapDesktop:3,colGapWideScreen:4,colGapSuperWideScreen:6,colGap4KScreen:8,rowGapMobile:1,rowGapTablet:2,rowGapDesktop:3,rowGapWideScreen:4,rowGapSuperWideScreen:6,rowGap4KScreen:8,children:(O=W.orderBy(e,["order"]))==null?void 0:O.map(i=>a(Ie,{spanMobile:2,spanTablet:2,spanDesktop:2,spanWideScreen:2,spanSuperWideScreen:2,span4KScreen:2,children:a(K,{"data-testid":"property-image-item",className:V.image,src:i.url,onClick:()=>{m(i)},fallbackComponent:a(v,{"data-testid":"property-image-item-loading-fallback",placeholder:"placeholderSmall",size:250,fillAvailable:!0})})},i.id))})]})},qe=()=>{var k,G,O,i;const{propertyId:e}=we(),s=J(),{register:d,reset:b,handleSubmit:t,formState:m,getValues:w,setValue:c}=me({resolver:le(Ue),mode:"onChange",defaultValues:{type:Object.keys(N)[0]}}),[o,u]=R.useState(!1),P={propertyId:[e],pageSize:100},[p,,{isLoading:y}]=_e({queryParams:P,fetchWhenTrue:[e,o]});R.useEffect(()=>{var n;if(e){const r=s.getQueryData(I.PROPERTY.single(e));(n=r==null?void 0:r._embedded)!=null&&n.images?s.setQueryData(I.PROPERTY_IMAGES.paginated(P),{_embedded:r._embedded.images}):u(!0)}},[e]);const{uploadImage:C,isLoading:f}=Le(e),[S,E]=R.useState(),{Modal:Y,openModal:M,closeModal:j}=Z("root"),T=()=>{j(),b()},$=async n=>{await C(n),T()},D=!((k=p==null?void 0:p._embedded)!=null&&k.length);return g(ye,{children:[y?a(be,{fullPage:!0}):(p==null?void 0:p._embedded)&&g(ae,{children:[a(Pe,{"data-testid":"title-property-images",children:"Property Images"}),a(fe,{"data-testid":"subtitle-property-images",hasGreyText:!0,children:D?"No images found.":"Click the image to view or update."}),a(ze,{propertyId:e,propertyImagesData:p._embedded})]}),a(Y,{title:"Add Image",onModalClose:T,children:g("form",{onSubmit:t($),children:[g(ie,{children:[g(x,{children:[a(Se,{"data-testid":"image-uploader",...d("data"),onFileView:()=>{E(w())}}),a(H,{message:((G=m.errors.data)==null?void 0:G.message)??""})]}),a(x,{children:g(B,{children:[a(se,{children:"Type"}),a(oe,{"data-testid":"image-type",...d("type",{onChange:n=>{const r=n.target.value;(r==="floorPlan"||r==="map")&&c("caption",N[r])}}),children:Object.entries(N).map(([n,r])=>a("option",{value:n,children:r},n))}),a(H,{message:((O=m.errors.type)==null?void 0:O.message)??""})]})}),a(x,{children:a(B,{label:"Caption",type:"text","data-testid":"caption",placeholder:"Image title .etc",...d("caption"),errorMessage:(i=m.errors.caption)==null?void 0:i.message})})]}),g(ne,{alignment:"center",className:re,children:[a(z,{disabled:f,intent:"default",type:"button",onClick:T,children:"Cancel"}),a(z,{loading:f,disabled:f,intent:"primary",type:"submit",children:"Submit"})]})]})}),a(ce,{customRootId:"image-preview-add",isOnTopLayer:!0,caption:"",closeModalFn:()=>{E(void 0)},imgSrc:S==null?void 0:S.data}),a(Ee,{"data-testid":"fab-add-image",isVisible:!0,buttonIcon:"addSystem",onClick:M})]})},We=qe;export{We as default};
